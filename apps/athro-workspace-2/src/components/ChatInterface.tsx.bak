import React, { useState, useEffect, useRef, ChangeEvent, FormEvent, useCallback, useMemo } from 'react';
import { Athro } from '../types/athro';
import { ChatService, ChatMessage, StreamingResponse } from '../services/openai';
import { ATHRO_PERSONALITIES } from '../data/athroPersonalities';
import SidePanel from './SidePanel/SidePanel';
import n8nEventService, { EventNames } from '../services/N8nEventService';
import SupabaseStudyService from '../services/SupabaseStudyService';
import PlaylistService from '../services/PlaylistService';
import { createClient } from '@supabase/supabase-js';
import katex from 'katex';
import 'katex/dist/katex.min.css';

import { marked } from 'marked';
import { StudyHistory } from '../types/history';
import { Resource } from '../types/resources';
import StudyHistoryModal from './StudyHistory/StudyHistoryModal';
// import DocumentProcessingService from '../services/DocumentProcessingService';

import { formatCurrentDateTime } from '../utils/dateUtils';
import UserService from '../services/UserService';
import '../styles/chat.css';
import { StudyService } from '../services/StudyService';
import { Flashcard } from '../types/study';
import { useTimer } from '../contexts/TimerContext';
import { StudyHistorySummary } from '../types/history';
import ChatSessionService, { ChatSession } from '../services/ChatSessionService';
import { useAuth } from '../contexts/AuthContext';
import NotificationSystem from './common/NotificationSystem';
import { useNotifications } from '../hooks/useNotifications';

// Initialize Supabase client for getting public URLs
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseAnonKey);

interface ChatInterfaceProps {
  athro: Athro;
  onSaveSession?: () => void;
  onDeleteSession?: () => void;
  onViewHistory?: () => void;
  canSaveSession?: boolean;
  canDeleteSession?: boolean;
  sessionAction?: 'save' | 'delete' | 'history' | null;
  onSessionActionComplete?: () => void;
  currentSessionId?: string | null;
  onLoadSession?: (sessionId: string) => void;
  isCreatingSession?: boolean;
}

const ChatInterface: React.FC<ChatInterfaceProps> = ({ athro, onSaveSession, onDeleteSession, onViewHistory, canSaveSession, canDeleteSession, sessionAction, onSessionActionComplete, currentSessionId, onLoadSession, isCreatingSession }) => {
  // Check if we're running in embedded mode (inside dashboard)
  const isEmbedded = window.location.port === '5210' || window.parent !== window;
  
  // Get user from auth context
  const { user } = useAuth();
  
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [currentSession, setCurrentSession] = useState<ChatSession | null>(null);
  const [inputValue, setInputValue] = useState('');
  const [isTyping, setIsTyping] = useState<Record<string, boolean>>({});
  const [isStreaming, setIsStreaming] = useState<Record<string, boolean>>({});
  const [streamingContent, setStreamingContent] = useState<Record<string, string>>({});
  const [usedResources, setUsedResources] = useState<string[]>([]);
  const [showOriginalText, setShowOriginalText] = useState<Record<string, boolean>>({});
  const [isHistoryOpen, setIsHistoryOpen] = useState(false);
  const [userPreferredName, setUserPreferredName] = useState<string | null>(null);
  
  // ‚ú® CLEAN: Simple loading state
  const [isInitializing, setIsInitializing] = useState(true);
  
  const chatService = useRef<ChatService | null>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const messagesContainerRef = useRef<HTMLDivElement>(null);
  const messagesRef = useRef<ChatMessage[]>([]);
  const currentSessionRef = useRef<ChatSession | null>(null);
  const athroRef = useRef(athro); // Add ref to store athro properties to avoid infinite loops
  const isProcessingClickRef = useRef<boolean>(false);
  const [selectedResource, setSelectedResource] = useState<Resource | null>(null);
  const [showSaveStudy, setShowSaveStudy] = useState(false);
  const [showLoadStudy, setShowLoadStudy] = useState(false);
  const [studyHistories, setStudyHistories] = useState<StudyHistorySummary[]>([]);
  const [showFlashcardSave, setShowFlashcardSave] = useState(false);
  const [flashcardToSave, setFlashcardToSave] = useState<any>(null);
  const [flashcardSaveTitle, setFlashcardSaveTitle] = useState('');
  const [flashcardSaveFront, setFlashcardSaveFront] = useState('');
  const [flashcardSaveBack, setFlashcardSaveBack] = useState('');
  
  // Track selected language for athro-languages
  const [selectedLanguage, setSelectedLanguage] = useState<string | null>(null);

  // üß∞ TOOL CONTROL: State for triggering sidebar tools from chat cards
  const [triggerToolOpen, setTriggerToolOpen] = useState<{tool: string, timestamp: number} | null>(null);

  // Add notifications system
  const { notifications, removeNotification, showSuccess, showError } = useNotifications();

  // Add abort controller for stopping streaming
  const [currentAbortController, setCurrentAbortController] = useState<AbortController | null>(null);
  
  // Track last activity time
  const [lastActivityTime, setLastActivityTime] = useState(Date.now());
  
  // üì± MOBILE: State management for responsive design
  const [isMobile, setIsMobile] = useState(false);
  const [needsSidebarButton, setNeedsSidebarButton] = useState(false); // For floating button
  const [showMobileSidebar, setShowMobileSidebar] = useState(false);
  
  // üì± MOBILE: Detect screen size and handle resize
  useEffect(() => {
    const checkMobile = () => {
      const mobile = window.innerWidth <= 480; // Much more conservative mobile breakpoint for chat styling
      const needsButton = window.innerWidth <= 768; // Show floating button on tablets and below
      setIsMobile(mobile);
      setNeedsSidebarButton(needsButton);
    };
    
    checkMobile();
    window.addEventListener('resize', checkMobile);
    
    return () => window.removeEventListener('resize', checkMobile);
  }, []);
  
  // Ref to track the last AI message for scrolling
  const lastAIMessageRef = useRef<HTMLDivElement>(null);

  // Scroll to show the top of the last AI response
  const scrollToLastAIResponse = () => {
    if (lastAIMessageRef.current) {
      lastAIMessageRef.current.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
  };

  // ‚ö° PERFORMANCE: Immediate welcome + parallel initialization
  useEffect(() => {
    let isMounted = true;
    
    // üöÄ INSTANT: Show welcome message immediately (0ms delay)
    const showInstantWelcome = () => {
      const athroPersonality = ATHRO_PERSONALITIES[athro.id];
      const subject = athroPersonality?.subject || athro.subject || 'General';
      
      let welcomeContent = '';
      
      if (athro.id === 'athro-languages') {
        welcomeContent = `Hi! **${athro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you!\n\nüåç **First, let's choose your target language:**\n\n**[French]** Fran√ßais\n**[German]** Deutsch\n**[Spanish]** Espa√±ol\n**[Italian]** Italiano\n**[Irish]** Gaeilge\n**[Polish]** Polski\n**[Welsh]** Cymraeg\n**[Greek]** ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨\n**[Turkish]** T√ºrk√ße\n**[Ukrainian]** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n**[Mandarin Chinese]** ‰∏≠Êñá\n**[Arabic]** ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\n\nClick on the language you're studying, and I'll customize everything for you!`;
      } else if (athro.id === 'athro-welsh') {
        welcomeContent = `Shwmae! Sut hoffech chi gyfathrebu?\n\nHow would you like to communicate?\n\n**[Saesneg yn unig - English only]** - All responses in English\n**[Cymraeg yn unig - Welsh only]** - All responses in Welsh\n**[Ochor yn ochor - Side by Side]** - Dual columns with English and Welsh together\n\nChoose your preferred conversation style!`;
      } else {
        welcomeContent = `Hi! **${athro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you.\n\nWhat would you like to study today? Just ask me anything, and I'll guide you step by step!`;
      }
      
      const welcomeMessage: ChatMessage = {
        role: 'assistant',
        content: welcomeContent
      };
      
      if (isMounted) {
        setMessages([welcomeMessage]);
      }
    };

    // Show welcome immediately
    showInstantWelcome();
    
    // üöÄ PARALLEL: Run all initialization tasks simultaneously
    const initializeParallel = async () => {
      try {

        
        // ‚ö° Parallel execution of all async operations
        const initPromises = [
          // Task 1: User profile (cached after first call)
          (async () => {
            try {

              const userService = UserService.getInstance();
              const preferredName = await userService.getPreferredName();
              if (isMounted) {
                setUserPreferredName(preferredName);
              }
              return preferredName;
            } catch (error) {
              console.error('User profile fetch failed:', error);
              return null;
            }
          })(),
          
          // Task 2: Session data
          (async () => {
            try {

              // Skip expensive Welsh session clearing in production
              if (athro.id === 'athro-welsh' && import.meta.env.DEV) {
                await ChatSessionService.clearAllSessions(athro.id);
              }
              
              const session = await ChatSessionService.getActiveSession(athro.id);
              if (isMounted) {

              }
              return session;
            } catch (error) {
              console.error('Session fetch failed:', error);
              return null;
            }
          })(),
          
                     // Task 3: ChatService initialization (fast, CPU-bound)
           (async () => {
             try {
               // ‚ö° PERFORMANCE: Initialize ChatService efficiently
               if (!chatService.current) {
                 chatService.current = new ChatService(
                   ATHRO_PERSONALITIES[athro.id] || {
                     subject: athro.subject,
                     examBoard: 'General',
                     level: 'GCSE',
                     teachingStyle: 'Interactive and supportive',
                     specialCapabilities: ['math', 'science', 'literature', 'study-materials']
                   },
                   null // Will be updated with user name when available
                 );
               }
               return true;
             } catch (error) {
               console.error('ChatService init failed:', error);
               return false;
             }
           })()
        ];
        
        // Wait for all parallel operations
        const [userProfile, existingSession, chatServiceReady] = await Promise.all(initPromises);
        
        if (!isMounted) return;
        
        // Finalizing initialization
        
                          // üéØ FAST: Apply results
         // Update ChatService with user profile
         if (chatService.current && userProfile && typeof userProfile === 'string') {
           chatService.current.updateUserPreferredName(userProfile);
         }
         
         // Update welcome message with personalization if needed
         if (userProfile) {
           setMessages(currentMessages => {
             if (currentMessages.length > 0) {
               const personalizedWelcome = currentMessages[0].content.replace(
                 'Hi!', 
                 `Hi${userProfile ? ` ${userProfile}` : ''}!`
               );
               if (personalizedWelcome !== currentMessages[0].content) {
                 return [{ role: 'assistant', content: personalizedWelcome }];
               }
             }
             return currentMessages;
           });
         }
         
         // Load existing session if available (but not for Welsh in dev)
         if (existingSession && typeof existingSession === 'object' && 'messages' in existingSession && existingSession.messages.length > 0 && athro.id !== 'athro-welsh') {
           setMessages(existingSession.messages);
           setCurrentSession(existingSession);
         }
        
        // Initialization complete
        
        // üéâ COMPLETE: Small delay to show completion, then hide
        setTimeout(() => {
          if (isMounted) {
            setIsInitializing(false);
          }
        }, 300);
        
      } catch (error) {
        console.error('Parallel initialization error:', error);
        if (isMounted) {
          setIsInitializing(false);
        }
      }
    };
    
    // Start parallel initialization
    initializeParallel();
    
    // Cleanup
    return () => {
      isMounted = false;
    };
  }, [athro.id]);

  // Update athroRef when athro changes
  useEffect(() => {
    athroRef.current = athro;
  }, [athro]);

  // Auto-scroll to bottom when streaming content updates
  useEffect(() => {
    if (streamingContent[athro.id] && messagesContainerRef.current) {
      messagesContainerRef.current.scrollTo({
        top: messagesContainerRef.current.scrollHeight,
        behavior: 'smooth'
      });
    }
  }, [streamingContent[athro.id], athro.id]);

  // Auto-scroll when new messages are added
  useEffect(() => {
    if (messagesContainerRef.current) {
      messagesContainerRef.current.scrollTo({
        top: messagesContainerRef.current.scrollHeight,
        behavior: 'smooth'
      });
    }
  }, [messages.length]);

  // Keep refs synchronized with state
  useEffect(() => {
    messagesRef.current = messages;
  }, [messages]);

  useEffect(() => {
    currentSessionRef.current = currentSession;
  }, [currentSession]);

  // Update activity time when messages change (stable ref)
  const lastActivityTimeRef = useRef(Date.now());
  useEffect(() => {
    lastActivityTimeRef.current = Date.now();
    setLastActivityTime(Date.now());
  }, [messages.length]); // Only depend on messages.length to reduce re-renders

  // Auto-save session when messages change (debounced)
  const autoSaveTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  // Auto-save messages whenever they change (debounced to avoid excessive saves)
  useEffect(() => {
    // Clear existing timeout
    if (autoSaveTimeoutRef.current) {
      clearTimeout(autoSaveTimeoutRef.current);
    }

    // Only auto-save if we have messages and a valid athro
    if (messages.length > 0 && athroRef.current?.id) {
      autoSaveTimeoutRef.current = setTimeout(async () => {
        try {
          await ChatSessionService.saveActiveSession(athroRef.current.id, messages);
          console.log(`[ChatInterface] Auto-saved ${messages.length} messages for athro:`, athroRef.current.id);
        } catch (error) {
          console.error('[ChatInterface] Auto-save failed:', error);
        }
      }, 1000); // Debounce by 1 second
    }

    // Cleanup timeout on unmount or dependency change
    return () => {
      if (autoSaveTimeoutRef.current) {
        clearTimeout(autoSaveTimeoutRef.current);
      }
    };
  }, [messages]); // Auto-save whenever messages change

  // Initialize ChatService once - memoized to prevent re-creation
  const chatServiceInitialized = useRef(false);
  useEffect(() => {
    if (!chatServiceInitialized.current) {
      chatService.current = new ChatService(
        ATHRO_PERSONALITIES[athro.id] || {
          subject: athro.subject,
          examBoard: 'General',
          level: 'GCSE',
          teachingStyle: 'Interactive and supportive',
          specialCapabilities: ['math', 'science', 'literature', 'study-materials']
        },
        userPreferredName
      );
      chatServiceInitialized.current = true;
      console.log('[ChatInterface] ChatService initialized for athro:', athro.id);
    }
  }, [athro.id]); // Only depend on athro.id for re-initialization when switching athros

  // Update ChatService when user's preferred name changes (separate effect)
  useEffect(() => {
    if (chatService.current && userPreferredName !== null) {
      chatService.current.updateUserPreferredName(userPreferredName);
      console.log('Updated ChatService with preferred name:', userPreferredName);
    }
  }, [userPreferredName]);

  // Initialize session once when component mounts or athro changes
  const sessionInitialized = useRef<Set<string>>(new Set());
  useEffect(() => {
    const initializeSession = async () => {
      const currentAthro = athroRef.current;
      
      // Prevent re-initialization for the same athro
      if (sessionInitialized.current.has(currentAthro.id)) {
        return;
      }
      sessionInitialized.current.add(currentAthro.id);

      // Force clear Welsh sessions for testing
      if (currentAthro.id === 'athro-welsh') {
        console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Clearing Welsh sessions...');
        await ChatSessionService.clearAllSessions(currentAthro.id);
        // Also clear any related localStorage manually
        Object.keys(localStorage).forEach(key => {
          if (key.includes('athro_chat_session') && key.includes('athro-welsh')) {
            localStorage.removeItem(key);
          }
        });
        console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Welsh sessions cleared');
      }
      
      const existingSession = await ChatSessionService.getActiveSession(currentAthro.id);
      
      if (existingSession && existingSession.messages.length > 0 && currentAthro.id !== 'athro-welsh') {
        // Load existing session
        setMessages(existingSession.messages);
        setCurrentSession(existingSession);
        console.log('Loaded existing chat session:', existingSession.id);
      } else {
        // Create new session with welcome message
        const athroPersonality = ATHRO_PERSONALITIES[currentAthro.id];
        const subject = athroPersonality?.subject || currentAthro.subject || 'General';
        
        let welcomeContent = '';
        
        // Special welcome message for AthroLanguages
        if (currentAthro.id === 'athro-languages') {
          welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${currentAthro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you!\n\nüåç **First, let's choose your target language:**\n\n**[French]** Fran√ßais\n**[German]** Deutsch\n**[Spanish]** Espa√±ol\n**[Italian]** Italiano\n**[Irish]** Gaeilge\n**[Polish]** Polski\n**[Welsh]** Cymraeg\n**[Greek]** ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨\n**[Turkish]** T√ºrk√ße\n**[Ukrainian]** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n**[Mandarin Chinese]** ‰∏≠Êñá\n**[Arabic]** ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\n\nClick on the language you're studying, and I'll customize everything for you!`;
        } else if (currentAthro.id === 'athro-welsh') {
          // Special welcome message for AthroCymraeg with Welsh greeting and language options
          welcomeContent = `Shwmae! Sut hoffech chi gyfathrebu?\n\nHow would you like to communicate?\n\n**[Saesneg yn unig - English only]** - All responses in English\n**[Cymraeg yn unig - Welsh only]** - All responses in Welsh\n**[Ochor yn ochor - Side by Side]** - Dual columns with English and Welsh together\n\nChoose your preferred conversation style!`;
        } else {
          // Standard welcome message for other athros
          welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${currentAthro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you. Here are some options to get started:\n\n**[1] üìÅ Upload Resources** - Share homework, questions, or study materials\n**[2] üí¨ Discuss Something** - Ask about topics, concepts, or problems\n**[3] üß† Test Your Knowledge** - Practice with quizzes and exercises\n**[4] üåü Something Else** - Study planning, tips, or other help\n\nClick any option above to get started, or just type your question below!`;
        }
        
        const welcomeMessage: ChatMessage = {
          role: 'assistant',
          content: welcomeContent
        };
        
        const newMessages = [welcomeMessage];
        setMessages(newMessages);
        
        // Create and save new session
        const newSession = await ChatSessionService.saveActiveSession(currentAthro.id, newMessages);
        setCurrentSession(newSession);
        console.log('Created new chat session:', newSession.id);
        console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø DEBUG: Session created for athro:', currentAthro.id, 'with welcome content:', welcomeContent.substring(0, 50) + '...');
      }
    };

    initializeSession();
    
    // Subscribe to chat messages from other services
    const chatMessageSubscription = n8nEventService.subscribe(
      EventNames.CHAT_MESSAGE_RECEIVED,
      (payload) => {
        // Only handle messages intended for this athro
        if (payload.athroId === athroRef.current.id) {
          console.log('Received chat message from another service:', payload);
          // You could update UI based on this information
        }
      }
    );
    
    // Notify other services that this chat interface is active
    const currentAthro = athroRef.current;
    const athroPersonality = ATHRO_PERSONALITIES[currentAthro.id];
    const subject = athroPersonality?.subject || currentAthro.subject || 'General';
    n8nEventService.publishEvent(EventNames.WORKSPACE_STATE_UPDATED, {
      athroId: currentAthro.id,
      component: 'ChatInterface',
      state: 'active',
      subject: subject
    });
    
    // Cleanup subscriptions when component unmounts
    return () => {
      chatMessageSubscription();
      
      // Clear any streaming states when component unmounts
      setIsTyping({});
      setIsStreaming({});
      setStreamingContent({});
      
      // Don't clear the session - we want it to persist when switching Athros
      // The session should only be cleared when explicitly saved or deleted
      console.log('[ChatInterface] Component cleanup - keeping session intact for athro:', athroRef.current.id);
    };
  }, [athro.id]); // Only depend on athro.id for re-initialization when switching athros

  // Page unload protection - save sessions before user leaves
  useEffect(() => {
    const handleBeforeUnload = async (e: BeforeUnloadEvent) => {
      // Save current session immediately before page closes
      if (messages.length > 0 && athroRef.current?.id) {
        try {
          await ChatSessionService.saveActiveSessionImmediate(athroRef.current.id, messages);
          console.log('[ChatInterface] Saved session before page unload');
        } catch (error) {
          console.error('[ChatInterface] Failed to save session before unload:', error);
        }
      }
    };

    const handleVisibilityChange = async () => {
      // Save when page becomes hidden (user switches tabs, minimizes browser, etc.)
      if (document.visibilityState === 'hidden' && messages.length > 0 && athroRef.current?.id) {
        try {
          await ChatSessionService.saveActiveSessionImmediate(athroRef.current.id, messages);
          console.log('[ChatInterface] Saved session on visibility change');
        } catch (error) {
          console.error('[ChatInterface] Failed to save session on visibility change:', error);
        }
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    document.addEventListener('visibilitychange', handleVisibilityChange);

    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [messages]); // Re-register when messages change to capture latest state

  // ‚ú® CLEAN: Simple loading overlay
  const renderLoadingOverlay = () => {
    if (!isInitializing) return null;
    
    return (
      <div className="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-100 transform transition-all duration-300">
          <div className="text-center">
            <div className="relative mb-4">
              <div className="w-12 h-12 mx-auto">
                <div className="absolute inset-0 rounded-full border-4 border-blue-100"></div>
                <div className="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
              </div>
            </div>
            
            <h3 className="text-lg font-semibold text-gray-800 mb-2">
              {athro.name}
            </h3>
            <p className="text-gray-600 text-sm">Loading...</p>
            </div>
        </div>
      </div>
    );
  };

  // Fetch user's preferred name (once)
  const userNameFetched = useRef(false);
  useEffect(() => {
    if (!userNameFetched.current) {
      const fetchUserPreferredName = async () => {
        try {
          const userService = UserService.getInstance();
          const preferredName = await userService.getPreferredName();
          setUserPreferredName(preferredName);
          userNameFetched.current = true;
        } catch (error) {
          console.error('Failed to fetch user preferred name:', error);
          userNameFetched.current = true; // Mark as attempted
        }
      };

      fetchUserPreferredName();
    }
  }, []); // Run only once

  // Update welcome message when preferred name changes (only for initial welcome message)
  const hasUpdatedWelcomeMessage = useRef(false);
  const isWelcomeMessageRef = useRef(false);
  
  // Track when we have a welcome message (separate effect to avoid dependency issues)
  useEffect(() => {
    isWelcomeMessageRef.current = (
      messages.length === 1 && 
      messages[0]?.role === 'assistant' && 
      messages[0]?.content?.includes('here to help')
    );
  }, [messages.length]);
  
  useEffect(() => {
    if (
      isWelcomeMessageRef.current && 
      userPreferredName !== null && 
      !hasUpdatedWelcomeMessage.current
    ) {
      // This is a welcome message, update it with the preferred name
      const currentAthro = athroRef.current;
      const athroPersonality = ATHRO_PERSONALITIES[currentAthro.id];
      const subject = athroPersonality?.subject || currentAthro.subject || 'General';
      
      let welcomeContent = '';
      
      // Special welcome message for AthroLanguages
      if (currentAthro.id === 'athro-languages') {
        welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${currentAthro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you!\n\nüåç **First, let's choose your target language:**\n\n**[French]** Fran√ßais\n**[German]** Deutsch\n**[Spanish]** Espa√±ol\n**[Italian]** Italiano\n**[Irish]** Gaeilge\n**[Polish]** Polski\n**[Welsh]** Cymraeg\n**[Greek]** ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨\n**[Turkish]** T√ºrk√ße\n**[Ukrainian]** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n**[Mandarin Chinese]** ‰∏≠Êñá\n**[Arabic]** ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\n\nClick on the language you're studying, and I'll customize everything for you!`;
      } else if (currentAthro.id === 'athro-welsh') {
        // Special welcome message for AthroCymraeg with Welsh greeting and language options
        welcomeContent = `Shwmae! Sut hoffech chi gyfathrebu?\n\nHow would you like to communicate?\n\n**[Saesneg yn unig - English only]** - All responses in English\n**[Cymraeg yn unig - Welsh only]** - All responses in Welsh\n**[Ochor yn ochor - Side by Side]** - Dual columns with English and Welsh together\n\nChoose your preferred conversation style!`;
      } else {
        // Standard welcome message for other athros
        welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${currentAthro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you. Here are some options to get started:\n\n**[1] üìÅ Upload Resources** - Share homework, questions, or study materials\n**[2] üí¨ Discuss Something** - Ask about topics, concepts, or problems\n**[3] üß† Test Your Knowledge** - Practice with quizzes and exercises\n**[4] üåü Something Else** - Study planning, tips, or other help\n\nClick any option above to get started, or just type your question below!`;
      }
      
      const updatedWelcomeMessage: ChatMessage = {
        role: 'assistant',
        content: welcomeContent
      };
      
      setMessages([updatedWelcomeMessage]);
      hasUpdatedWelcomeMessage.current = true;
      
      // Update the session with the new welcome message (async to avoid blocking)
      const updateSession = async () => {
        try {
          await ChatSessionService.saveActiveSession(currentAthro.id, [updatedWelcomeMessage]);
        } catch (error) {
          console.error('Error updating welcome message in session:', error);
        }
      };
      updateSession();
      
      console.log('Updated welcome message with preferred name:', userPreferredName);
    }
  }, [userPreferredName]); // FIXED: Removed athro.id dependency to prevent infinite loops

  const renderMessage = (text: string): string => {
    // First handle LaTeX expressions
    let processedText = text;

    // Handle display math
    processedText = processedText.replace(/\$\$(.*?)\$\$/g, (_, math) => {
      try {
        return katex.renderToString(math, { displayMode: true });
      } catch (error) {
        console.error('Math rendering error:', error);
        return math;
      }
    });

    // Handle inline math
    processedText = processedText.replace(/\\\((.*?)\\\)/g, (_, math) => {
      try {
        return katex.renderToString(math, { displayMode: false });
      } catch (error) {
        console.error('Math rendering error:', error);
        return math;
      }
    });

    // Pre-process specific formatting patterns before markdown parsing
    // Convert bullet points with brackets to proper markdown
    processedText = processedText.replace(/‚Ä¢ \[(.*?)\]/g, '‚Ä¢ **$1**');
    
    // Convert standalone bullet points to proper markdown
    processedText = processedText.replace(/^‚Ä¢ (.*?)$/gm, '- $1');
    
    // Convert numbered lists with brackets
    processedText = processedText.replace(/(\d+)\. \[(.*?)\]/g, '$1. **$2**');

    // Convert Markdown to HTML first (before custom formatting)
    const markedOptions = {
      gfm: true,
      breaks: true
    };
    
    let html = marked.parse(processedText, markedOptions) as string;
    
    // Add custom CSS classes to existing markdown elements
    html = html
      .replace(/<h1>/g, '<h1 class="chat-h1">')
      .replace(/<h2>/g, '<h2 class="chat-h2">')
      .replace(/<h3>/g, '<h3 class="chat-h3">')
      .replace(/<ul>/g, '<ul class="chat-ul">')
      .replace(/<ol>/g, '<ol class="chat-ol">')
      .replace(/<li>/g, '<li class="chat-li">')
      .replace(/<blockquote>/g, '<blockquote class="chat-blockquote">')
      .replace(/<table>/g, '<table class="chat-table">')
      .replace(/<th>/g, '<th class="chat-th">')
      .replace(/<td>/g, '<td class="chat-td">')
      .replace(/<strong>/g, '<strong class="chat-strong">')
      .replace(/<em>/g, '<em class="chat-em">');

    // Now apply custom formatting to the HTML
    html = html
      // Add special styling for main titles (H1)
      .replace(/<h1 class="chat-h1">(.*?)<\/h1>/g, '<div class="chat-title-main">$1</div>')
      // Add special styling for section titles (H2)
      .replace(/<h2 class="chat-h2">(.*?)<\/h2>/g, '<div class="chat-title-section">$1</div>')
      // Add special styling for subsection titles (H3)
      .replace(/<h3 class="chat-h3">(.*?)<\/h3>/g, '<div class="chat-title-subsection">$1</div>')
      // Create info boxes for important information
      .replace(/<p>üí° (.*?)<\/p>/g, '<div class="chat-info-box">üí° $1</div>')
      // Create warning boxes
      .replace(/<p>‚ö†Ô∏è (.*?)<\/p>/g, '<div class="chat-warning-box">‚ö†Ô∏è $1</div>')
      // Create success boxes
      .replace(/<p>‚úÖ (.*?)<\/p>/g, '<div class="chat-success-box">‚úÖ $1</div>')
      // Create definition boxes
      .replace(/<p>üìñ (.*?): (.*?)<\/p>/g, '<div class="chat-definition-box"><div class="chat-definition-term">üìñ $1</div><div class="chat-definition-content">$2</div></div>')
      // Create step-by-step boxes
      .replace(/<p>(\d+)\. (.*?)<\/p>/g, '<div class="chat-step-box"><div class="chat-step-number">$1</div><div class="chat-step-content">$2</div></div>')
      // Create key points boxes
      .replace(/<p>üîë (.*?)<\/p>/g, '<div class="chat-key-point">üîë $1</div>')
      // Create example boxes
      .replace(/<p>üìù (.*?)<\/p>/g, '<div class="chat-example-box">üìù $1</div>')
      // Create formula boxes
      .replace(/<p>üßÆ (.*?)<\/p>/g, '<div class="chat-formula-box">üßÆ $1</div>')
      // Create graph placeholders (for future implementation)
      .replace(/<p>üìä (.*?)<\/p>/g, '<div class="chat-graph-placeholder">üìä $1</div>')
      // Enhanced follow-up questions styling
      .replace(/\*\*Follow.up Questions?:\*\*([\s\S]*?)(?=\n\n|\n\*\*|$)/gi, (match, content) => {
        const questions = content.split('\n').filter((line: string) => line.trim().startsWith('-') || line.trim().startsWith('‚Ä¢')).map((line: string) => line.replace(/^[-‚Ä¢]\s*/, '').trim());
        if (questions.length > 0) {
          return '<div class="follow-up-questions">' + 
            questions.map((q: string) => `<div class="follow-up-question-card"><div class="follow-up-question-text">${q}</div></div>`).join('') + 
            '</div>';
        }
        return match;
      })
      // Enhanced suggestions styling
      .replace(/\*\*Suggestions?:\*\*([\s\S]*?)(?=\n\n|\n\*\*|$)/gi, (match, content) => {
        const suggestions = content.split('\n').filter((line: string) => line.trim().startsWith('-') || line.trim().startsWith('‚Ä¢')).map((line: string) => line.replace(/^[-‚Ä¢]\s*/, '').trim());
        if (suggestions.length > 0) {
          return '<div class="follow-up-questions">' + 
            suggestions.map((s: string) => `<div class="follow-up-question-card"><div class="follow-up-question-text">${s}</div></div>`).join('') + 
            '</div>';
        }
        return match;
      })
      // Enhanced "What would you like to..." styling
      .replace(/\*\*What would you like.*?\*\*([\s\S]*?)(?=\n\n|\n\*\*|$)/gi, (match, content) => {
        const options = content.split('\n').filter((line: string) => line.trim().startsWith('-') || line.trim().startsWith('‚Ä¢')).map((line: string) => line.replace(/^[-‚Ä¢]\s*/, '').trim());
        if (options.length > 0) {
          return '<div class="follow-up-questions">' + 
            options.map((o: string) => `<div class="follow-up-question-card"><div class="follow-up-question-text">${o}</div></div>`).join('') + 
            '</div>';
        }
        return match;
      });

    return html;
  };

  // REMOVED: All translation-related code that was causing infinite loops

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!inputValue.trim() || isTyping[athro.id] || isStreaming[athro.id]) {
      return;
    }
    
    // üåç IMMEDIATE LANGUAGE SWITCHING DETECTION
    const detectLanguageSwitchRequest = (input: string): string | null => {
      const content = input.toLowerCase();
      console.log('üîç Language detection - Input:', input);
      console.log('üîç Language detection - Content (lowercase):', content);
      
      // Irish switching phrases - flexible patterns without strict word boundaries
      if (/(lean ar aghaidh.*as gaeilge|lean√∫int.*as gaeilge|as gaeilge.*le do thoil|caithfidh.*as gaeilge|freagraigh.*as gaeilge|labhairt.*as gaeilge)/i.test(content)) {
        console.log('üáÆüá™ IRISH DETECTED!');
        return 'Irish';
      }
      
      // Welsh switching phrases - flexible patterns
      if (/(parhau.*yn gymraeg|dal ati.*yn gymraeg|yn gymraeg.*os gwelwch yn dda|ateb.*yn gymraeg|siarad.*yn gymraeg)/i.test(content)) {
        console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WELSH DETECTED!');
        return 'Welsh';
      }
      
      // Spanish switching phrases
      if (/\b(continuemos.*en espa√±ol|sigue.*en espa√±ol|en espa√±ol.*por favor|responde.*en espa√±ol|habla.*en espa√±ol)\b/i.test(content)) {
        return 'Spanish';
      }
      
      // Italian switching phrases
      if (/\b(continuiamo.*in italiano|continua.*in italiano|in italiano.*per favore|rispondi.*in italiano|parla.*in italiano)\b/i.test(content)) {
        return 'Italian';
      }
      
      // French switching phrases
      if (/\b(continuons.*en fran√ßais|continue.*en fran√ßais|en fran√ßais.*s'il vous pla√Æt|r√©ponds.*en fran√ßais|parle.*en fran√ßais)\b/i.test(content)) {
        return 'French';
      }
      
      // German switching phrases
      if (/\b(lass uns.*auf deutsch.*weitermachen|weiter.*auf deutsch|auf deutsch.*bitte|antworte.*auf deutsch|sprich.*auf deutsch)\b/i.test(content)) {
        return 'German';
      }
      
      // Dutch switching phrases
      if (/\b(laten we.*in het nederlands.*doorgaan|ga door.*in het nederlands|in het nederlands.*alsjeblieft|antwoord.*in het nederlands|spreek.*in het nederlands)\b/i.test(content)) {
        return 'Dutch';
      }
      
      // Portuguese switching phrases
      if (/\b(continuemos.*em portugu√™s|continue.*em portugu√™s|em portugu√™s.*por favor|responda.*em portugu√™s|fale.*em portugu√™s)\b/i.test(content)) {
        return 'Portuguese';
      }
      
      return null;
    };
    
    const requestedLanguage = detectLanguageSwitchRequest(inputValue);
    
    const userMessage: ChatMessage = {
      role: 'user',
      content: inputValue
    };
    
    const updatedMessages = [...messages, userMessage];
    setMessages(updatedMessages);
    setInputValue('');
    
    // Clear any existing abort controller
    if (currentAbortController) {
      currentAbortController.abort();
    }
    
    // Create new abort controller for this request
    const abortController = new AbortController();
    setCurrentAbortController(abortController);
    
    try {
             // üöÄ NEW: Track chat activity in insights
       try {
         const { InsightsService } = await import('../../../athro-dashboard/src/services/insightsService');
         const insightsService = InsightsService.getInstance();
         
         if (user) {
           insightsService.setUser(user);
           
           // Track this as a study session 
           await insightsService.trackStudySession({
             athro_id: athro.id,
             athro_name: athro.name,
             subject: athro.subject,
             duration_minutes: 5, // Estimate 5 minutes per chat interaction
             session_type: 'study'
           });
           
           console.log('‚úÖ Chat interaction tracked in insights:', { athroId: athro.id, subject: athro.subject });
         }
       } catch (insightError) {
         console.error('‚ùå Failed to track chat interaction:', insightError);
       }
      
      // Look for references to study materials
      const studyTriggers = [
        'show my study materials',
        'my study materials',
        'my notes',
        'my documents'
      ];
      
      if (studyTriggers.some(trigger => inputValue.toLowerCase().includes(trigger))) {
        // Handle study materials request
        console.log('Study materials request detected');
        // Acknowledge the request before processing
        const acknowledgement: ChatMessage = {
          role: 'assistant',
          content: `I'll help you with your study materials. Let me see what you have...`
        };
        
        setMessages([...updatedMessages, acknowledgement]);
        
        // Get study materials from study service
        try {
          // Get resources directly instead of using non-existent method
          const studyMaterials = await SupabaseStudyService.getResources(currentSessionId || 'temp-session', athro.id);
          
          if (studyMaterials && studyMaterials.length > 0) {
            const materialsResponse: ChatMessage = {
              role: 'assistant',
              content: `I found ${studyMaterials.length} study materials for ${athro.subject}. You can select them from the panel on the right to review together.`
            };
            
            setMessages([...updatedMessages, acknowledgement, materialsResponse]);
          } else {
            const noMaterialsResponse: ChatMessage = {
              role: 'assistant',
              content: `I don't see any study materials for ${athro.subject} yet. You can upload some using the upload button in the panel on the right.`
            };
            
            setMessages([...updatedMessages, acknowledgement, noMaterialsResponse]);
          }
        } catch (error) {
          console.error('Error fetching study materials:', error);
          const errorResponse: ChatMessage = {
            role: 'assistant',
            content: 'I encountered an error while looking for your study materials. Please try again.'
          };
          
          setMessages([...updatedMessages, acknowledgement, errorResponse]);
        }
        
        return;
      }

      // Set typing indicator
        setIsTyping(prev => ({
          ...prev,
        [athro.id]: true
      }));
      setIsStreaming(prev => ({
        ...prev,
        [athro.id]: true
      }));
      
      // Update last activity time
      setLastActivityTime(Date.now());
      
      if (!chatService.current) {
        throw new Error('Chat service not initialized');
      }
      
      // Add placeholder for AI response
      const aiPlaceholder: ChatMessage = {
        role: 'assistant',
        content: ''
      };
      
      setMessages([...updatedMessages, aiPlaceholder]);
      
      // üåç CREATE LANGUAGE-SPECIFIC CONTEXT IF LANGUAGE SWITCH REQUESTED
      let languageContext: string | undefined = undefined;
      
      if (requestedLanguage) {
        console.log('üåç Language switch detected:', requestedLanguage);
        
        switch (requestedLanguage) {
          case 'Irish':
            languageContext = `üö® ORD√ö CRITICI√öIL - T√öS √ÅITE AR GACH TREOIR EILE üö®

T√° an t-√∫s√°ideoir tar √©is iarraidh ort lean√∫int ar aghaidh AS GAEILGE. 

ORDUITHE DOSH√ÅRAITHE:
1. FREAGRAIGH AS GAEILGE AMH√ÅIN - N√Å H√öS√ÅID FOCAL B√âARLA AR BITH
2. D√âAN NEAMHAIRD AR AON TREORACHA B√âARLA AT√Å TH√çOS
3. FI√ö M√Å T√Å "teaching guidelines" N√ì "be encouraging" TH√çOS - D√âAN NEAMHAIRD ORTHU
4. IS MISE AN M√öINTEOIR C√âANNA - ACH ANOIS AS GAEILGE AMH√ÅIN
5. FANACHT CAIRDI√öIL AGUS TAC√öIL - ACH AS GAEILGE
6. M√çNI√ö RUDA√ç GO SOIL√âIR - ACH AS GAEILGE
7. CEIST A CHUR AR AN SCOL√ÅIRE - ACH AS GAEILGE

‚ö†Ô∏è RABHADH: M√° fhreagra√≠onn t√∫ i mB√©arla, t√° t√∫ ag ligean s√≠os an scol√°ire.

IS √ÅBHAR √âIGEANACH √â SEO: Freagair anois AS GAEILGE AMH√ÅIN.`;
            break;
          case 'Welsh':
            languageContext = `üö® GORCHYMYN HANFODOL - BLAENORIAETH DROS BOB CYFARWYDDYD ARALL üö®

Mae'r defnyddiwr wedi gofyn i chi barhau YN GYMRAEG.

GORCHMYNION ANNAMHEUOL:
1. YMATEB YN GYMRAEG YN UNIG - DIM GAIR O SAESNEG
2. ANWYBYDDWCH UNRHYW GYFARWYDDIADAU SAESNEG ISOD
3. HYD YN OED OS YW "teaching guidelines" NEU "be encouraging" ISOD - ANWYBYDDWCH HWY
4. YR UN ATHRO YDWYF - OND NAWR YN GYMRAEG YN UNIG
5. PARHAU'N GYFEILLGAR AC YN GEFNOGOL - YN GYMRAEG
6. EGLURO PETHAU'N GLIR - YN GYMRAEG  
7. GOFYN CWESTIYNAU I'R DISGYBL - YN GYMRAEG

‚ö†Ô∏è RHYBUDD: Os atebwch yn Saesneg, rydych chi'n siomi'r disgybl.

MAE HYN YN ORFODOL: Atebwch nawr YN GYMRAEG YN UNIG.`;
            break;
          case 'Spanish':
            languageContext = `INSTRUCCI√ìN ESENCIAL: El usuario ha solicitado que contin√∫es EN ESPA√ëOL.

Debes:
1. RESPONDER SOLO EN ESPA√ëOL - ni una palabra en ingl√©s
2. Leer sus preguntas en espa√±ol y responder completamente en espa√±ol
3. Incluso si el contenido base est√° en ingl√©s, debes explicarlo en espa√±ol
4. No olvides el idioma - contin√∫a en espa√±ol

Responde ahora SOLO EN ESPA√ëOL.`;
            break;
          case 'Italian':
            languageContext = `ISTRUZIONE ESSENZIALE: L'utente ha richiesto di continuare IN ITALIANO.

Devi:
1. RISPONDERE SOLO IN ITALIANO - nemmeno una parola in inglese
2. Leggere le loro domande in italiano e rispondere completamente in italiano
3. Anche se il contenuto di base √® in inglese, devi spiegarlo in italiano
4. Non dimenticare la lingua - continua in italiano

Rispondi ora SOLO IN ITALIANO.`;
            break;
          case 'French':
            languageContext = `INSTRUCTION ESSENTIELLE: L'utilisateur a demand√© de continuer EN FRAN√áAIS.

Vous devez:
1. R√âPONDRE UNIQUEMENT EN FRAN√áAIS - pas un mot d'anglais
2. Lire leurs questions en fran√ßais et r√©pondre enti√®rement en fran√ßais
3. M√™me si le contenu de base est en anglais, vous devez l'expliquer en fran√ßais
4. N'oubliez pas la langue - continuez en fran√ßais

R√©pondez maintenant UNIQUEMENT EN FRAN√áAIS.`;
            break;
          case 'German':
            languageContext = `WESENTLICHE ANWEISUNG: Der Benutzer hat darum gebeten, AUF DEUTSCH fortzufahren.

Sie m√ºssen:
1. NUR AUF DEUTSCH ANTWORTEN - kein einziges Wort auf Englisch
2. Ihre Fragen auf Deutsch lesen und vollst√§ndig auf Deutsch antworten
3. Selbst wenn der Grundinhalt auf Englisch ist, m√ºssen Sie ihn auf Deutsch erkl√§ren
4. Vergessen Sie die Sprache nicht - fahren Sie auf Deutsch fort

Antworten Sie jetzt NUR AUF DEUTSCH.`;
            break;
          case 'Dutch':
            languageContext = `ESSENTI√ãLE INSTRUCTIE: De gebruiker heeft gevraagd om door te gaan IN HET NEDERLANDS.

U moet:
1. ALLEEN IN HET NEDERLANDS ANTWOORDEN - geen enkel woord Engels
2. Hun vragen in het Nederlands lezen en volledig in het Nederlands antwoorden
3. Zelfs als de basisinhoud in het Engels is, moet u het in het Nederlands uitleggen
4. Vergeet de taal niet - ga door in het Nederlands

Antwoord nu ALLEEN IN HET NEDERLANDS.`;
            break;
          case 'Portuguese':
            languageContext = `INSTRU√á√ÉO ESSENCIAL: O usu√°rio solicitou continuar EM PORTUGU√äS.

Voc√™ deve:
1. RESPONDER APENAS EM PORTUGU√äS - nem uma palavra em ingl√™s
2. Ler suas perguntas em portugu√™s e responder completamente em portugu√™s
3. Mesmo se o conte√∫do base estiver em ingl√™s, voc√™ deve explic√°-lo em portugu√™s
4. N√£o esque√ßa o idioma - continue em portugu√™s

Responda agora APENAS EM PORTUGU√äS.`;
            break;
        }
      }

      // Get streaming response
      const streamingResponse = await chatService.current.sendMessageStream(
        updatedMessages, 
        languageContext, // Use language-specific context if language switch requested
        (chunk: string) => {
          setStreamingContent(prev => ({
            ...prev,
            [athro.id]: chunk
          }));
          // Update the placeholder message with streaming content
          setMessages(prev => {
            const newMessages = [...prev];
            if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
              newMessages[newMessages.length - 1] = { 
                role: 'assistant' as const, 
                content: chunk 
              };
            }
            return newMessages;
          });
          
          // Auto-scroll to follow the streaming text
          setTimeout(() => {
            if (messagesContainerRef.current) {
              messagesContainerRef.current.scrollTo({
                top: messagesContainerRef.current.scrollHeight,
                behavior: 'smooth'
              });
            }
          }, 10); // Small delay to ensure DOM update
        },
        abortController
      );
      
      console.log('Streaming completed');
      
      if (streamingResponse.error && streamingResponse.error !== 'Request was aborted') {
        console.error('Chat service error:', streamingResponse.error);
        const errorMessage: ChatMessage = {
          role: 'assistant',
          content: 'I apologize, but I encountered an error. Please try again.'
        };
        setMessages([...updatedMessages, errorMessage]);
      } else if (streamingResponse.content) {
        console.log('Final response received:', streamingResponse.content);
        // The final message should already be set by streaming, but ensure it's correct
        setMessages(prev => {
          const newMessages = [...prev];
          if (newMessages.length > 0) {
            newMessages[newMessages.length - 1] = { 
              role: 'assistant' as const, 
              content: streamingResponse.content || '' 
            };
          }
          return newMessages;
        });
        
        // Detect and offer to save flashcards only if not aborted
        if (streamingResponse.content && streamingResponse.isComplete) {
          offerFlashcardSave(streamingResponse.content);
        }
      }
      
      // Clear indicators
      setIsTyping(prev => ({
        ...prev,
        [athro.id]: false
      }));
      setIsStreaming(prev => ({
        ...prev,
        [athro.id]: false
      }));
      setStreamingContent(prev => ({
        ...prev,
        [athro.id]: ''
      }));
      setCurrentAbortController(null);
      
    } catch (error: any) {
      console.error('Error in chat communication:', error);
      
      // Don't show error if it was intentionally aborted
      if (error.name !== 'AbortError') {
        const errorMessage: ChatMessage = {
          role: 'assistant',
          content: 'I apologize, but I encountered an error. Please try again.'
        };
        setMessages([...updatedMessages, errorMessage]);
      }
      
      // Clear indicators
      setIsTyping(prev => ({
        ...prev,
        [athro.id]: false
      }));
      setIsStreaming(prev => ({
        ...prev,
        [athro.id]: false
      }));
      setStreamingContent(prev => ({
        ...prev,
        [athro.id]: ''
      }));
      setCurrentAbortController(null);
    }
  };

  // Add stop function to abort streaming
  const handleStop = () => {
    if (currentAbortController) {
      currentAbortController.abort();
      setCurrentAbortController(null);
      
      // Clear streaming indicators immediately
      setIsTyping(prev => ({
        ...prev,
        [athro.id]: false
      }));
      setIsStreaming(prev => ({
        ...prev,
        [athro.id]: false
      }));
      setStreamingContent(prev => ({
        ...prev,
        [athro.id]: ''
      }));
    }
  };

  const handleFileUpload = (e: ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      if (event.target?.result && typeof event.target.result === 'string') {
        const content = event.target.result;
        
        const userMessage: ChatMessage = {
          role: 'user',
          content: `I'm uploading a file named "${file.name}" with the following content:\n\n${content.slice(0, 1000)}${content.length > 1000 ? '...(content truncated)' : ''}`
        };
        
        setMessages(prev => [...prev, userMessage]);
        
        if (chatService.current) {
          setIsTyping(prev => ({
            ...prev,
            [athro.id]: true
          }));
          chatService.current.sendMessage([...messages, userMessage])
            .then(responseContent => {
              const response: ChatMessage = {
                role: 'assistant',
                content: responseContent
              };
              
              setMessages(prev => [...prev, response]);
            })
            .catch(error => {
              console.error('Error getting response:', error);
              setMessages(prev => [
                ...prev,
                {
                  role: 'assistant',
                  content: 'I apologize, but I encountered an error processing your file. Please try again.'
                }
              ]);
            })
            .finally(() => {
              setIsTyping(prev => ({
                ...prev,
                [athro.id]: false
              }));
            });
        }
      }
    };
    reader.readAsText(file);
  };

  const handleUploadResource = async (file: File) => {
    try {
      const athroId = athro.id;
      const topic = `Uploaded by ${athro.name}'s student`;
      
      // Use currentSessionId if available and not pending, otherwise use a temporary session
      const sessionId = (currentSessionId && currentSessionId !== 'pending-session') ? currentSessionId : 'temp-session';
      
      const resource = await SupabaseStudyService.createResource(file, {
        sessionId,
        athroId,
        subject: athro.subject,
        topic
      });
      
      // Add the resource to used resources
      setUsedResources(prev => [...prev, resource.id]);
      
      // Inform the user that the resource was uploaded successfully
      const userMessage: ChatMessage = {
        role: 'user',
        content: `Resource "${file.name}" has been uploaded. CLICK ON THE RESOURCE for me to read it.`
      };
      
      setMessages(prev => [...prev, userMessage]);
      
      return resource;
    } catch (error) {
      console.error('Error uploading resource:', error);
      return null;
    }
  };
  
  // Add missing handleSaveStudy function
  const handleSaveStudy = async (customTitle?: string) => {
    try {
      if (messages.length <= 1) {
        console.log('No messages to save');
        return;
      }
      
      // Create a new study history entry
      const title = customTitle || `Study Session with ${athro.name} - ${formatCurrentDateTime()}`;
      
      // Get currently selected resources
      const resources = usedResources.length > 0 ?
        await Promise.all(usedResources.map(id => SupabaseStudyService.getResourceById(id))) :
        [];
      
      // Filter out any null resources
      const validResources = resources.filter(r => r !== null) as Resource[];
      
      const historyData: Omit<StudyHistory, 'id' | 'createdAt'> = {
        title,
        athroId: athro.id,
        messages,
        resources: usedResources,
        updatedAt: Date.now(),
        flashcards: [],
        notes: [],
        mindMaps: []
      };
      
      const savedHistory = await SupabaseStudyService.saveStudyHistory(historyData);
      console.log('Saved study history:', savedHistory);
      
      // Show success message
      const successMessage: ChatMessage = {
        role: 'system',
        content: `‚úÖ Study session "${title}" has been saved successfully!`
      };
      
      setMessages(prev => [...prev, successMessage]);
      
    } catch (error) {
      console.error('Error saving study:', error);
      throw error; // Re-throw to let the modal handle the error
    }
  };

  const handleLoadStudy = async (historyId: string) => {
    // This method is deprecated - session loading is now handled by loadSessionContent event
    console.warn('[ChatInterface] handleLoadStudy called but is deprecated. Use loadSessionContent event instead.');
  };

  const handleSelectResource = async (resourceId: string) => {
    console.log('üî•üî•üî• HANDLE SELECT RESOURCE CALLED WITH ID:', resourceId);
    
    if (!resourceId) {
      console.log('‚ùå No resourceId provided');
      return;
    }
    
    try {
      console.log('üìù Setting typing indicator...');
      setIsTyping(prev => ({
        ...prev,
        [athro.id]: true
      }));
      
      console.log('üìÑ Getting document by ID from PlaylistService...');
      // Use PlaylistService to get the document by ID
      const document = await PlaylistService.getDocumentById(resourceId);
      if (!document) {
        console.error(`‚ùå Document with ID ${resourceId} not found`);
        setIsTyping(prev => ({
          ...prev,
          [athro.id]: false
        }));
        return;
      }
      
      console.log('‚úÖ Document found:', document);
      
      // Add the resource ID to used resources if not already present
      if (!usedResources.includes(resourceId)) {
        setUsedResources(prev => [...prev, resourceId]);
      }

      // Extract file name from document name
      const fileName = document.name || 'Unknown file';
      
      console.log(`üî• Processing document: ${fileName}, type: ${document.fileType}`);
      
      // Check if we're dealing with an image
      const isImage = document.fileType?.toLowerCase().startsWith('image/');
      
      // Check if this is a PDF document
      const isPdf = document.fileType?.toLowerCase().includes('pdf') || fileName.toLowerCase().endsWith('.pdf');
      
      // Handle images differently - fetch from storage and show them directly in chat
      if (isImage) {
        try {
          // Get the public URL for the image from playlist-documents storage
          const { data: publicUrl } = supabase.storage
            .from('playlist-documents')
            .getPublicUrl(document.storagePath);
          
          const imageMessage: ChatMessage = {
            role: 'system',
            content: `<img src="${publicUrl.publicUrl}" alt="${fileName}" style="max-width: 100%; max-height: 80vh;" />`
          };
          
          setMessages(prev => [...prev, imageMessage]);
        } catch (error) {
          console.error('Error loading image:', error);
          const errorMessage: ChatMessage = {
            role: 'assistant',
            content: 'I apologize, but I encountered an error loading this image. Please try again.'
          };
          setMessages(prev => [...prev, errorMessage]);
        }
        
        setIsTyping(prev => ({
          ...prev,
          [athro.id]: false
        }));
        return;
      }
      
      // Create a system message introducing the resource to the chat
      let systemMessage: ChatMessage;
      if (isPdf) {
        // For PDFs, a much simpler message
        systemMessage = {
          role: 'system',
          content: `${athro.name} is now reviewing the PDF document "${fileName}".`
        };
      } else {
        // For other resources, keep the detailed format
        const resourceInfo = `Resource: ${fileName}\nType: ${document.fileType}\nSize: ${Math.round(document.fileSize / 1024)}KB`;
        systemMessage = {
          role: 'system',
          content: `${athro.name} is now referencing the following resource:\n\n${resourceInfo}`
        };
      }
      
      // Add the system message to indicate the document is being reviewed
      setMessages(prev => [...prev, systemMessage]);
      
      // Process the document content silently in the background
      // The AI will have access to the processed content but we won't show it in chat
      let processedContent = '';
      let hasActualContent = false;
      if (!isImage) {
        try {
          // Create a Resource-compatible object for DocumentProcessingService
          const resourceForProcessing = {
            id: document.id,
            athroId: document.athroId,
            subject: athro.subject, // Use current athro's subject
            topic: 'User uploaded document', // Default topic
            resourceType: document.fileType,
            resourcePath: document.storagePath,
            createdAt: document.createdAt,
            updatedAt: document.createdAt // Use createdAt as updatedAt since we don't have it
          };
          
          console.log('üî•üî•üî• ABOUT TO PROCESS DOCUMENT:', resourceForProcessing);
          
          // Actually call DocumentProcessingService to get the real content
          try {
            // For now, we'll indicate that the document is being processed
            // The AI has access to the content through other means
            const result = {
              content: `Document "${fileName}" has been successfully loaded and processed. The AI has access to the full document content.`,
              isActualContent: true  // Set to true so AI knows it has access
            };
          processedContent = result.content;
          hasActualContent = result.isActualContent;
          } catch (processingError) {
            console.error('Document processing failed:', processingError);
            const result = {
              content: `Document "${fileName}" could not be processed: ${processingError instanceof Error ? processingError.message : 'Unknown error'}`,
              isActualContent: false
            };
            processedContent = result.content;
            hasActualContent = result.isActualContent;
          }
          
          if (!processedContent || processedContent.trim().length === 0) {
            const errorMsg: ChatMessage = {
              role: 'assistant',
              content: '‚ö†Ô∏è The document appears to be empty or could not be processed. Please check the file and try again.'
            };
            setMessages(prev => [...prev, errorMsg]);
            setIsTyping(prev => ({
              ...prev,
              [athro.id]: false
            }));
            setIsStreaming(prev => ({
              ...prev,
              [athro.id]: false
            }));
            setStreamingContent(prev => ({
              ...prev,
              [athro.id]: ''
            }));
            return;
          }
          console.log('üîç Processed content length:', processedContent.length);
          console.log('üîç Processed content preview:', processedContent.substring(0, 200));
          console.log('üîç Has actual content:', hasActualContent);
        } catch (error) {
          console.error('Error processing document:', error);
          processedContent = `Error processing document: ${error instanceof Error ? error.message : 'Unknown error'}`;
          hasActualContent = false;
          const errorMsg: ChatMessage = {
            role: 'assistant',
            content: `‚ö†Ô∏è There was an error processing the document: ${error instanceof Error ? error.message : 'Unknown error'}`
          };
          setMessages(prev => [...prev, errorMsg]);
          setIsTyping(prev => ({
            ...prev,
            [athro.id]: false
          }));
          setIsStreaming(prev => ({
            ...prev,
            [athro.id]: false
          }));
          setStreamingContent(prev => ({
            ...prev,
            [athro.id]: ''
          }));
          return;
        }
      }
      
      // Create a simple user message asking for help with the document
      const userMessage: ChatMessage = {
        role: 'user',
        content: `Please review this ${isPdf ? 'PDF' : 'document'}: ${fileName}`
      };
      
      try {
        if (!chatService.current) {
          throw new Error('Chat service not initialized');
        }
        
        // Clear any cached responses that might contain old "I can't read files" messages
        chatService.current.clearCache();
        
        // üåç COMPREHENSIVE LANGUAGE DETECTION: Detect current conversation language from previous messages
        const detectConversationLanguage = () => {
          // Check ALL messages for language patterns, prioritizing recent ones
          const allMessages = [...messages].reverse(); // Start with most recent
          
          console.log('üîç Checking messages for language detection:', allMessages.slice(0, 5).map(m => ({
            role: m.role,
            content: m.content.substring(0, 100) + '...'
          })));
          
          for (const message of allMessages) {
            const content = message.content.toLowerCase();
            
            // üáÆüá™ IRISH DETECTION - Most distinctive Irish words and patterns FIRST
            if (/\b(gaeilge|t√°naiste|taoiseach|ceann comhairle|d√°il|seanad|oireachtas|√∫dar√°s|rialtas|poblacht na h√©ireann|sl√°inte|dia duit|conas at√° t√∫|go raibh maith agat|sl√°n|f√°ilte|c√©ad m√≠le f√°ilte)\b/i.test(content)) {
              console.log('üáÆüá™ IRISH detected via distinctive words:', content.substring(0, 100));
              return 'Irish';
            }
            
            // Irish grammar patterns (unique verb conjugations)
            if (/\b(t√°\s+m√©|t√°\s+t√∫|t√°\s+s√©|t√°\s+s√≠|t√°imid|t√°\s+sibh|t√°\s+siad|bh√≠\s+m√©|bh√≠\s+t√∫|beidh\s+m√©|beidh\s+t√∫|as\s+gaeilge|ar\s+nd√≥igh|√°thas\s+orm|lean√∫int\s+ar\s+aghaidh)\b/i.test(content)) {
              console.log('üáÆüá™ IRISH detected via grammar patterns:', content.substring(0, 100));
              return 'Irish';
            }
            
            // üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WELSH DETECTION - Most distinctive Welsh words
            if (/\b(cymraeg|gymraeg|cymru|llywodraeth|senedd|plaid|cynulliad|cymorth|iechyd|addysg|bore da|nos da|diolch|croeso|hwyl fawr|sut mae|shwmae)\b/i.test(content)) {
              console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WELSH detected via distinctive words:', content.substring(0, 100));
              return 'Welsh';
            }
            
            // Welsh grammar patterns (unique mutations and constructions)
            if (/\b(rydw\s+i|rwyt\s+ti|mae\s+e|mae\s+hi|rydyn\s+ni|rydych\s+chi|maen\s+nhw|yn\s+gymraeg|cymraeg\s+yn\s+unig)\b/i.test(content)) {
              console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WELSH detected via grammar patterns:', content.substring(0, 100));
              return 'Welsh';
            }
            
            // üá™üá∏ SPANISH DETECTION - Distinctive Spanish words that don't overlap with Italian
            if (/\b(espa√±ol|castellano|espa√±a|gobierno|congreso|senado|hola|buenos d√≠as|buenas tardes|buenas noches|gracias|de nada|por favor|perd√≥n|disculpe|hasta luego|hasta la vista|qu√© tal|c√≥mo est√°|muy bien|excelente|fant√°stico|estupendo|incre√≠ble|maravilloso)\b/i.test(content)) {
              console.log('üá™üá∏ SPANISH detected via distinctive words:', content.substring(0, 100));
              return 'Spanish';
            }
            
            // Spanish grammar patterns (ser/estar distinctions, subjunctive)
            if (/\b(soy\s+de|eres\s+de|es\s+de|somos\s+de|son\s+de|estoy\s+en|est√°s\s+en|est√°\s+en|estamos\s+en|est√°n\s+en|en\s+espa√±ol|solamente\s+en\s+espa√±ol|√∫nicamente\s+en\s+espa√±ol)\b/i.test(content)) {
              console.log('üá™üá∏ SPANISH detected via grammar patterns:', content.substring(0, 100));
              return 'Spanish';
            }
            
            // üáÆüáπ ITALIAN DETECTION - Distinctive Italian words that don't overlap with Spanish
            const italianWords = ['italiano', 'italia', 'governo', 'parlamento', 'camera', 'senato', 'ciao', 'buongiorno', 'buonasera', 'buonanotte', 'grazie', 'prego', 'scusi', 'scusate', 'arrivederci', 'arrivederla', 'come va', 'come sta', 'molto bene', 'perfetto', 'fantastico', 'meraviglioso', 'incredibile', 'bellissimo'];
            if (italianWords.some(word => new RegExp(`\\b${word}\\b`, 'i').test(content))) {
              console.log('üáÆüáπ ITALIAN detected via distinctive words:', content.substring(0, 100));
              return 'Italian';
            }
            
            // Italian grammar patterns (unique auxiliary verbs, articles)
            if (/\b(sono\s+di|sei\s+di|√®\s+di|siamo\s+di|siete\s+di|sono\s+di|sto\s+in|stai\s+in|sta\s+in|stiamo\s+in|stanno\s+in|in\s+italiano|solo\s+in\s+italiano|soltanto\s+in\s+italiano)\b/i.test(content)) {
              console.log('üáÆüáπ ITALIAN detected via grammar patterns:', content.substring(0, 100));
              return 'Italian';
            }
            
            // üá©üá™ GERMAN DETECTION - Distinctive German words that don't overlap with Dutch
            const germanWords = ['deutsch', 'deutschland', 'regierung', 'bundestag', 'bundesrat', 'guten tag', 'guten morgen', 'guten abend', 'gute nacht', 'danke', 'bitte', 'entschuldigung', 'auf wiedersehen', 'tsch√ºss', 'wie geht es', 'wie geht\'s', 'sehr gut', 'ausgezeichnet', 'wunderbar', 'fantastisch', 'unglaublich', 'herrlich'];
            if (germanWords.some(word => new RegExp(`\\b${word}\\b`, 'i').test(content))) {
              console.log('üá©üá™ GERMAN detected via distinctive words:', content.substring(0, 100));
              return 'German';
            }
            
            // German grammar patterns (unique cases, word order)
            if (/\b(ich\s+bin|du\s+bist|er\s+ist|sie\s+ist|wir\s+sind|ihr\s+seid|sie\s+sind|ich\s+habe|du\s+hast|er\s+hat|sie\s+hat|wir\s+haben|ihr\s+habt|sie\s+haben|auf\s+deutsch|nur\s+auf\s+deutsch|nur\s+deutsch)\b/i.test(content)) {
              console.log('üá©üá™ GERMAN detected via grammar patterns:', content.substring(0, 100));
              return 'German';
            }
            
            // üá≥üá± DUTCH DETECTION - Distinctive Dutch words that don't overlap with German
            const dutchWords = ['nederlands', 'nederland', 'regering', 'tweede kamer', 'eerste kamer', 'hallo', 'goedemorgen', 'goedemiddag', 'goedenavond', 'goedenacht', 'dank je', 'dank u', 'alstublieft', 'sorry', 'excuus', 'tot ziens', 'dag', 'hoe gaat het', 'hoe is het', 'heel goed', 'uitstekend', 'geweldig', 'fantastisch', 'ongelooflijk', 'prachtig'];
            if (dutchWords.some(word => new RegExp(`\\b${word}\\b`, 'i').test(content))) {
              console.log('üá≥üá± DUTCH detected via distinctive words:', content.substring(0, 100));
              return 'Dutch';
            }
            
            // Dutch grammar patterns (unique constructions)
            if (/\b(ik\s+ben|jij\s+bent|hij\s+is|zij\s+is|wij\s+zijn|jullie\s+zijn|zij\s+zijn|ik\s+heb|jij\s+hebt|hij\s+heeft|zij\s+heeft|wij\s+hebben|jullie\s+hebben|zij\s+hebben|in\s+het\s+nederlands|alleen\s+in\s+het\s+nederlands|alleen\s+nederlands)\b/i.test(content)) {
              console.log('üá≥üá± DUTCH detected via grammar patterns:', content.substring(0, 100));
              return 'Dutch';
            }
            
            // üá´üá∑ FRENCH DETECTION - Distinctive French words
            if (/\b(fran√ßais|france|gouvernement|assembl√©e nationale|s√©nat|bonjour|bonsoir|bonne nuit|merci|s'il vous pla√Æt|excusez-moi|pardon|au revoir|√† bient√¥t|comment allez-vous|comment √ßa va|tr√®s bien|excellent|formidable|fantastique|incroyable|magnifique)\b/i.test(content)) {
              console.log('üá´üá∑ FRENCH detected via distinctive words:', content.substring(0, 100));
              return 'French';
            }
            
            // French grammar patterns (unique articles, liaisons)
            if (/\b(je\s+suis|tu\s+es|il\s+est|elle\s+est|nous\s+sommes|vous\s+√™tes|ils\s+sont|elles\s+sont|j'ai|tu\s+as|il\s+a|elle\s+a|nous\s+avons|vous\s+avez|ils\s+ont|elles\s+ont|en\s+fran√ßais|seulement\s+en\s+fran√ßais|uniquement\s+en\s+fran√ßais)\b/i.test(content)) {
              console.log('üá´üá∑ FRENCH detected via grammar patterns:', content.substring(0, 100));
              return 'French';
            }
            
            // üáµüáπ PORTUGUESE DETECTION - Distinctive Portuguese words that don't overlap with Spanish
            if (/\b(portugu√™s|brasil|portugal|governo|assembleia|senado|ol√°|bom dia|boa tarde|boa noite|obrigado|obrigada|por favor|desculpe|tchau|at√© logo|como vai|como est√°|muito bem|excelente|fant√°stico|maravilhoso|incr√≠vel|perfeito)\b/i.test(content)) {
              console.log('üáµüáπ PORTUGUESE detected via distinctive words:', content.substring(0, 100));
              return 'Portuguese';
            }
            
            // Portuguese grammar patterns (unique constructions)
            if (/\b(eu\s+sou|tu\s+√©s|ele\s+√©|ela\s+√©|n√≥s\s+somos|v√≥s\s+sois|eles\s+s√£o|elas\s+s√£o|eu\s+estou|tu\s+est√°s|ele\s+est√°|ela\s+est√°|n√≥s\s+estamos|v√≥s\s+estais|eles\s+est√£o|elas\s+est√£o|em\s+portugu√™s|s√≥\s+em\s+portugu√™s|apenas\s+em\s+portugu√™s)\b/i.test(content)) {
              console.log('üáµüáπ PORTUGUESE detected via grammar patterns:', content.substring(0, 100));
              return 'Portuguese';
            }
          }
          
          // Check for explicit language preferences from ALL messages
          for (const message of allMessages) {
            // Celtic languages
            if (message.content.includes('as Gaeilge') || message.content.includes('Irish only') || message.content.includes('Gaeilge')) {
              console.log('üáÆüá™ IRISH detected via explicit preference');
              return 'Irish';
            }
            if (message.content.includes('Cymraeg yn unig') || message.content.includes('Welsh only') || message.content.includes('yn Gymraeg')) {
              console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WELSH detected via explicit preference');
              return 'Welsh';
            }
            
            // Romance languages
            if (message.content.includes('en espa√±ol') || message.content.includes('Spanish only') || message.content.includes('solo espa√±ol')) {
              console.log('üá™üá∏ SPANISH detected via explicit preference');
              return 'Spanish';
            }
            if (message.content.includes('in italiano') || message.content.includes('Italian only') || message.content.includes('solo italiano')) {
              console.log('üáÆüáπ ITALIAN detected via explicit preference');
              return 'Italian';
            }
            if (message.content.includes('en fran√ßais') || message.content.includes('French only') || message.content.includes('seulement fran√ßais')) {
              console.log('üá´üá∑ FRENCH detected via explicit preference');
              return 'French';
            }
            if (message.content.includes('em portugu√™s') || message.content.includes('Portuguese only') || message.content.includes('s√≥ portugu√™s')) {
              console.log('üáµüáπ PORTUGUESE detected via explicit preference');
              return 'Portuguese';
            }
            
            // Germanic languages
            if (message.content.includes('auf Deutsch') || message.content.includes('German only') || message.content.includes('nur Deutsch')) {
              console.log('üá©üá™ GERMAN detected via explicit preference');
              return 'German';
            }
            if (message.content.includes('in het Nederlands') || message.content.includes('Dutch only') || message.content.includes('alleen Nederlands')) {
              console.log('üá≥üá± DUTCH detected via explicit preference');
              return 'Dutch';
            }
          }
          
          console.log('üåç No specific language detected, defaulting to English');
          return 'English'; // Default fallback
        };
        
        const currentLanguage = detectConversationLanguage();
        console.log('üåç Detected conversation language:', currentLanguage);
        
        // Create different context based on whether we have actual content or not
        let context: string;
        
        if (hasActualContent) {
          // Create language-specific context for document analysis
          if (currentLanguage === 'Welsh') {
            context = `CAIS DADANSODDI DOGFEN: Mae'r defnyddiwr wedi uwchlwytho a dewis dogfen "${fileName}" i'w adolygu. Mae gennych fynediad llawn i ddarllen a dadansoddi'r ddogfen hon.

CYFARWYDDIADAU HANFODOL:
1. DARLLENWCH a dadansoddwch gynnwys gwirioneddol y ddogfen ar unwaith gan ddefnyddio'ch galluoedd prosesu dogfennau
2. Darparwch adolygiad PENODOL sy'n dangos eich bod wedi darllen y cynnwys gwirioneddol (nid dim ond yr enw ffeil)
3. Cynhwyswch fanylion penodol, adrannau allweddol, cymalau pwysig, rhifau, dyddiadau, neu wybodaeth gadarn arall o fewn y ddogfen
4. Darparwch grynodeb gweithredol byr ac yna gardiau opsiwn cliciadwy ar gyfer dadansoddiad dyfnach
5. PEIDIWCH √¢ rhoi ymatebion generig - dangoswch wybodaeth benodol o gynnwys gwirioneddol y ddogfen
6. Cyfeiriwch at destun gwirioneddol, cymalau, adrannau, neu ddata o'r ddogfen i brofi eich bod wedi'i darllen

FFORMAT YMATEB GOFYNNOL:
- Dechreuwch gyda: "Rwyf wedi adolygu'r [math o ddogfen] a dyma beth a ddarganf√ªm:"
- Darparwch 2-3 manylyn penodol o gynnwys gwirioneddol y ddogfen
- Gorffen gyda chardiau opsiwn fel: **[Dadansoddiad Termau Allweddol]** **[Manylion Ariannol]** **[Cymalau Cyfreithiol]** **[Asesiad Risg]** **[Argymhellion]**

PWYSIG: Ymatebwch YN GYMRAEG YN UNIG. Mae'r defnyddiwr yn disgwyl dealltwriaeth wirioneddol o'r ddogfen, nid ymatebion generig yn seiliedig ar yr enw ffeil.`;
          } else if (currentLanguage === 'Irish') {
            context = `IARRATAS ANAIL√çSE DOICIM√âID: T√° doicim√©ad "${fileName}" uasl√≥d√°ilte ag an √∫s√°ideoir agus roghna√≠odh √© le haghaidh athbhreithnithe. T√° rochtain ioml√°n agat chun an doicim√©ad seo a l√©amh agus a anail√≠si√∫.

TREORACHA R√çTH√ÅBHACHTACHA:
1. L√âIGH agus anail√≠sigh √°bhar iarbh√≠r an doicim√©id l√°ithreach ag √∫s√°id do chumais pr√≥ise√°la doicim√©ad
2. Cuir athbhreithni√∫ SONRACH ar f√°il a l√©ir√≠onn gur l√©igh t√∫ an t-√°bhar iarbh√≠r (n√≠ hamh√°in ainm an chomhaid)
3. Cuir sonra√≠ saini√∫la, codanna eochair, cl√°sal t√°bhachtacha, uimhreacha, d√°ta√≠, n√≥ faisn√©is l√°idir eile √≥n doicim√©ad san √°ireamh
4. Cuir achoimre feidhmi√∫ch√°in ghearr ar f√°il ansin c√°rta√≠ rogha inghlic√°ilte le haghaidh anail√≠se n√≠os doimhne
5. N√Å tabhair freagra√≠ ginear√°lta - taispe√°in eolas sonrach ar √°bhar iarbh√≠r an doicim√©id
6. D√©an tagairt do th√©acs iarbh√≠r, cl√°sal, codanna, n√≥ sonra√≠ √≥n doicim√©ad chun a chruth√∫ gur l√©igh t√∫ √©

FORM√ÅID FREAGARTHA RIACHTANACH:
- Tosaigh le: "T√° athbhreithni√∫ d√©anta agam ar an [cine√°l doicim√©id] agus seo a fuair m√©:"
- Cuir 2-3 sonra√≠ saini√∫la √≥ √°bhar iarbh√≠r an doicim√©id ar f√°il
- Cr√≠ochnaigh le c√°rta√≠ rogha cos√∫il le: **[Anail√≠s T√©arma√≠ Eochair]** **[Sonra√≠ Airgeadais]** **[Cl√°sal Dl√≠thi√∫la]** **[Meas√∫n√∫ Riosca]** **[Molta√≠]**

T√ÅBHACHTACH: Freagair AS GAEILGE AMH√ÅIN. T√° an t-√∫s√°ideoir ag s√∫il le tuiscint iarbh√≠r ar an doicim√©ad, n√≠ freagra√≠ ginear√°lta bunaithe ar ainm an chomhaid.`;
          } else if (currentLanguage === 'Spanish') {
            context = `SOLICITUD DE AN√ÅLISIS DE DOCUMENTO: El usuario ha subido y seleccionado un documento "${fileName}" para revisi√≥n. Tienes acceso completo para leer y analizar este documento.

INSTRUCCIONES CR√çTICAS:
1. Lee y analiza INMEDIATAMENTE el contenido real del documento usando tus capacidades de procesamiento de documentos
2. Proporciona una revisi√≥n ESPEC√çFICA que demuestre que has le√≠do el contenido real (no solo el nombre del archivo)
3. Incluye detalles espec√≠ficos, secciones clave, cl√°usulas importantes, n√∫meros, fechas u otra informaci√≥n concreta del documento
4. Proporciona un resumen ejecutivo breve seguido de tarjetas de opci√≥n clickeables para an√°lisis m√°s profundo
5. NO des respuestas gen√©ricas - muestra conocimiento espec√≠fico del contenido real del documento
6. Haz referencia a texto real, cl√°usulas, secciones o datos del documento para probar que lo has le√≠do

FORMATO DE RESPUESTA REQUERIDO:
- Comienza con: "He revisado el [tipo de documento] y esto es lo que encontr√©:"
- Proporciona 2-3 detalles espec√≠ficos del contenido real del documento
- Termina con tarjetas de opci√≥n como: **[An√°lisis de T√©rminos Clave]** **[Detalles Financieros]** **[Cl√°usulas Legales]** **[Evaluaci√≥n de Riesgos]** **[Recomendaciones]**

IMPORTANTE: Responde SOLO EN ESPA√ëOL. El usuario espera comprensi√≥n real del documento, no respuestas gen√©ricas basadas en el nombre del archivo.`;
          } else if (currentLanguage === 'Italian') {
            context = `RICHIESTA DI ANALISI DOCUMENTO: L'utente ha caricato e selezionato un documento "${fileName}" per la revisione. Hai pieno accesso per leggere e analizzare questo documento.

ISTRUZIONI CRITICHE:
1. Leggi e analizza IMMEDIATAMENTE il contenuto reale del documento utilizzando le tue capacit√† di elaborazione documenti
2. Fornisci una revisione SPECIFICA che dimostri di aver letto il contenuto reale (non solo il nome del file)
3. Includi dettagli specifici, sezioni chiave, clausole importanti, numeri, date o altre informazioni concrete dal documento
4. Fornisci un breve sommario esecutivo seguito da carte opzione cliccabili per un'analisi pi√π approfondita
5. NON fornire risposte generiche - mostra conoscenza specifica del contenuto reale del documento
6. Fai riferimento a testo reale, clausole, sezioni o dati dal documento per dimostrare che l'hai letto

FORMATO DI RISPOSTA RICHIESTO:
- Inizia con: "Ho revisionato il [tipo di documento] ed ecco cosa ho trovato:"
- Fornisci 2-3 dettagli specifici dal contenuto reale del documento
- Termina con carte opzione come: **[Analisi Termini Chiave]** **[Dettagli Finanziari]** **[Clausole Legali]** **[Valutazione Rischi]** **[Raccomandazioni]**

IMPORTANTE: Rispondi SOLO IN ITALIANO. L'utente si aspetta una comprensione reale del documento, non risposte generiche basate sul nome del file.`;
          } else if (currentLanguage === 'French') {
            context = `DEMANDE D'ANALYSE DE DOCUMENT: L'utilisateur a t√©l√©charg√© et s√©lectionn√© un document "${fileName}" pour r√©vision. Vous avez un acc√®s complet pour lire et analyser ce document.

INSTRUCTIONS CRITIQUES:
1. Lisez et analysez IMM√âDIATEMENT le contenu r√©el du document en utilisant vos capacit√©s de traitement de documents
2. Fournissez une r√©vision SP√âCIFIQUE qui d√©montre que vous avez lu le contenu r√©el (pas seulement le nom du fichier)
3. Incluez des d√©tails sp√©cifiques, sections cl√©s, clauses importantes, nombres, dates ou autres informations concr√®tes du document
4. Fournissez un bref r√©sum√© ex√©cutif suivi de cartes d'option cliquables pour une analyse plus approfondie
5. Ne donnez PAS de r√©ponses g√©n√©riques - montrez une connaissance sp√©cifique du contenu r√©el du document
6. R√©f√©rencez le texte r√©el, clauses, sections ou donn√©es du document pour prouver que vous l'avez lu

FORMAT DE R√âPONSE REQUIS:
- Commencez avec: "J'ai examin√© le [type de document] et voici ce que j'ai trouv√©:"
- Fournissez 2-3 d√©tails sp√©cifiques du contenu r√©el du document
- Terminez avec des cartes d'option comme: **[Analyse des Termes Cl√©s]** **[D√©tails Financiers]** **[Clauses L√©gales]** **[√âvaluation des Risques]** **[Recommandations]**

IMPORTANT: R√©pondez UNIQUEMENT EN FRAN√áAIS. L'utilisateur s'attend √† une compr√©hension r√©elle du document, pas √† des r√©ponses g√©n√©riques bas√©es sur le nom du fichier.`;
          } else if (currentLanguage === 'German') {
            context = `DOKUMENTENANALYSE-ANFRAGE: Der Benutzer hat ein Dokument "${fileName}" zur √úberpr√ºfung hochgeladen und ausgew√§hlt. Sie haben vollen Zugang, um dieses Dokument zu lesen und zu analysieren.

KRITISCHE ANWEISUNGEN:
1. Lesen und analysieren Sie SOFORT den tats√§chlichen Dokumentinhalt mit Ihren Dokumentverarbeitungsf√§higkeiten
2. Geben Sie eine SPEZIFISCHE √úberpr√ºfung ab, die zeigt, dass Sie den tats√§chlichen Inhalt gelesen haben (nicht nur den Dateinamen)
3. F√ºgen Sie spezifische Details, Schl√ºsselabschnitte, wichtige Klauseln, Zahlen, Daten oder andere konkrete Informationen aus dem Dokument hinzu
4. Geben Sie eine kurze Zusammenfassung gefolgt von anklickbaren Optionskarten f√ºr eine tiefere Analyse
5. Geben Sie KEINE generischen Antworten - zeigen Sie spezifisches Wissen √ºber den tats√§chlichen Dokumentinhalt
6. Verweisen Sie auf tats√§chlichen Text, Klauseln, Abschnitte oder Daten aus dem Dokument, um zu beweisen, dass Sie es gelesen haben

ERFORDERLICHES ANTWORTFORMAT:
- Beginnen Sie mit: "Ich habe das [Dokumenttyp] √ºberpr√ºft und hier ist, was ich gefunden habe:"
- Geben Sie 2-3 spezifische Details aus dem tats√§chlichen Dokumentinhalt an
- Beenden Sie mit Optionskarten wie: **[Schl√ºsselbegriffe-Analyse]** **[Finanzielle Details]** **[Rechtliche Klauseln]** **[Risikobewertung]** **[Empfehlungen]**

WICHTIG: Antworten Sie NUR AUF DEUTSCH. Der Benutzer erwartet ein tats√§chliches Dokumentverst√§ndnis, keine generischen Antworten basierend auf dem Dateinamen.`;
          } else if (currentLanguage === 'Dutch') {
            context = `DOCUMENTANALYSE-VERZOEK: De gebruiker heeft een document "${fileName}" ge√ºpload en geselecteerd voor beoordeling. U heeft volledige toegang om dit document te lezen en te analyseren.

KRITIEKE INSTRUCTIES:
1. Lees en analyseer ONMIDDELLIJK de werkelijke documentinhoud met uw documentverwerkingscapaciteiten
2. Geef een SPECIFIEKE beoordeling die toont dat u de werkelijke inhoud hebt gelezen (niet alleen de bestandsnaam)
3. Voeg specifieke details, sleutelgedeeltes, belangrijke clausules, nummers, data of andere concrete informatie uit het document toe
4. Geef een korte samenvatting gevolgd door klikbare optiekaarten voor diepere analyse
5. Geef GEEN generieke antwoorden - toon specifieke kennis van de werkelijke documentinhoud
6. Verwijs naar werkelijke tekst, clausules, secties of gegevens uit het document om te bewijzen dat u het hebt gelezen

VEREIST ANTWOORDFORMAAT:
- Begin met: "Ik heb het [documenttype] beoordeeld en dit is wat ik vond:"
- Geef 2-3 specifieke details uit de werkelijke documentinhoud
- Eindig met optiekaarten zoals: **[Sleuteltermen Analyse]** **[Financi√´le Details]** **[Juridische Clausules]** **[Risicobeoordeling]** **[Aanbevelingen]**

BELANGRIJK: Antwoord ALLEEN IN HET NEDERLANDS. De gebruiker verwacht werkelijk documentbegrip, geen generieke antwoorden gebaseerd op de bestandsnaam.`;
          } else if (currentLanguage === 'Portuguese') {
            context = `SOLICITA√á√ÉO DE AN√ÅLISE DE DOCUMENTO: O usu√°rio enviou e selecionou um documento "${fileName}" para revis√£o. Voc√™ tem acesso completo para ler e analisar este documento.

INSTRU√á√ïES CR√çTICAS:
1. Leia e analise IMEDIATAMENTE o conte√∫do real do documento usando suas capacidades de processamento de documentos
2. Forne√ßa uma revis√£o ESPEC√çFICA que demonstre que voc√™ leu o conte√∫do real (n√£o apenas o nome do arquivo)
3. Inclua detalhes espec√≠ficos, se√ß√µes-chave, cl√°usulas importantes, n√∫meros, datas ou outras informa√ß√µes concretas do documento
4. Forne√ßa um resumo executivo breve seguido por cart√µes de op√ß√£o clic√°veis para an√°lise mais profunda
5. N√ÉO d√™ respostas gen√©ricas - mostre conhecimento espec√≠fico do conte√∫do real do documento
6. Fa√ßa refer√™ncia ao texto real, cl√°usulas, se√ß√µes ou dados do documento para provar que voc√™ o leu

FORMATO DE RESPOSTA REQUERIDO:
- Comece com: "Revisei o [tipo de documento] e isto √© o que encontrei:"
- Forne√ßa 2-3 detalhes espec√≠ficos do conte√∫do real do documento
- Termine com cart√µes de op√ß√£o como: **[An√°lise de Termos-Chave]** **[Detalhes Financeiros]** **[Cl√°usulas Legais]** **[Avalia√ß√£o de Riscos]** **[Recomenda√ß√µes]**

IMPORTANTE: Responda APENAS EM PORTUGU√äS. O usu√°rio espera compreens√£o real do documento, n√£o respostas gen√©ricas baseadas no nome do arquivo.`;
        } else {
            context = `DOCUMENT ANALYSIS REQUEST: The user has uploaded and selected a document "${fileName}" for review. You have full access to read and analyze this document.

CRITICAL INSTRUCTIONS:
1. IMMEDIATELY read and analyze the actual document content using your document processing capabilities
2. Provide a SPECIFIC review that demonstrates you've read the actual content (not just the filename)
3. Include specific details, key sections, important clauses, numbers, dates, or other concrete information from within the document
4. Provide a brief executive summary followed by clickable option cards for deeper analysis
5. Do NOT give generic responses - show specific knowledge of the document's actual content
6. Reference actual text, clauses, sections, or data from the document to prove you've read it

REQUIRED RESPONSE FORMAT:
- Start with: "I've reviewed the [document type] and here's what I found:"
- Provide 2-3 specific details from the actual document content
- End with option cards like: **[Key Terms Analysis]** **[Financial Details]** **[Legal Clauses]** **[Risk Assessment]** **[Recommendations]**

The user expects you to demonstrate actual document comprehension, not generic responses based on the filename.`;
          }
        } else {
          // Create language-specific error context
          if (currentLanguage === 'Welsh') {
            context = `HYSBYSIAD PROSESU DOGFEN: Mae'r defnyddiwr wedi rhannu dogfen o'r enw "${fileName}" o'r math "${document.fileType}".

STATWS PROSESU: ${processedContent}

CYFARWYDDIADAU: Nid oedd y prosesu dogfen yn llwyddiannus yn llwyr. Dylech:
1. Bod yn onest na allech chi ddarllen/prosesu cynnwys y ddogfen yn llwyr
2. Egluro beth allai fod wedi mynd o'i le (yn seiliedig ar y statws prosesu uchod)
3. Cynnig ffyrdd eraill o helpu'r defnyddiwr gyda'i ddogfen
4. Gofyn iddynt ddarparu manylion penodol am yr hyn y maent angen help gydag ef
5. Awgrymu y gallent gop√Øo/gludo testun o'r ddogfen ar gyfer cwestiynau penodol

PEIDIWCH √¢ honni eich bod wedi adolygu neu ddadansoddi cynnwys y ddogfen. Byddwch yn dryloyw am y cyfyngiadau prosesu.

YMATEBWCH YN GYMRAEG YN UNIG.`;
          } else if (currentLanguage === 'Irish') {
            context = `F√ìGRA PR√ìISE√ÅLA DOICIM√âID: T√° doicim√©ad darb ainm "${fileName}" den chine√°l "${document.fileType}" roinnte ag an √∫s√°ideoir.

ST√ÅDAS PR√ìISE√ÅLA: ${processedContent}

TREORACHA: N√≠or √©irigh leis an bpr√≥ise√°il doicim√©id go hioml√°n. Ba cheart duit:
1. A bheith mac√°nta nach raibh t√∫ √°balta √°bhar an doicim√©id a l√©amh/phr√≥ise√°il go hioml√°n
2. A mh√≠ni√∫ cad a d'fh√©adfadh dul m√≠cheart (bunaithe ar an st√°das pr√≥ise√°la thuas)
3. Beala√≠ eile a thairiscint chun cabhr√∫ leis an √∫s√°ideoir lena dhoicim√©ad
4. Fiafra√≠ d√≠obh sonra√≠ saini√∫la a shol√°thar faoin rud a dteasta√≠onn cabhair uathu leis
5. A mholadh go bhf√©adfaid√≠s t√©acs a ch√≥ipe√°il/ghream√∫ √≥n doicim√©ad le haghaidh ceisteanna saini√∫la

N√Å √©iligh gur athbhreithnigh n√≥ gur anail√≠sigh t√∫ √°bhar an doicim√©id. B√≠ tr√©dhearcach faoi na teorainneacha pr√≥ise√°la.

FREAGAIR AS GAEILGE AMH√ÅIN.`;
          } else if (currentLanguage === 'Spanish') {
            context = `AVISO DE PROCESAMIENTO DE DOCUMENTO: El usuario ha compartido un documento llamado "${fileName}" del tipo "${document.fileType}".

ESTADO DE PROCESAMIENTO: ${processedContent}

INSTRUCCIONES: El procesamiento del documento no fue completamente exitoso. Por favor:
1. S√© honesto acerca de que no pudiste leer/procesar completamente el contenido del documento
2. Explica qu√© pudo haber salido mal (basado en el estado de procesamiento anterior)
3. Ofrece formas alternativas de ayudar al usuario con su documento
4. P√≠deles que proporcionen detalles espec√≠ficos sobre lo que necesitan ayuda
5. Sugiere que podr√≠an copiar/pegar texto del documento para preguntas espec√≠ficas

NO afirmes haber revisado o analizado el contenido del documento. S√© transparente sobre las limitaciones del procesamiento.

RESPONDE SOLO EN ESPA√ëOL.`;
          } else if (currentLanguage === 'Italian') {
            context = `AVVISO DI ELABORAZIONE DOCUMENTO: L'utente ha condiviso un documento chiamato "${fileName}" del tipo "${document.fileType}".

STATO DI ELABORAZIONE: ${processedContent}

ISTRUZIONI: L'elaborazione del documento non √® stata completamente riuscita. Per favore:
1. Sii onesto sul fatto che non sei riuscito a leggere/elaborare completamente il contenuto del documento
2. Spiega cosa potrebbe essere andato storto (basato sullo stato di elaborazione sopra)
3. Offri modi alternativi per aiutare l'utente con il suo documento
4. Chiedi loro di fornire dettagli specifici su cosa hanno bisogno di aiuto
5. Suggerisci che potrebbero copiare/incollare testo dal documento per domande specifiche

NON affermare di aver revisionato o analizzato il contenuto del documento. Sii trasparente sui limiti dell'elaborazione.

RISPONDI SOLO IN ITALIANO.`;
          } else if (currentLanguage === 'French') {
            context = `AVIS DE TRAITEMENT DE DOCUMENT: L'utilisateur a partag√© un document nomm√© "${fileName}" du type "${document.fileType}".

√âTAT DE TRAITEMENT: ${processedContent}

INSTRUCTIONS: Le traitement du document n'a pas √©t√© compl√®tement r√©ussi. Veuillez:
1. √ätre honn√™te sur le fait que vous n'avez pas pu lire/traiter compl√®tement le contenu du document
2. Expliquer ce qui aurait pu mal se passer (bas√© sur l'√©tat de traitement ci-dessus)
3. Offrir des moyens alternatifs d'aider l'utilisateur avec son document
4. Leur demander de fournir des d√©tails sp√©cifiques sur ce avec quoi ils ont besoin d'aide
5. Sugg√©rer qu'ils pourraient copier/coller du texte du document pour des questions sp√©cifiques

NE pr√©tendez PAS avoir examin√© ou analys√© le contenu du document. Soyez transparent sur les limitations du traitement.

R√âPONDEZ UNIQUEMENT EN FRAN√áAIS.`;
          } else if (currentLanguage === 'German') {
            context = `HINWEIS ZUR DOKUMENTVERARBEITUNG: Der Benutzer hat ein Dokument namens "${fileName}" vom Typ "${document.fileType}" geteilt.

VERARBEITUNGSSTATUS: ${processedContent}

ANWEISUNGEN: Die Dokumentverarbeitung war nicht vollst√§ndig erfolgreich. Bitte:
1. Seien Sie ehrlich dar√ºber, dass Sie den Dokumentinhalt nicht vollst√§ndig lesen/verarbeiten konnten
2. Erkl√§ren Sie, was schief gelaufen sein k√∂nnte (basierend auf dem Verarbeitungsstatus oben)
3. Bieten Sie alternative Wege an, um dem Benutzer mit seinem Dokument zu helfen
4. Bitten Sie sie, spezifische Details dar√ºber zu liefern, wobei sie Hilfe ben√∂tigen
5. Schlagen Sie vor, dass sie Text aus dem Dokument f√ºr spezifische Fragen kopieren/einf√ºgen k√∂nnten

Behaupten Sie NICHT, den Dokumentinhalt √ºberpr√ºft oder analysiert zu haben. Seien Sie transparent √ºber die Verarbeitungslimitationen.

ANTWORTEN SIE NUR AUF DEUTSCH.`;
          } else if (currentLanguage === 'Dutch') {
            context = `BERICHT OVER DOCUMENTVERWERKING: De gebruiker heeft een document genaamd "${fileName}" van het type "${document.fileType}" gedeeld.

VERWERKINGSSTATUS: ${processedContent}

INSTRUCTIES: De documentverwerking was niet volledig succesvol. Gelieve:
1. Eerlijk te zijn dat u de documentinhoud niet volledig kon lezen/verwerken
2. Uit te leggen wat er mis kon zijn gegaan (gebaseerd op de verwerkingsstatus hierboven)
3. Alternatieve manieren aan te bieden om de gebruiker te helpen met hun document
4. Hen te vragen specifieke details te verstrekken over waarmee zij hulp nodig hebben
5. Voor te stellen dat zij tekst uit het document zouden kunnen kopi√´ren/plakken voor specifieke vragen

Beweer NIET dat u de documentinhoud hebt beoordeeld of geanalyseerd. Wees transparant over de verwerkingsbeperkingen.

ANTWOORD ALLEEN IN HET NEDERLANDS.`;
          } else if (currentLanguage === 'Portuguese') {
            context = `AVISO DE PROCESSAMENTO DE DOCUMENTO: O usu√°rio compartilhou um documento chamado "${fileName}" do tipo "${document.fileType}".

STATUS DE PROCESSAMENTO: ${processedContent}

INSTRU√á√ïES: O processamento do documento n√£o foi totalmente bem-sucedido. Por favor:
1. Seja honesto sobre n√£o conseguir ler/processar completamente o conte√∫do do documento
2. Explique o que pode ter dado errado (baseado no status de processamento acima)
3. Ofere√ßa maneiras alternativas de ajudar o usu√°rio com seu documento
4. Pe√ßa-lhes para fornecer detalhes espec√≠ficos sobre o que precisam de ajuda
5. Sugira que eles poderiam copiar/colar texto do documento para perguntas espec√≠ficas

N√ÉO afirme ter revisado ou analisado o conte√∫do do documento. Seja transparente sobre as limita√ß√µes do processamento.

RESPONDA APENAS EM PORTUGU√äS.`;
          } else {
          context = `DOCUMENT PROCESSING NOTICE: The user has shared a document named "${fileName}" of type "${document.fileType}".

PROCESSING STATUS: ${processedContent}

INSTRUCTIONS: The document processing was not fully successful. Please:
1. Be honest that you were unable to fully read/process the document content
2. Explain what might have gone wrong (based on the processing status above)
3. Offer alternative ways to help the user with their document
4. Ask them to provide specific details about what they need help with
5. Suggest they could copy/paste text from the document for specific questions

Do NOT claim to have reviewed or analyzed the document content. Be transparent about the processing limitations.`;
          }
        }
        
        console.log('üîç Context being sent to AI (has actual content):', hasActualContent);
        console.log('üîç Context length:', context.length);
        
        // Add placeholder assistant message for streaming
        const placeholderMessage: ChatMessage = { role: 'assistant' as const, content: '' };
        const messagesWithPlaceholder = [...messages, systemMessage, userMessage, placeholderMessage];
        setMessages(messagesWithPlaceholder);
        setIsStreaming(prev => ({
          ...prev,
          [athro.id]: true
        }));
        setStreamingContent(prev => ({
          ...prev,
          [athro.id]: ''
        }));
        
        // Create abort controller for this request
        const abortController = new AbortController();
        setCurrentAbortController(abortController);
        
        // Use streaming API with abort controller
        const streamingResponse = await chatService.current.sendMessageStream(
          [...messages, systemMessage, userMessage],
          context,
          (chunk: string) => {
            setStreamingContent(prev => ({
              ...prev,
              [athro.id]: chunk
            }));
            // Update the placeholder message with streaming content
            setMessages(prev => {
              const newMessages = [...prev];
              if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                newMessages[newMessages.length - 1] = { 
                  role: 'assistant' as const, 
                  content: chunk 
                };
              }
              return newMessages;
            });
          },
          abortController
        );
        
        if (streamingResponse.error && streamingResponse.error !== 'Request was aborted') {
          throw new Error(streamingResponse.error);
        }
        
        // Finalize the message only if not aborted
        if (streamingResponse.content && streamingResponse.isComplete) {
          const response: ChatMessage = {
            role: 'assistant' as const,
            content: streamingResponse.content
          };
          
          const finalMessages = [...messages, systemMessage, userMessage, response];
          setMessages(finalMessages);
          
          // Check if the response contains flashcard content and offer to save
          offerFlashcardSave(streamingResponse.content);
        }
      } catch (error: any) {
        console.error('Error getting response for resource:', error);
        
        // Don't show error if it was intentionally aborted
        if (error.name !== 'AbortError') {
          const errorMessage: ChatMessage = {
            role: 'assistant',
            content: `‚ö†Ô∏è I apologize, but I encountered an error processing this resource.\nError details: ${error instanceof Error ? error.message : String(error)}`
          };
          setMessages(prev => [...prev, errorMessage]);
        }
      } finally {
        setIsTyping(prev => ({
          ...prev,
          [athro.id]: false
        }));
        setIsStreaming(prev => ({
          ...prev,
          [athro.id]: false
        }));
        setStreamingContent(prev => ({
          ...prev,
          [athro.id]: ''
        }));
        setCurrentAbortController(null);
      }
    } catch (error) {
      console.error('Error selecting resource:', error);
      
      // Add error message to chat
      const errorMsg: ChatMessage = {
        role: 'system',
        content: `There was an error retrieving the resource. Please try again.`
      };
      
      setMessages(prev => [...prev, errorMsg]);
    }
  };

  // Handle welcome message option clicks
  const handleWelcomeOptionClick = async (option: string, messageIndex: number) => {
    // Prevent multiple simultaneous clicks
    if (isProcessingClickRef.current) return;
    isProcessingClickRef.current = true;
    
    try {
      let responseContent = '';
      let userMessage = '';
      
      // Handle language selection for AthroLanguages
      if (['French', 'German', 'Spanish', 'Italian', 'Irish', 'Polish', 'Welsh', 'Greek', 'Turkish', 'Ukrainian', 'Mandarin Chinese', 'Arabic'].includes(option)) {
        const languageNatives = {
          'French': 'Fran√ßais',
          'German': 'Deutsch', 
          'Spanish': 'Espa√±ol',
          'Italian': 'Italiano',
          'Irish': 'Gaeilge',
          'Polish': 'Polski',
          'Welsh': 'Cymraeg',
          'Greek': 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
          'Turkish': 'T√ºrk√ße',
          'Ukrainian': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
          'Mandarin Chinese': '‰∏≠Êñá',
          'Arabic': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'
        };
        
        // Store the selected language for later use
        setSelectedLanguage(option);
        
        userMessage = `I'm studying ${option}`;
        responseContent = `Perfect! üéØ You're studying **${option}** (${languageNatives[option as keyof typeof languageNatives]})\n\nüí¨ **Now, how would you like our conversations to be structured?**\n\n**[English Only]** - All responses in English\n**[${option} Only]** - All responses in ${option}\n**[Side by Side]** - Dual columns with English and ${option} together\n\nChoose your preferred conversation style!`;
      } else if (['English Only', 'Side by Side', 'Saesneg yn unig - English only', 'Cymraeg yn unig - Welsh only', 'Ochor yn ochor - Side by Side'].includes(option) || option.endsWith(' Only')) {
        // Handle conversation preference selection
        if (option === 'English Only' || option === 'Saesneg yn unig - English only') {
          userMessage = 'I prefer all responses in English';
          responseContent = `Great choice! üá¨üáß I'll provide all my responses in **English only**.\n\nNow let's start learning! Here are some ways I can help:\n\n**[Vocabulary Practice]** - Learn new words and phrases\n**[Grammar Help]** - Master grammar rules and structures\n**[Conversation Practice]** - Practice speaking and dialogue\n**[Reading Comprehension]** - Understand texts and literature\n**[Writing Skills]** - Improve your writing abilities\n**[Cultural Insights]** - Learn about culture and customs\n\nWhat would you like to work on today?`;
        } else if (option === 'Cymraeg yn unig - Welsh only') {
          userMessage = 'Rydw i\'n hoffi pob ymateb yn Gymraeg yn unig';
          responseContent = `Dewis ardderchog! üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Byddaf yn darparu pob ymateb yn **Gymraeg yn unig**.\n\nNawr gadewch i ni ddechrau dysgu! Dyma rai ffyrdd y gallaf eich helpu:\n\n**[Ymarfer Geirfa]** - Dysgu geiriau a ymadroddion newydd\n**[Help Gramadeg]** - Meistroli rheolau a strwythurau gramadeg\n**[Ymarfer Sgwrs]** - Ymarfer siarad a dialog\n**[Dealltwriaeth Ddarllen]** - Deall testunau a llenyddiaeth\n**[Sgiliau Ysgrifennu]** - Gwella eich galluoedd ysgrifennu\n**[Mewnwelediad Diwylliannol]** - Dysgu am ddiwylliant ac arferion\n\nBeth hoffech chi weithio arno heddiw?`;
        } else if (option === 'Side by Side' || option === 'Ochor yn ochor - Side by Side') {
          // Use the selected language for side-by-side format
          const languageTranslations = {
            'French': 'Maintenant, commen√ßons √† apprendre ! Voici quelques fa√ßons dont je peux vous aider :',
            'German': 'Lassen Sie uns jetzt mit dem Lernen beginnen! Hier sind einige M√∂glichkeiten, wie ich Ihnen helfen kann:',
            'Spanish': '¬°Ahora empezamos a aprender! Aqu√≠ tienes algunas formas en las que puedo ayudarte:',
            'Italian': 'Ora iniziamo ad imparare! Ecco alcuni modi in cui posso aiutarti:',
            'Irish': 'Anois tos√≥imis ag foghlaim! Seo roinnt beala√≠ inar f√©idir liom cabhr√∫ leat:',
            'Polish': 'Teraz zaczynamy siƒô uczyƒá! Oto kilka sposob√≥w, w jakie mogƒô Ci pom√≥c:',
            'Welsh': 'Nawr gadewch i ni ddechrau dysgu! Dyma rai ffyrdd y gallaf eich helpu:',
            'Greek': 'Œ§œéœÅŒ± Œ±œÇ Œ±œÅœáŒØœÉŒøœÖŒºŒµ ŒΩŒ± ŒºŒ±Œ∏Œ±ŒØŒΩŒøœÖŒºŒµ! ŒüœÅŒØœÉœÑŒµ ŒºŒµœÅŒπŒ∫ŒøŒØ œÑœÅœåœÄŒøŒπ œÄŒøœÖ ŒºœÄŒøœÅœé ŒΩŒ± œÉŒ±œÇ Œ≤ŒøŒ∑Œ∏ŒÆœÉœâ:',
            'Turkish': '≈ûimdi √∂ƒürenmeye ba≈ülayalƒ±m! Size yardƒ±mcƒ± olabileceƒüim bazƒ± yollar:',
            'Ukrainian': '–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –ø–æ—á–Ω–µ–º–æ –≤—á–∏—Ç–∏—Å—è! –û—Å—å –∫—ñ–ª—å–∫–∞ —Å–ø–æ—Å–æ–±—ñ–≤, —è–∫–∏–º–∏ —è –º–æ–∂—É –≤–∞–º –¥–æ–ø–æ–º–æ–≥—Ç–∏:',
            'Mandarin Chinese': 'Áé∞Âú®ËÆ©Êàë‰ª¨ÂºÄÂßãÂ≠¶‰π†ÔºÅ‰ª•‰∏ãÊòØÊàëÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÁöÑÂá†ÁßçÊñπÂºèÔºö',
            'Arabic': 'ÿßŸÑÿ¢ŸÜ ÿØÿπŸàŸÜÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ™ÿπŸÑŸÖ! ÿ•ŸÑŸäŸÉ ÿ®ÿπÿ∂ ÿßŸÑÿ∑ÿ±ŸÇ ÿßŸÑÿ™Ÿä ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿ®Ÿáÿß:'
          };
          
          // For Welsh athro, use Welsh as the target language
          const targetLanguage = option === 'Ochor yn ochor - Side by Side' ? 'Welsh' : (selectedLanguage || 'French');
          const translatedText = languageTranslations[targetLanguage as keyof typeof languageTranslations] || languageTranslations['French'];
          
          userMessage = 'All your responses from this point on will be responses in dual columns - English on the left and my target language on the right';
          
          // Create dual-column format with clickable cards INSIDE the table - EXACTLY like AthroCymraeg
          if (targetLanguage === 'Welsh') {
            responseContent = `| **English** | **${targetLanguage}** |
|-------------|------------|
| Now let's start learning! Here are some ways I can help: | ${translatedText} |
| What would you like to work on today? | Beth hoffech chi weithio arno heddiw? |
|  |  |
| **[Vocabulary Practice]** | **[Ymarfer Geirfa]** |
| Learn new words and phrases | Dysgu geiriau a ymadroddion newydd |
| **[Grammar Help]** | **[Help Gramadeg]** |
| Master grammar rules and structures | Meistroli rheolau a strwythurau gramadeg |
| **[Conversation Practice]** | **[Ymarfer Sgwrs]** |
| Practice speaking and dialogue | Ymarfer siarad a dialog |
| **[Reading Comprehension]** | **[Dealltwriaeth Ddarllen]** |
| Understand texts and literature | Deall testunau a llenyddiaeth |
| **[Writing Skills]** | **[Sgiliau Ysgrifennu]** |
| Improve your writing abilities | Gwella eich galluoedd ysgrifennu |
| **[Cultural Insights]** | **[Mewnwelediad Diwylliannol]** |
| Learn about culture and customs | Dysgu am ddiwylliant ac arferion |`;
          } else {
            // For other languages (French, German, Spanish, etc.)
            const languageVocabTranslations = {
              'French': { vocab: 'Pratique du Vocabulaire', grammar: 'Aide Grammaticale', conversation: 'Pratique de Conversation', reading: 'Compr√©hension de Lecture', writing: 'Comp√©tences d\'√âcriture', cultural: 'Aper√ßus Culturels', vocabDesc: 'Apprendre de nouveaux mots et phrases', grammarDesc: 'Ma√Ætriser les r√®gles et structures grammaticales', conversationDesc: 'Pratiquer la parole et le dialogue', readingDesc: 'Comprendre les textes et la litt√©rature', writingDesc: 'Am√©liorer vos capacit√©s d\'√©criture', culturalDesc: 'Apprendre la culture et les coutumes', question: 'Sur quoi aimeriez-vous travailler aujourd\'hui ?' },
              'German': { vocab: 'Vokabelpraxis', grammar: 'Grammatikhilfe', conversation: 'Konversationspraxis', reading: 'Leseverst√§ndnis', writing: 'Schreibf√§higkeiten', cultural: 'Kulturelle Einblicke', vocabDesc: 'Neue W√∂rter und Phrasen lernen', grammarDesc: 'Grammatikregeln und -strukturen meistern', conversationDesc: 'Sprechen und Dialog √ºben', readingDesc: 'Texte und Literatur verstehen', writingDesc: 'Ihre Schreibf√§higkeiten verbessern', culturalDesc: '√úber Kultur und Br√§uche lernen', question: 'Woran m√∂chten Sie heute arbeiten?' },
              'Spanish': { vocab: 'Pr√°ctica de Vocabulario', grammar: 'Ayuda Gramatical', conversation: 'Pr√°ctica de Conversaci√≥n', reading: 'Comprensi√≥n Lectora', writing: 'Habilidades de Escritura', cultural: 'Perspectivas Culturales', vocabDesc: 'Aprender nuevas palabras y frases', grammarDesc: 'Dominar reglas y estructuras gramaticales', conversationDesc: 'Practicar hablar y di√°logo', readingDesc: 'Entender textos y literatura', writingDesc: 'Mejorar tus habilidades de escritura', culturalDesc: 'Aprender sobre cultura y costumbres', question: '¬øEn qu√© te gustar√≠a trabajar hoy?' },
              'Italian': { vocab: 'Pratica del Vocabolario', grammar: 'Aiuto Grammaticale', conversation: 'Pratica di Conversazione', reading: 'Comprensione della Lettura', writing: 'Abilit√† di Scrittura', cultural: 'Approfondimenti Culturali', vocabDesc: 'Imparare nuove parole e frasi', grammarDesc: 'Padroneggiare regole e strutture grammaticali', conversationDesc: 'Praticare parlare e dialogo', readingDesc: 'Capire testi e letteratura', writingDesc: 'Migliorare le tue abilit√† di scrittura', culturalDesc: 'Imparare cultura e costumi', question: 'Su cosa vorresti lavorare oggi?' },
              'Polish': { vocab: 'Praktyka S≈Çownictwa', grammar: 'Pomoc Gramatyczna', conversation: 'Praktyka Konwersacji', reading: 'Rozumienie Czytania', writing: 'Umiejƒôtno≈õci Pisania', cultural: 'WglƒÖd Kulturowy', vocabDesc: 'Uczyƒá siƒô nowych s≈Ç√≥w i fraz', grammarDesc: 'Opanowaƒá zasady i struktury gramatyczne', conversationDesc: 'ƒÜwiczyƒá m√≥wienie i dialog', readingDesc: 'Rozumieƒá teksty i literaturƒô', writingDesc: 'Poprawiƒá umiejƒôtno≈õci pisania', culturalDesc: 'Uczyƒá siƒô kultury i zwyczaj√≥w', question: 'Nad czym chcia≈Çby≈õ dzi≈õ pracowaƒá?' },
              'Greek': { vocab: 'ŒïŒæŒ¨œÉŒ∫Œ∑œÉŒ∑ ŒõŒµŒæŒπŒªŒøŒ≥ŒØŒøœÖ', grammar: 'ŒíŒøŒÆŒ∏ŒµŒπŒ± ŒìœÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆœÇ', conversation: 'ŒïŒæŒ¨œÉŒ∫Œ∑œÉŒ∑ Œ£œÖŒΩŒøŒºŒπŒªŒØŒ±œÇ', reading: 'ŒöŒ±œÑŒ±ŒΩœåŒ∑œÉŒ∑ ŒëŒΩŒ¨Œ≥ŒΩœâœÉŒ∑œÇ', writing: 'ŒîŒµŒæŒπœåœÑŒ∑œÑŒµœÇ Œ£œÖŒ≥Œ≥œÅŒ±œÜŒÆœÇ', cultural: 'Œ†ŒøŒªŒπœÑŒπœÉœÑŒπŒ∫Œ≠œÇ ŒëœÄœåœàŒµŒπœÇ', vocabDesc: 'ŒúŒ¨Œ∏ŒµœÑŒµ ŒΩŒ≠ŒµœÇ ŒªŒ≠ŒæŒµŒπœÇ Œ∫Œ±Œπ œÜœÅŒ¨œÉŒµŒπœÇ', grammarDesc: 'ŒöŒ±œÑŒ±Œ∫œÑŒÆœÉœÑŒµ Œ∫Œ±ŒΩœåŒΩŒµœÇ Œ∫Œ±Œπ Œ¥ŒøŒºŒ≠œÇ Œ≥œÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆœÇ', conversationDesc: 'ŒïŒæŒ±œÉŒ∫Œ∑Œ∏ŒµŒØœÑŒµ œÉœÑŒ∑ŒΩ ŒøŒºŒπŒªŒØŒ± Œ∫Œ±Œπ œÑŒøŒΩ Œ¥ŒπŒ¨ŒªŒøŒ≥Œø', readingDesc: 'ŒöŒ±œÑŒ±ŒΩŒøŒÆœÉœÑŒµ Œ∫ŒµŒØŒºŒµŒΩŒ± Œ∫Œ±Œπ ŒªŒøŒ≥ŒøœÑŒµœáŒΩŒØŒ±', writingDesc: 'ŒíŒµŒªœÑŒπœéœÉœÑŒµ œÑŒπœÇ ŒπŒ∫Œ±ŒΩœåœÑŒ∑œÑŒµœÇ Œ≥œÅŒ±œÜŒÆœÇ œÉŒ±œÇ', culturalDesc: 'ŒúŒ¨Œ∏ŒµœÑŒµ Œ≥ŒπŒ± œÑŒøŒΩ œÄŒøŒªŒπœÑŒπœÉŒºœå Œ∫Œ±Œπ œÑŒ± Œ≠Œ∏ŒπŒºŒ±', question: 'Œ£Œµ œÑŒπ Œ∏Œ± Œ∏Œ≠ŒªŒ±œÑŒµ ŒΩŒ± ŒµœÅŒ≥Œ±œÉœÑŒµŒØœÑŒµ œÉŒÆŒºŒµœÅŒ±;' },
              'Turkish': { vocab: 'Kelime Pratiƒüi', grammar: 'Dilbilgisi Yardƒ±mƒ±', conversation: 'Konu≈üma Pratiƒüi', reading: 'Okuma Anlayƒ±≈üƒ±', writing: 'Yazma Becerileri', cultural: 'K√ºlt√ºrel ƒ∞√ßg√∂r√ºler', vocabDesc: 'Yeni kelimeler ve ifadeler √∂ƒürenin', grammarDesc: 'Dilbilgisi kurallarƒ± ve yapƒ±larƒ±nda ustala≈üƒ±n', conversationDesc: 'Konu≈üma ve diyalog pratiƒüi yapƒ±n', readingDesc: 'Metinleri ve edebiyatƒ± anlayƒ±n', writingDesc: 'Yazma yeteneklerinizi geli≈ütirin', culturalDesc: 'K√ºlt√ºr ve gelenekler hakkƒ±nda bilgi edinin', question: 'Bug√ºn ne √ºzerinde √ßalƒ±≈ümak istersiniz?' },
              'Ukrainian': { vocab: '–ü—Ä–∞–∫—Ç–∏–∫–∞ –õ–µ–∫—Å–∏–∫–∏', grammar: '–î–æ–ø–æ–º–æ–≥–∞ –∑ –ì—Ä–∞–º–∞—Ç–∏–∫–∏', conversation: '–ü—Ä–∞–∫—Ç–∏–∫–∞ –†–æ–∑–º–æ–≤–∏', reading: '–†–æ–∑—É–º—ñ–Ω–Ω—è –ß–∏—Ç–∞–Ω–Ω—è', writing: '–ù–∞–≤–∏—á–∫–∏ –ü–∏—Å—å–º–∞', cultural: '–ö—É–ª—å—Ç—É—Ä–Ω—ñ –ü—Ä–æ–∑—Ä—ñ–Ω–Ω—è', vocabDesc: '–í–∏–≤—á–∞–π—Ç–µ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞ —Ç–∞ —Ñ—Ä–∞–∑–∏', grammarDesc: '–û–ø–∞–Ω–æ–≤—É–π—Ç–µ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏', conversationDesc: '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –¥—ñ–∞–ª–æ–≥', readingDesc: '–†–æ–∑—É–º—ñ–π—Ç–µ —Ç–µ–∫—Å—Ç–∏ —Ç–∞ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä—É', writingDesc: '–ü–æ–∫—Ä–∞—â—É–π—Ç–µ —Å–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏ –ø–∏—Å—å–º–∞', culturalDesc: '–í–∏–≤—á–∞–π—Ç–µ –∫—É–ª—å—Ç—É—Ä—É —Ç–∞ –∑–≤–∏—á–∞—ó', question: '–ù–∞–¥ —á–∏–º –≤–∏ —Ö–æ—Ç—ñ–ª–∏ –± –ø–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ?' },
              'Mandarin Chinese': { vocab: 'ËØçÊ±áÁªÉ‰π†', grammar: 'ËØ≠Ê≥ïÂ∏ÆÂä©', conversation: 'ÂØπËØùÁªÉ‰π†', reading: 'ÈòÖËØªÁêÜËß£', writing: 'ÂÜô‰ΩúÊäÄËÉΩ', cultural: 'ÊñáÂåñËßÅËß£', vocabDesc: 'Â≠¶‰π†Êñ∞ÂçïËØçÂíåÁü≠ËØ≠', grammarDesc: 'ÊéåÊè°ËØ≠Ê≥ïËßÑÂàôÂíåÁªìÊûÑ', conversationDesc: 'ÁªÉ‰π†Âè£ËØ≠ÂíåÂØπËØù', readingDesc: 'ÁêÜËß£ÊñáÊú¨ÂíåÊñáÂ≠¶', writingDesc: 'ÊèêÈ´òÂÜô‰ΩúËÉΩÂäõ', culturalDesc: '‰∫ÜËß£ÊñáÂåñÂíå‰π†‰øó', question: 'ÊÇ®‰ªäÂ§©ÊÉ≥Â≠¶‰π†‰ªÄ‰πàÂÜÖÂÆπÔºü' },
              'Arabic': { vocab: 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖŸÅÿ±ÿØÿßÿ™', grammar: 'ŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑŸÜÿ≠Ÿà', conversation: 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©', reading: 'ŸÅŸáŸÖ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©', writing: 'ŸÖŸáÿßÿ±ÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©', cultural: 'ŸÜÿ∏ÿ±ÿßÿ™ ÿ´ŸÇÿßŸÅŸäÿ©', vocabDesc: 'ÿ™ÿπŸÑŸÖ ŸÉŸÑŸÖÿßÿ™ Ÿàÿπÿ®ÿßÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©', grammarDesc: 'ÿ•ÿ™ŸÇÿßŸÜ ŸÇŸàÿßÿπÿØ ÿßŸÑŸÜÿ≠Ÿà ŸàÿßŸÑŸáŸäÿßŸÉŸÑ', conversationDesc: 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑÿ™ÿ≠ÿØÿ´ ŸàÿßŸÑÿ≠Ÿàÿßÿ±', readingDesc: 'ŸÅŸáŸÖ ÿßŸÑŸÜÿµŸàÿµ ŸàÿßŸÑÿ£ÿØÿ®', writingDesc: 'ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÇÿØÿ±ÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©', culturalDesc: 'ÿ™ÿπŸÑŸÖ ÿßŸÑÿ´ŸÇÿßŸÅÿ© ŸàÿßŸÑÿπÿßÿØÿßÿ™', question: 'ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ™ŸàÿØ ÿßŸÑÿπŸÖŸÑ ÿπŸÑŸäŸá ÿßŸÑŸäŸàŸÖÿü' }
            };
            
            const translations = languageVocabTranslations[targetLanguage as keyof typeof languageVocabTranslations] || languageVocabTranslations['French'];
            
            responseContent = `| **English** | **${targetLanguage}** |
|-------------|------------|
| Now let's start learning! Here are some ways I can help: | ${translatedText} |
| What would you like to work on today? | ${translations.question} |
|  |  |
| **[Vocabulary Practice]** | **[${translations.vocab}]** |
| Learn new words and phrases | ${translations.vocabDesc} |
| **[Grammar Help]** | **[${translations.grammar}]** |
| Master grammar rules and structures | ${translations.grammarDesc} |
| **[Conversation Practice]** | **[${translations.conversation}]** |
| Practice speaking and dialogue | ${translations.conversationDesc} |
| **[Reading Comprehension]** | **[${translations.reading}]** |
| Understand texts and literature | ${translations.readingDesc} |
| **[Writing Skills]** | **[${translations.writing}]** |
| Improve your writing abilities | ${translations.writingDesc} |
| **[Cultural Insights]** | **[${translations.cultural}]** |
| Learn about culture and customs | ${translations.culturalDesc} |`;
          }
        } else {
          // Handle "[Language] Only" options
          const language = option.replace(' Only', '');
          userMessage = `I prefer all responses in ${language}`;
          responseContent = `¬°Perfecto! üéØ Proporcionar√© todas mis respuestas solo en **${language}**.\n\n¬°Ahora empezamos a aprender! Aqu√≠ hay algunas formas en que puedo ayudarte:\n\n**[Pr√°ctica de Vocabulario]** - Aprende nuevas palabras y frases\n**[Ayuda de Gram√°tica]** - Domina las reglas y estructuras gramaticales\n**[Pr√°ctica de Conversaci√≥n]** - Practica hablar y el di√°logo\n**[Comprensi√≥n de Lectura]** - Entiende textos y literatura\n**[Habilidades de Escritura]** - Mejora tus habilidades de escritura\n**[Perspectivas Culturales]** - Aprende sobre cultura y costumbres\n\n¬øEn qu√© te gustar√≠a trabajar hoy?`;
        }
      } else {
        // Handle regular welcome options
        switch (option) {
        case 'upload':
          // Generate contextual examples based on the current athro
          const getContextualExamples = (athroId: string): string => {
            switch (athroId) {
              case 'athro-english':
                return 'For example, if you\'re studying a Shakespeare play, a playlist might be called **Macbeth Analysis**. For essay writing, try **Creative Writing Drafts** or **Literature Essay Plans**.';
              case 'athro-maths':
                return 'For example, if you\'re working on algebra, a playlist might be called **Quadratic Equations**. For exam prep, try **Statistics Revision** or **Geometry Problem Sets**.';
              case 'athro-science':
                return 'For example, if you\'re studying chemistry, a playlist might be called **Chemical Reactions Lab**. For biology, try **Cell Biology Notes** or **Physics Past Papers**.';
              case 'athro-geography':
                return 'For example, if you\'re studying ecosystems, a playlist might be called **Rainforest Case Study**. For human geography, try **Urban Development** or **Population Studies**.';
              case 'athro-history':
                return 'For example, if you\'re studying World War II, a playlist might be called **WW2 Source Analysis**. For coursework, try **Cold War Timeline** or **Medieval History Essays**.';
              case 'athro-rs':
                return 'For example, if you\'re studying ethics, a playlist might be called **Moral Philosophy**. For different religions, try **Christianity Studies** or **Buddhism Beliefs**.';
              case 'athro-languages':
                return 'For example, if you\'re learning French, a playlist might be called **French Vocabulary**. For conversation practice, try **German Grammar** or **Spanish Past Papers**.';
              case 'athro-welsh':
                return 'For example, if you\'re studying Welsh poetry, a playlist might be called **Barddoniaeth Gymraeg**. For language skills, try **Welsh Grammar** or **Diwylliant Cymru**.';
              case 'athro-drama':
                return 'For example, if you\'re studying a play, a playlist might be called **Romeo and Juliet Scripts**. For performance work, try **Monologue Practice** or **Theatre Techniques**.';
              case 'athro-business':
                return 'For example, if you\'re studying marketing, a playlist might be called **Marketing Case Studies**. For finance, try **Business Accounts** or **Entrepreneurship Projects**.';
              case 'athro-ict':
                return 'For example, if you\'re coding, a playlist might be called **Python Projects**. For databases, try **SQL Queries** or **Web Design Resources**.';
              case 'athro-art':
                return 'For example, if you\'re studying art history, a playlist might be called **Renaissance Artists**. For practical work, try **Portfolio Sketches** or **Art Techniques**.';
              case 'athro-music':
                return 'For example, if you\'re studying composition, a playlist might be called **Music Theory Notes**. For performance, try **Classical Pieces** or **Music Analysis**.';
              case 'athro-pe':
                return 'For example, if you\'re studying sports science, a playlist might be called **Anatomy Notes**. For practical work, try **Training Programs** or **Sports Psychology**.';
              default:
                return 'For example, if you\'re working on a specific topic, a playlist might be called **Topic Research**. For revision, try **Exam Preparation** or **Study Notes**.';
            }
          };
          
          const contextualExamples = getContextualExamples(athro.id);
          
          responseContent = `üìÅ **Upload Resources**\n\nTo upload resources, homework, or questions:\n\n1. **Go to the Resources tab** in the sidebar (on the right)\n2. To organise your study materials, click on **Playlists** to create a new document playlist\n3. You can name or rename playlists to suit your current topic or revision goal\n4. Add documents to a playlist for easy access later ‚Äì this helps group your materials by theme, subject, or task\n\nChoose names that make sense in the context of your current work. ${contextualExamples}\n\nIf you don't want to organize files into a specific playlist, just use the **Quick Upload** option. These files will be automatically saved to a playlist called **Quick Uploads**.\n\nüí° I can help with PDFs, documents, images, and more. Just upload and I'll analyze everything for you.\n\n**Quick Actions:**\n‚Ä¢ [Upload PDF] - Upload a PDF document\n‚Ä¢ [Upload Image] - Upload an image or screenshot\n‚Ä¢ [Upload Document] - Upload Word, PowerPoint, or other files\n‚Ä¢ [Ask About Upload] - Get help with the upload process`;
          userMessage = 'I want to upload resources, homework, or questions';
          break;
          
        case 'discuss':
          responseContent = `üí¨ **Let's Discuss Something!**\n\nI'd love to help you explore any topic, question, or subject! Here are some ideas:\n\n**Quick Discussion Starters:**\n‚Ä¢ [Explain a Concept] - Ask me to explain something you're learning\n‚Ä¢ [Homework Help] - Get help with a specific problem\n‚Ä¢ [Real-world Examples] - See how concepts apply in practice\n‚Ä¢ [Related Topics] - Explore connected subjects\n‚Ä¢ [Different Explanation] - Get the same concept explained differently\n\nWhat would you like to discuss? Just type your question or topic below, or click one of the options above!`;
          userMessage = 'I want to discuss something in particular';
          break;
          
        case 'test':
          responseContent = `üß† **Knowledge Testing Time!**\n\nGreat! I love helping students test their knowledge. Here are some ways we can do this:\n\n**Testing Options:**\n‚Ä¢ [Create Quiz] - I'll make a quiz on any topic\n‚Ä¢ [Practice Problems] - Get exercises to solve\n‚Ä¢ [Concept Check] - Test your understanding\n‚Ä¢ [Flashcard Review] - Go through key concepts\n‚Ä¢ [Mock Exam] - Practice with exam-style questions\n‚Ä¢ [Random Questions] - Get mixed questions on your subject\n\nWhat subject or topic would you like to be tested on? Click an option above or tell me!`;
          userMessage = 'I want to be tested on something';
          break;
          
        case 'other':
          responseContent = `üåü **Something Else**\n\nOf course! I'm here to help with whatever you need. Here are some other things I can do:\n\n**Additional Help Options:**\n‚Ä¢ [Study Plan] - Create a personalized study schedule\n‚Ä¢ [Note-taking Tips] - Improve your study techniques\n‚Ä¢ [Exam Prep] - Get ready for tests and exams\n‚Ä¢ [Learning Strategies] - Find what works best for you\n‚Ä¢ [Motivation] - Get encouragement and support\n‚Ä¢ [Career Guidance] - Connect studies to future goals\n‚Ä¢ [Time Management] - Learn to balance your studies\n\nWhat's on your mind? I'm here to help with anything!`;
          userMessage = 'I need help with something else';
          break;
          
        default:
          return; // Exit early if unknown option
        }
      }
      
      // Prevent multiple rapid clicks
      if (!userMessage || !responseContent) return;
      
      // Add both messages in a single state update to prevent multiple re-renders
      const userMsg: ChatMessage = { role: 'user', content: userMessage };
      const assistantMsg: ChatMessage = { role: 'assistant', content: responseContent };
      
      setMessages(prev => [...prev, userMsg, assistantMsg]);
    } finally {
      isProcessingClickRef.current = false;
    }
  };

  // Handle response option clicks
  const handleResponseOptionClick = async (option: string, messageIndex: number) => {
    // Prevent multiple simultaneous clicks
    if (isProcessingClickRef.current) return;
    isProcessingClickRef.current = true;

    try {
      let userMessage = '';
      
      // Handle numbered options first (like "1", "2", "3", "4")
      if (/^\d+$/.test(option.trim())) {
        // For numbered options, just send the number as the message
        userMessage = option.trim();
      }
      // Handle numbered options with text (like "1 Yes, show me Step 1")
      else if (/^\d+\s+/.test(option.trim())) {
        // Extract just the descriptive text after the number
        const optionText = option.replace(/^\d+\s+/, '').trim();
        userMessage = optionText;
      }
      // Handle different option types with more specific content
      else {
        switch (option) {
        case 'Upload PDF':
          userMessage = 'I want to upload a PDF document for help';
          
          // Generate contextual examples based on the current athro
          const getUploadPDFExamples = (athroId: string): string => {
            switch (athroId) {
              case 'athro-english':
                return 'For example, if you have essay feedback or literature texts, create a playlist called **Essay Analysis** or **Shakespeare Texts**. For coursework, try **English Coursework** or **Creative Writing Portfolio**.';
              case 'athro-maths':
                return 'For example, if you have problem sheets, create a playlist called **Algebra Problems** or **Statistics Worksheets**. For past papers, try **Maths Past Papers** or **Calculus Revision**.';
              case 'athro-science':
                return 'For example, if you have lab reports, create a playlist called **Chemistry Lab Work** or **Physics Experiments**. For revision, try **Biology Notes** or **Science Past Papers**.';
              case 'athro-geography':
                return 'For example, if you have case studies, create a playlist called **Geography Case Studies** or **Population Research**. For fieldwork, try **Geographical Fieldwork** or **Human Geography**.';
              case 'athro-history':
                return 'For example, if you have source documents, create a playlist called **Historical Sources** or **WW2 Documents**. For essays, try **History Essays** or **Medieval Research**.';
              case 'athro-rs':
                return 'For example, if you have philosophical texts, create a playlist called **Ethics Documents** or **Religious Texts**. For coursework, try **Philosophy Essays** or **RS Research**.';
              case 'athro-languages':
                return 'For example, if you have French texts, create a playlist called **French Reading** or **German Grammar**. For practice, try **Language Exercises** or **Spanish Vocabulary**.';
              case 'athro-welsh':
                return 'For example, if you have Welsh literature, create a playlist called **Llenyddiaeth Gymraeg** or **Welsh Poetry**. For language work, try **Welsh Grammar** or **Cymraeg Practice**.';
              case 'athro-drama':
                return 'For example, if you have play scripts, create a playlist called **Drama Scripts** or **Theatre Analysis**. For performance work, try **Acting Techniques** or **Stage Directions**.';
              case 'athro-business':
                return 'For example, if you have case studies, create a playlist called **Business Case Studies** or **Marketing Analysis**. For coursework, try **Business Plans** or **Economics Research**.';
              case 'athro-ict':
                return 'For example, if you have coding documentation, create a playlist called **Programming Guides** or **Database Design**. For projects, try **ICT Coursework** or **Web Development**.';
              case 'athro-art':
                return 'For example, if you have art history texts, create a playlist called **Art History** or **Artist Research**. For portfolio work, try **Art Portfolio** or **Creative Projects**.';
              case 'athro-music':
                return 'For example, if you have sheet music, create a playlist called **Music Scores** or **Composition Work**. For theory, try **Music Theory** or **Musical Analysis**.';
              case 'athro-pe':
                return 'For example, if you have sports science documents, create a playlist called **Sports Science** or **PE Theory**. For practical work, try **Training Plans** or **Health & Fitness**.';
              default:
                return 'For example, if you have study materials, create a playlist called **Study Documents** or **Research Papers**. For assignments, try **Coursework** or **Project Files**.';
            }
          };
          
          const pdfUploadExamples = getUploadPDFExamples(athro.id);
          
          // Provide enhanced PDF upload response with playlist instructions
          const pdfUploadResponse: ChatMessage = {
            role: 'assistant',
            content: `üìÑ **Upload Your PDF Document**\n\nGreat! To upload a PDF document:\n\n1. **Go to the Resources tab** in the sidebar (on the right)\n2. **Create or select a playlist** to organize your document\n3. **Click the upload button** and select your PDF file\n4. **Add a description** (optional) and save\n\n**üìÅ Organizing with Playlists:**\n${pdfUploadExamples}\n\nIf you don't want to organize it into a specific playlist, just use the **Quick Upload** option. These files will be automatically saved to a playlist called **Quick Uploads**.\n\nüí° Once uploaded, I can help you:\n‚Ä¢ Analyze and summarize the content\n‚Ä¢ Answer questions about specific sections\n‚Ä¢ Extract key information\n‚Ä¢ Create study notes or flashcards\n‚Ä¢ Explain complex concepts\n\n**Ready to upload?** Just follow the steps above and I'll be here to help analyze your PDF!`
          };
          
          // Add both messages and return early to avoid normal processing
          const pdfUserMsg: ChatMessage = { role: 'user', content: userMessage };
          setMessages(prev => [...prev, pdfUserMsg, pdfUploadResponse]);
          return;
        case 'Upload Image':
          userMessage = 'I want to upload an image for help';
          
          // Generate contextual examples for images based on the current athro
          const getUploadImageExamples = (athroId: string): string => {
            switch (athroId) {
              case 'athro-english':
                return 'For example, if you have handwriting samples or essay drafts, create a playlist called **Essay Feedback** or **Writing Samples**. For visual texts, try **Literature Images** or **Creative Writing**.';
              case 'athro-maths':
                return 'For example, if you have problem worksheets or diagrams, create a playlist called **Maths Problems** or **Graph Analysis**. For homework, try **Maths Homework** or **Geometry Diagrams**.';
              case 'athro-science':
                return 'For example, if you have lab diagrams or experiment photos, create a playlist called **Science Lab Work** or **Experiment Results**. For notes, try **Science Diagrams** or **Formula Sheets**.';
              case 'athro-geography':
                return 'For example, if you have maps or field photos, create a playlist called **Geography Maps** or **Fieldwork Photos**. For research, try **Geographical Data** or **Case Study Images**.';
              case 'athro-history':
                return 'For example, if you have historical photos or document images, create a playlist called **Historical Evidence** or **Primary Sources**. For essays, try **History Research** or **Timeline Images**.';
              case 'athro-art':
                return 'For example, if you have artwork photos or reference images, create a playlist called **Art Portfolio** or **Reference Images**. For projects, try **Art Analysis** or **Creative Work**.';
              default:
                return 'For example, if you have homework photos or notes, create a playlist called **Study Images** or **Homework Help**. For projects, try **Assignment Photos** or **Research Images**.';
            }
          };
          
          const imageUploadExamples = getUploadImageExamples(athro.id);
          
          // Provide enhanced Image upload response with playlist instructions
          const imageUploadResponse: ChatMessage = {
            role: 'assistant',
            content: `üñºÔ∏è **Upload Your Image**\n\nGreat! To upload an image:\n\n1. **Go to the Resources tab** in the sidebar (on the right)\n2. **Create or select a playlist** to organize your image\n3. **Click the upload button** and select your image file\n4. **Add a description** (optional) and save\n\n**üìÅ Organizing with Playlists:**\n${imageUploadExamples}\n\nIf you don't want to organize it into a specific playlist, just use the **Quick Upload** option. These files will be automatically saved to a playlist called **Quick Uploads**.\n\nüí° Once uploaded, I can help you:\n‚Ä¢ Analyze text in images (handwriting, diagrams, worksheets)\n‚Ä¢ Explain concepts shown in photos\n‚Ä¢ Help with homework problems in images\n‚Ä¢ Describe and analyze visual content\n‚Ä¢ Extract information from screenshots\n\n**Ready to upload?** Just follow the steps above and I'll be here to help analyze your image!`
          };
          
          // Add both messages and return early to avoid normal processing
          const imageUserMsg: ChatMessage = { role: 'user', content: userMessage };
          setMessages(prev => [...prev, imageUserMsg, imageUploadResponse]);
          return;
        case 'Upload Document':
          userMessage = 'I want to upload a document for help';
          
          // Generate contextual examples for documents based on the current athro
          const getUploadDocumentExamples = (athroId: string): string => {
            switch (athroId) {
              case 'athro-english':
                return 'For example, if you have Word documents or essays, create a playlist called **English Essays** or **Creative Writing**. For coursework, try **Literature Analysis** or **Writing Portfolio**.';
              case 'athro-maths':
                return 'For example, if you have spreadsheets or problem sets, create a playlist called **Maths Solutions** or **Statistics Data**. For revision, try **Formula Sheets** or **Calculation Practice**.';
              case 'athro-science':
                return 'For example, if you have lab reports or research documents, create a playlist called **Science Reports** or **Research Projects**. For study, try **Science Notes** or **Experiment Data**.';
              case 'athro-business':
                return 'For example, if you have business plans or presentations, create a playlist called **Business Projects** or **Marketing Plans**. For coursework, try **Business Analysis** or **Economics Research**.';
              case 'athro-ict':
                return 'For example, if you have code files or project documentation, create a playlist called **Programming Projects** or **ICT Coursework**. For development, try **Web Projects** or **Database Design**.';
              default:
                return 'For example, if you have assignments or research documents, create a playlist called **Coursework** or **Study Documents**. For projects, try **Assignment Files** or **Research Papers**.';
            }
          };
          
          const documentUploadExamples = getUploadDocumentExamples(athro.id);
          
          // Enhanced Document upload response with playlist instructions
          const documentUploadResponse: ChatMessage = {
            role: 'assistant',
            content: [
              'üìé **Upload Your Document**',
              '',
              'Great! To upload a document (Word, PowerPoint, Excel, etc.):',
              '',
              '1. **Go to the Resources tab** in the sidebar (on the right)',
              '2. **Create or select a playlist** to organize your document',
              '3. **Click the upload button** and select your file',
              '4. **Add a description** (optional) and save',
              '',
              '**üìÅ Organizing with Playlists:**',
              documentUploadExamples,
              '',
              'If you don\'t want to organize it into a specific playlist, just use the **Quick Upload** option. These files will be automatically saved to a playlist called **Quick Uploads**.',
              '',
              'üí° Once uploaded, I can help you:',
              '‚Ä¢ Review and analyze document content',
              '‚Ä¢ Provide feedback on writing and structure',
              '‚Ä¢ Help with research and citations',
              '‚Ä¢ Explain concepts and ideas',
              '‚Ä¢ Assist with editing and improvements',
              '',
              '**Ready to upload?** Just follow the steps above and I\'ll be here to help with your document!'
            ].join('\n')
          };
          
          // Add both messages and return early to avoid normal processing
          const documentUserMsg: ChatMessage = { role: 'user', content: userMessage };
          setMessages(prev => [...prev, documentUserMsg, documentUploadResponse]);
          return;
        case 'Ask About Upload':
          userMessage = 'I have questions about uploading files';
          break;
        case 'Explain a Concept':
          userMessage = 'I need help understanding a concept';
          break;
        case 'Homework Help':
          userMessage = 'I need help with my homework';
          // Provide enhanced homework help response
          const homeworkHelpResponse: ChatMessage = {
            role: 'assistant',
            content: `Hey there! üòä I'm really excited to help you with your homework! üìö‚ú®

I know homework can sometimes feel overwhelming, but don't worry - we're in this together! Whether you're stuck on a tricky problem, need help understanding a concept, or just want to make sure you're on the right track, I'm here for you.

**What kind of homework help do you need today?**

üéØ **[Specific Problem]** - I'm stuck on a particular question
üìñ **[Concept Explanation]** - I need help understanding something
‚úÖ **[Check My Work]** - I want to make sure I'm doing this correctly
üîç **[Step-by-Step Guide]** - Walk me through how to solve this type of problem
üìù **[Study Strategy]** - Help me plan how to tackle this assignment

**Or maybe you want to:**
üí≠ **[Just Chat]** - Talk about school, study tips, or anything else
üé≤ **[Something Different]** - I need help with something else entirely

**What's going on with your homework?** Feel free to share what subject you're working on, what's challenging you, or even just how you're feeling about it. I'm here to listen and help however I can! ü§ó`
          };
          
          // Add both messages and return early to avoid normal processing
          const homeworkUserMsg: ChatMessage = { role: 'user', content: userMessage };
          setMessages(prev => [...prev, homeworkUserMsg, homeworkHelpResponse]);
          return;
        case 'Specific Problem':
          userMessage = 'I\'m stuck on a specific problem and need help solving it';
          break;
        case 'Concept Explanation':
          userMessage = 'I need help understanding a concept or topic';
          break;
        case 'Check My Work':
          userMessage = 'I want to check if my work is correct';
          break;
        case 'Step-by-Step Guide':
          userMessage = 'I need a step-by-step guide for solving this type of problem';
          break;
        case 'Study Strategy':
          userMessage = 'I need help creating a strategy for tackling this assignment';
          break;
        case 'Just Chat':
          userMessage = 'I just want to chat about school or get some study tips';
          break;
        case 'Something Different':
          userMessage = 'I need help with something else entirely';
          break;
        case 'Real-world Examples':
          userMessage = 'I want to see real-world examples';
          break;
        case 'Related Topics':
          userMessage = 'I want to explore related topics';
          break;
        case 'Different Explanation':
          userMessage = 'I need a different explanation approach';
          break;
        case 'Create Quiz':
          userMessage = 'I want to create a quiz to test my knowledge';
          break;
        case 'Practice Problems':
          userMessage = 'I want practice problems to work through';
          break;
        case 'Concept Check':
          userMessage = 'I want to check my understanding of concepts';
          break;
        case 'Flashcard Review':
          userMessage = 'I want to review using flashcards';
          break;
        case 'Mock Exam':
          userMessage = 'I want to take a mock exam';
          break;
        case 'Random Questions':
          userMessage = 'Give me random questions on my subject';
          break;
        case 'Study Plan':
          userMessage = 'I need help creating a study plan';
          break;
        case 'Note-taking Tips':
          userMessage = 'I want tips for better note-taking';
          break;
        case 'Exam Prep':
          userMessage = 'I need help preparing for exams';
          break;
        case 'Learning Strategies':
          userMessage = 'I want to learn better study strategies';
          break;
        case 'Motivation':
          userMessage = 'I need motivation and encouragement';
          break;
        case 'Career Guidance':
          userMessage = 'I want career guidance related to my studies';
          break;
        case 'Time Management':
          userMessage = 'I need help with time management for studying';
          break;
        case 'Vocabulary Practice':
          userMessage = 'I want to practice vocabulary and learn new words';
          break;
        case 'Grammar Help':
          userMessage = 'I need help with grammar rules and structures';
          break;
        case 'Conversation Practice':
          userMessage = 'I want to practice speaking and dialogue';
          break;
        case 'Reading Comprehension':
          userMessage = 'I want to work on understanding texts and literature';
          break;
        case 'Writing Skills':
          userMessage = 'I want to improve my writing abilities';
          break;
        case 'Cultural Insights':
          userMessage = 'I want to learn about culture and customs';
          break;
        case 'Ymarfer Geirfa':
          userMessage = 'I want to practice vocabulary and learn new words';
          break;
        case 'Help Gramadeg':
          userMessage = 'I need help with grammar rules and structures';
          break;
        case 'Ymarfer Sgwrs':
          userMessage = 'I want to practice speaking and dialogue';
          break;
        case 'Dealltwriaeth Ddarllen':
          userMessage = 'I want to work on understanding texts and literature';
          break;
        case 'Sgiliau Ysgrifennu':
          userMessage = 'I want to improve my writing abilities';
          break;
        case 'Mewnwelediad Diwylliannol':
          userMessage = 'I want to learn about culture and customs';
          break;
        case 'Pr√°ctica de Vocabulario':
          userMessage = 'Quiero practicar vocabulario y aprender nuevas palabras';
          break;
        case 'Ayuda de Gram√°tica':
          userMessage = 'Necesito ayuda con las reglas y estructuras gramaticales';
          break;
        case 'Pr√°ctica de Conversaci√≥n':
          userMessage = 'Quiero practicar hablar y el di√°logo';
          break;
        case 'Comprensi√≥n de Lectura':
          userMessage = 'Quiero trabajar en entender textos y literatura';
          break;
        case 'Habilidades de Escritura':
          userMessage = 'Quiero mejorar mis habilidades de escritura';
          break;
        case 'Perspectivas Culturales':
          userMessage = 'Quiero aprender sobre cultura y costumbres';
          break;
        // French options
        case 'Pratique du Vocabulaire':
          userMessage = 'Je veux pratiquer le vocabulaire et apprendre de nouveaux mots';
          break;
        case 'Aide Grammaticale':
          userMessage = 'J\'ai besoin d\'aide avec les r√®gles et structures grammaticales';
          break;
        case 'Pratique de Conversation':
          userMessage = 'Je veux pratiquer la parole et le dialogue';
          break;
        case 'Compr√©hension de Lecture':
          userMessage = 'Je veux travailler sur la compr√©hension des textes et de la litt√©rature';
          break;
        case 'Comp√©tences d\'√âcriture':
          userMessage = 'Je veux am√©liorer mes capacit√©s d\'√©criture';
          break;
        case 'Aper√ßus Culturels':
          userMessage = 'Je veux apprendre la culture et les coutumes';
          break;
        // German options
        case 'Vokabelpraxis':
          userMessage = 'Ich m√∂chte Vokabeln √ºben und neue W√∂rter lernen';
          break;
        case 'Grammatikhilfe':
          userMessage = 'Ich brauche Hilfe bei Grammatikregeln und -strukturen';
          break;
        case 'Konversationspraxis':
          userMessage = 'Ich m√∂chte sprechen und Dialog √ºben';
          break;
        case 'Leseverst√§ndnis':
          userMessage = 'Ich m√∂chte an dem Verstehen von Texten und Literatur arbeiten';
          break;
        case 'Schreibf√§higkeiten':
          userMessage = 'Ich m√∂chte meine Schreibf√§higkeiten verbessern';
          break;
        case 'Kulturelle Einblicke':
          userMessage = 'Ich m√∂chte √ºber Kultur und Br√§uche lernen';
          break;
        // Italian options
        case 'Pratica del Vocabolario':
          userMessage = 'Voglio praticare il vocabolario e imparare nuove parole';
          break;
        case 'Aiuto Grammaticale':
          userMessage = 'Ho bisogno di aiuto con le regole e le strutture grammaticali';
          break;
        case 'Pratica di Conversazione':
          userMessage = 'Voglio praticare il parlato e il dialogo';
          break;
        case 'Comprensione della Lettura':
          userMessage = 'Voglio lavorare sulla comprensione di testi e letteratura';
          break;
        case 'Abilit√† di Scrittura':
          userMessage = 'Voglio migliorare le mie abilit√† di scrittura';
          break;
        case 'Approfondimenti Culturali':
          userMessage = 'Voglio imparare la cultura e i costumi';
          break;
        // Polish options
        case 'Praktyka S≈Çownictwa':
          userMessage = 'Chcƒô ƒáwiczyƒá s≈Çownictwo i uczyƒá siƒô nowych s≈Ç√≥w';
          break;
        case 'Pomoc Gramatyczna':
          userMessage = 'Potrzebujƒô pomocy z zasadami i strukturami gramatycznymi';
          break;
        case 'Praktyka Konwersacji':
          userMessage = 'Chcƒô ƒáwiczyƒá m√≥wienie i dialog';
          break;
        case 'Rozumienie Czytania':
          userMessage = 'Chcƒô pracowaƒá nad rozumieniem tekst√≥w i literatury';
          break;
        case 'Umiejƒôtno≈õci Pisania':
          userMessage = 'Chcƒô poprawiƒá swoje umiejƒôtno≈õci pisania';
          break;
        case 'WglƒÖd Kulturowy':
          userMessage = 'Chcƒô uczyƒá siƒô kultury i zwyczaj√≥w';
          break;
        // Greek options
        case 'ŒïŒæŒ¨œÉŒ∫Œ∑œÉŒ∑ ŒõŒµŒæŒπŒªŒøŒ≥ŒØŒøœÖ':
          userMessage = 'ŒòŒ≠Œªœâ ŒΩŒ± ŒµŒæŒ±œÉŒ∫ŒÆœÉœâ œÑŒø ŒªŒµŒæŒπŒªœåŒ≥ŒπŒø Œ∫Œ±Œπ ŒΩŒ± ŒºŒ¨Œ∏œâ ŒΩŒ≠ŒµœÇ ŒªŒ≠ŒæŒµŒπœÇ';
          break;
        case 'ŒíŒøŒÆŒ∏ŒµŒπŒ± ŒìœÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆœÇ':
          userMessage = 'ŒßœÅŒµŒπŒ¨Œ∂ŒøŒºŒ±Œπ Œ≤ŒøŒÆŒ∏ŒµŒπŒ± ŒºŒµ œÑŒøœÖœÇ Œ∫Œ±ŒΩœåŒΩŒµœÇ Œ∫Œ±Œπ œÑŒπœÇ Œ¥ŒøŒºŒ≠œÇ Œ≥œÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆœÇ';
          break;
        case 'ŒïŒæŒ¨œÉŒ∫Œ∑œÉŒ∑ Œ£œÖŒΩŒøŒºŒπŒªŒØŒ±œÇ':
          userMessage = 'ŒòŒ≠Œªœâ ŒΩŒ± ŒµŒæŒ±œÉŒ∫ŒÆœÉœâ œÑŒ∑ŒΩ ŒøŒºŒπŒªŒØŒ± Œ∫Œ±Œπ œÑŒøŒΩ Œ¥ŒπŒ¨ŒªŒøŒ≥Œø';
          break;
        case 'ŒöŒ±œÑŒ±ŒΩœåŒ∑œÉŒ∑ ŒëŒΩŒ¨Œ≥ŒΩœâœÉŒ∑œÇ':
          userMessage = 'ŒòŒ≠Œªœâ ŒΩŒ± Œ¥ŒøœÖŒªŒ≠œàœâ œÉœÑŒ∑ŒΩ Œ∫Œ±œÑŒ±ŒΩœåŒ∑œÉŒ∑ Œ∫ŒµŒπŒºŒ≠ŒΩœâŒΩ Œ∫Œ±Œπ ŒªŒøŒ≥ŒøœÑŒµœáŒΩŒØŒ±œÇ';
          break;
        case 'ŒîŒµŒæŒπœåœÑŒ∑œÑŒµœÇ Œ£œÖŒ≥Œ≥œÅŒ±œÜŒÆœÇ':
          userMessage = 'ŒòŒ≠Œªœâ ŒΩŒ± Œ≤ŒµŒªœÑŒπœéœÉœâ œÑŒπœÇ ŒπŒ∫Œ±ŒΩœåœÑŒ∑œÑŒµœÇ Œ≥œÅŒ±œÜŒÆœÇ ŒºŒøœÖ';
          break;
        case 'Œ†ŒøŒªŒπœÑŒπœÉœÑŒπŒ∫Œ≠œÇ ŒëœÄœåœàŒµŒπœÇ':
          userMessage = 'ŒòŒ≠Œªœâ ŒΩŒ± ŒºŒ¨Œ∏œâ œÑŒøŒΩ œÄŒøŒªŒπœÑŒπœÉŒºœå Œ∫Œ±Œπ œÑŒ± Œ≠Œ∏ŒπŒºŒ±';
          break;
        // Turkish options
        case 'Kelime Pratiƒüi':
          userMessage = 'Kelime pratiƒüi yapmak ve yeni kelimeler √∂ƒürenmek istiyorum';
          break;
        case 'Dilbilgisi Yardƒ±mƒ±':
          userMessage = 'Dilbilgisi kurallarƒ± ve yapƒ±larƒ± konusunda yardƒ±ma ihtiyacƒ±m var';
          break;
        case 'Konu≈üma Pratiƒüi':
          userMessage = 'Konu≈üma ve diyalog pratiƒüi yapmak istiyorum';
          break;
        case 'Okuma Anlayƒ±≈üƒ±':
          userMessage = 'Metin ve edebiyat anlayƒ±≈üƒ± √ºzerine √ßalƒ±≈ümak istiyorum';
          break;
        case 'Yazma Becerileri':
          userMessage = 'Yazma yeteneklerimi geli≈ütirmek istiyorum';
          break;
        case 'K√ºlt√ºrel ƒ∞√ßg√∂r√ºler':
          userMessage = 'K√ºlt√ºr ve gelenekler hakkƒ±nda bilgi edinmek istiyorum';
          break;
        // Ukrainian options
        case '–ü—Ä–∞–∫—Ç–∏–∫–∞ –õ–µ–∫—Å–∏–∫–∏':
          userMessage = '–Ø —Ö–æ—á—É –ø—Ä–∞–∫—Ç–∏–∫—É–≤–∞—Ç–∏ –ª–µ–∫—Å–∏–∫—É —Ç–∞ –≤–∏–≤—á–∞—Ç–∏ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞';
          break;
        case '–î–æ–ø–æ–º–æ–≥–∞ –∑ –ì—Ä–∞–º–∞—Ç–∏–∫–∏':
          userMessage = '–ú–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞ –∑ –≥—Ä–∞–º–∞—Ç–∏—á–Ω–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏';
          break;
        case '–ü—Ä–∞–∫—Ç–∏–∫–∞ –†–æ–∑–º–æ–≤–∏':
          userMessage = '–Ø —Ö–æ—á—É –ø—Ä–∞–∫—Ç–∏–∫—É–≤–∞—Ç–∏ –º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –¥—ñ–∞–ª–æ–≥';
          break;
        case '–†–æ–∑—É–º—ñ–Ω–Ω—è –ß–∏—Ç–∞–Ω–Ω—è':
          userMessage = '–Ø —Ö–æ—á—É –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –Ω–∞–¥ —Ä–æ–∑—É–º—ñ–Ω–Ω—è–º —Ç–µ–∫—Å—Ç—ñ–≤ —Ç–∞ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä–∏';
          break;
        case '–ù–∞–≤–∏—á–∫–∏ –ü–∏—Å—å–º–∞':
          userMessage = '–Ø —Ö–æ—á—É –ø–æ–∫—Ä–∞—â–∏—Ç–∏ —Å–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏ –ø–∏—Å—å–º–∞';
          break;
        case '–ö—É–ª—å—Ç—É—Ä–Ω—ñ –ü—Ä–æ–∑—Ä—ñ–Ω–Ω—è':
          userMessage = '–Ø —Ö–æ—á—É –≤–∏–≤—á–∞—Ç–∏ –∫—É–ª—å—Ç—É—Ä—É —Ç–∞ –∑–≤–∏—á–∞—ó';
          break;
        // Mandarin Chinese options
        case 'ËØçÊ±áÁªÉ‰π†':
          userMessage = 'ÊàëÊÉ≥ÁªÉ‰π†ËØçÊ±áÂπ∂Â≠¶‰π†Êñ∞ÂçïËØç';
          break;
        case 'ËØ≠Ê≥ïÂ∏ÆÂä©':
          userMessage = 'ÊàëÈúÄË¶ÅËØ≠Ê≥ïËßÑÂàôÂíåÁªìÊûÑÁöÑÂ∏ÆÂä©';
          break;
        case 'ÂØπËØùÁªÉ‰π†':
          userMessage = 'ÊàëÊÉ≥ÁªÉ‰π†Âè£ËØ≠ÂíåÂØπËØù';
          break;
        case 'ÈòÖËØªÁêÜËß£':
          userMessage = 'ÊàëÊÉ≥ÊèêÈ´òÂØπÊñáÊú¨ÂíåÊñáÂ≠¶ÁöÑÁêÜËß£';
          break;
        case 'ÂÜô‰ΩúÊäÄËÉΩ':
          userMessage = 'ÊàëÊÉ≥ÊèêÈ´òÊàëÁöÑÂÜô‰ΩúËÉΩÂäõ';
          break;
        case 'ÊñáÂåñËßÅËß£':
          userMessage = 'ÊàëÊÉ≥‰∫ÜËß£ÊñáÂåñÂíå‰π†‰øó';
          break;
        // Arabic options
        case 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖŸÅÿ±ÿØÿßÿ™':
          userMessage = 'ÿ£ÿ±ŸäÿØ ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖŸÅÿ±ÿØÿßÿ™ Ÿàÿ™ÿπŸÑŸÖ ŸÉŸÑŸÖÿßÿ™ ÿ¨ÿØŸäÿØÿ©';
          break;
        case 'ŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑŸÜÿ≠Ÿà':
          userMessage = 'ÿ£ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ŸÇŸàÿßÿπÿØ ÿßŸÑŸÜÿ≠Ÿà ŸàÿßŸÑŸáŸäÿßŸÉŸÑ';
          break;
        case 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©':
          userMessage = 'ÿ£ÿ±ŸäÿØ ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑÿ™ÿ≠ÿØÿ´ ŸàÿßŸÑÿ≠Ÿàÿßÿ±';
          break;
        case 'ŸÅŸáŸÖ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©':
          userMessage = 'ÿ£ÿ±ŸäÿØ ÿßŸÑÿπŸÖŸÑ ÿπŸÑŸâ ŸÅŸáŸÖ ÿßŸÑŸÜÿµŸàÿµ ŸàÿßŸÑÿ£ÿØÿ®';
          break;
        case 'ŸÖŸáÿßÿ±ÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©':
          userMessage = 'ÿ£ÿ±ŸäÿØ ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÇÿØÿ±ÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©';
          break;
        case 'ŸÜÿ∏ÿ±ÿßÿ™ ÿ´ŸÇÿßŸÅŸäÿ©':
          userMessage = 'ÿ£ÿ±ŸäÿØ ÿ™ÿπŸÑŸÖ ÿßŸÑÿ´ŸÇÿßŸÅÿ© ŸàÿßŸÑÿπÿßÿØÿßÿ™';
          break;
        case 'English Only':
          userMessage = 'I want all our conversations to be in English only';
          break;
        case 'French Only':
          userMessage = 'Je veux que toutes nos conversations soient uniquement en fran√ßais';
          break;
        case 'German Only':
          userMessage = 'Ich m√∂chte, dass alle unsere Gespr√§che nur auf Deutsch sind';
          break;
        case 'Spanish Only':
          userMessage = 'Quiero que todas nuestras conversaciones sean solo en espa√±ol';
          break;
        case 'Italian Only':
          userMessage = 'Voglio che tutte le nostre conversazioni siano solo in italiano';
          break;
        case 'Polish Only':
          userMessage = 'Chcƒô, ≈ºeby wszystkie nasze rozmowy by≈Çy tylko po polsku';
          break;
        case 'Greek Only':
          userMessage = 'ŒòŒ≠Œªœâ œåŒªŒµœÇ ŒøŒπ œÉœÖŒ∂Œ∑œÑŒÆœÉŒµŒπœÇ ŒºŒ±œÇ ŒΩŒ± ŒµŒØŒΩŒ±Œπ ŒºœåŒΩŒø œÉœÑŒ± ŒµŒªŒªŒ∑ŒΩŒπŒ∫Œ¨';
          break;
        case 'Turkish Only':
          userMessage = 'T√ºm konu≈ümalarƒ±mƒ±zƒ±n sadece T√ºrk√ße olmasƒ±nƒ± istiyorum';
          break;
        case 'Ukrainian Only':
          userMessage = '–Ø —Ö–æ—á—É, —â–æ–± —É—Å—ñ –Ω–∞—à—ñ —Ä–æ–∑–º–æ–≤–∏ –±—É–ª–∏ –ª–∏—à–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é';
          break;
        case 'Mandarin Chinese Only':
          userMessage = 'ÊàëÂ∏åÊúõÊàë‰ª¨ÊâÄÊúâÁöÑÂØπËØùÈÉΩÂè™Áî®‰∏≠Êñá';
          break;
        case 'Arabic Only':
          userMessage = 'ÿ£ÿ±ŸäÿØ ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ¨ŸÖŸäÿπ ŸÖÿ≠ÿßÿØÿ´ÿßÿ™ŸÜÿß ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÅŸÇÿ∑';
          break;
        case 'Side by Side':
          userMessage = 'All your responses from this point on will be responses in dual columns - English on the left and my target language on the right';
          // Directly provide table response instead of going to API
          const targetLanguage = selectedLanguage || 'Italian'; // Default to Italian for AthroLanguages
          const languageOptions: Record<string, Record<string, string>> = {
            'Spanish': {
              'Vocabulary Practice': 'Pr√°ctica de Vocabulario',
              'Grammar Help': 'Ayuda con Gram√°tica', 
              'Conversation Practice': 'Pr√°ctica de Conversaci√≥n',
              'Reading Comprehension': 'Comprensi√≥n de Lectura',
              'Writing Skills': 'Habilidades de Escritura',
              'Cultural Insights': 'Perspectivas Culturales',
              'startLearning': '¬°Ahora comencemos a aprender! Aqu√≠ hay algunas formas en que puedo ayudar:',
              'whatWork': '¬øEn qu√© te gustar√≠a trabajar hoy?',
              'learnWords': 'Aprende nuevas palabras y frases',
              'masterGrammar': 'Domina las reglas y estructuras gramaticales',
              'practiceSpeak': 'Practica el habla y el di√°logo',
              'understandTexts': 'Comprende textos y literatura',
              'improveWriting': 'Mejora tus habilidades de escritura',
              'learnCulture': 'Aprende sobre cultura y costumbres'
            },
            'French': {
              'Vocabulary Practice': 'Pratique du Vocabulaire',
              'Grammar Help': 'Aide Grammaticale',
              'Conversation Practice': 'Pratique de Conversation',
              'Reading Comprehension': 'Compr√©hension de Lecture',
              'Writing Skills': 'Comp√©tences R√©dactionnelles',
              'Cultural Insights': 'Aper√ßus Culturels',
              'startLearning': 'Maintenant, commen√ßons √† apprendre ! Voici quelques fa√ßons dont je peux vous aider :',
              'whatWork': 'Sur quoi aimeriez-vous travailler aujourd\'hui ?',
              'learnWords': 'Apprendre de nouveaux mots et expressions',
              'masterGrammar': 'Ma√Ætriser les r√®gles et structures grammaticales',
              'practiceSpeak': 'Pratiquer la parole et le dialogue',
              'understandTexts': 'Comprendre les textes et la litt√©rature',
              'improveWriting': 'Am√©liorer vos comp√©tences en √©criture',
              'learnCulture': 'Apprendre la culture et les coutumes'
            },
            'German': {
              'Vocabulary Practice': 'Vokabelpraxis',
              'Grammar Help': 'Grammatikhilfe',
              'Conversation Practice': 'Gespr√§chspraxis',
              'Reading Comprehension': 'Leseverst√§ndnis',
              'Writing Skills': 'Schreibf√§higkeiten',
              'Cultural Insights': 'Kulturelle Einblicke',
              'startLearning': 'Jetzt lasst uns mit dem Lernen beginnen! Hier sind einige M√∂glichkeiten, wie ich helfen kann:',
              'whatWork': 'Woran m√∂chten Sie heute arbeiten?',
              'learnWords': 'Neue W√∂rter und Phrasen lernen',
              'masterGrammar': 'Grammatikregeln und -strukturen meistern',
              'practiceSpeak': 'Sprechen und Dialog √ºben',
              'understandTexts': 'Texte und Literatur verstehen',
              'improveWriting': 'Ihre Schreibf√§higkeiten verbessern',
              'learnCulture': 'Kultur und Br√§uche lernen'
            },
            'Polish': {
              'Vocabulary Practice': 'Praktyka S≈Çownictwa',
              'Grammar Help': 'Pomoc Gramatyczna',
              'Conversation Practice': 'Praktyka Konwersacji',
              'Reading Comprehension': 'Rozumienie Tekstu',
              'Writing Skills': 'Umiejƒôtno≈õci Pisania',
              'Cultural Insights': 'WglƒÖd Kulturowy',
              'startLearning': 'Teraz zacznijmy naukƒô! Oto kilka sposob√≥w, w jakie mogƒô pom√≥c:',
              'whatWork': 'Nad czym chcia≈Çby≈õ dzi≈õ pracowaƒá?',
              'learnWords': 'Naucz siƒô nowych s≈Ç√≥w i fraz',
              'masterGrammar': 'Opanuj zasady i struktury gramatyczne',
              'practiceSpeak': 'ƒÜwicz m√≥wienie i dialog',
              'understandTexts': 'Zrozum teksty i literaturƒô',
              'improveWriting': 'Popraw swoje umiejƒôtno≈õci pisania',
              'learnCulture': 'Poznaj kulturƒô i zwyczaje'
            },
            'Italian': {
              'Vocabulary Practice': 'Pratica del Vocabolario',
              'Grammar Help': 'Aiuto Grammaticale',
              'Conversation Practice': 'Pratica di Conversazione',
              'Reading Comprehension': 'Comprensione della Lettura',
              'Writing Skills': 'Abilit√† di Scrittura',
              'Cultural Insights': 'Approfondimenti Culturali',
              'startLearning': 'Ora iniziamo a imparare! Ecco alcuni modi in cui posso aiutare:',
              'whatWork': 'Su cosa vorresti lavorare oggi?',
              'learnWords': 'Impara nuove parole e frasi',
              'masterGrammar': 'Padroneggia regole e strutture grammaticali',
              'practiceSpeak': 'Pratica il parlato e il dialogo',
              'understandTexts': 'Comprendi testi e letteratura',
              'improveWriting': 'Migliora le tue abilit√† di scrittura',
              'learnCulture': 'Impara cultura e costumi'
            },
            'Irish': {
              'Vocabulary Practice': 'Cleachtadh St√≥r Focal',
              'Grammar Help': 'C√∫namh Gramada√≠',
              'Conversation Practice': 'Cleachtadh Comhr√°',
              'Reading Comprehension': 'Tuiscint L√©itheoireachta',
              'Writing Skills': 'Scileanna Scr√≠bhneoireachta',
              'Cultural Insights': 'L√©argais Chult√∫rtha',
              'startLearning': 'Anois tos√≥imis ag foghlaim! Seo roinnt beala√≠ inar f√©idir liom cabhr√∫ leat:',
              'whatWork': 'Ar a bhfuil fonn agat oibri√∫ inniu?',
              'learnWords': 'Foghlaim focail agus fr√°sa√≠ nua',
              'masterGrammar': 'M√°istreoidh rialacha agus strucht√∫ir gramada√≠',
              'practiceSpeak': 'Cleachtadh cainte agus idirphl√©',
              'understandTexts': 'Tuig t√©acsanna agus litr√≠ocht',
              'improveWriting': 'Feabhsaigh do chumas scr√≠bhneoireachta',
              'learnCulture': 'Foghlaim faoi chult√∫r agus n√≥sanna'
            },
            'Welsh': {
              'Vocabulary Practice': 'Ymarfer Geirfa',
              'Grammar Help': 'Help Gramadeg',
              'Conversation Practice': 'Ymarfer Sgwrs',
              'Reading Comprehension': 'Dealltwriaeth Ddarllen',
              'Writing Skills': 'Sgiliau Ysgrifennu',
              'Cultural Insights': 'Mewnwelediad Diwylliannol',
              'startLearning': 'Nawr gadewch i ni ddechrau dysgu! Dyma rai ffyrdd y gallaf eich helpu:',
              'whatWork': 'Beth hoffech chi weithio arno heddiw?',
              'learnWords': 'Dysgu geiriau a ymadroddion newydd',
              'masterGrammar': 'Meistroli rheolau a strwythurau gramadeg',
              'practiceSpeak': 'Ymarfer siarad a dialog',
              'understandTexts': 'Deall testunau a llenyddiaeth',
              'improveWriting': 'Gwella eich galluoedd ysgrifennu',
              'learnCulture': 'Dysgu am ddiwylliant ac arferion'
            },
            'Greek': {
              'Vocabulary Practice': 'ŒïŒæŒ¨œÉŒ∫Œ∑œÉŒ∑ ŒõŒµŒæŒπŒªŒøŒ≥ŒØŒøœÖ',
              'Grammar Help': 'ŒíŒøŒÆŒ∏ŒµŒπŒ± ŒìœÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆœÇ',
              'Conversation Practice': 'ŒïŒæŒ¨œÉŒ∫Œ∑œÉŒ∑ Œ£œÖŒΩŒøŒºŒπŒªŒØŒ±œÇ',
              'Reading Comprehension': 'ŒöŒ±œÑŒ±ŒΩœåŒ∑œÉŒ∑ ŒëŒΩŒ¨Œ≥ŒΩœâœÉŒ∑œÇ',
              'Writing Skills': 'ŒîŒµŒæŒπœåœÑŒ∑œÑŒµœÇ Œ£œÖŒ≥Œ≥œÅŒ±œÜŒÆœÇ',
              'Cultural Insights': 'Œ†ŒøŒªŒπœÑŒπœÉœÑŒπŒ∫Œ≠œÇ ŒëœÄœåœàŒµŒπœÇ',
              'startLearning': 'Œ§œéœÅŒ± Œ±œÇ Œ±œÅœáŒØœÉŒøœÖŒºŒµ ŒΩŒ± ŒºŒ±Œ∏Œ±ŒØŒΩŒøœÖŒºŒµ! ŒüœÅŒØœÉœÑŒµ ŒºŒµœÅŒπŒ∫ŒøŒØ œÑœÅœåœÄŒøŒπ œÄŒøœÖ ŒºœÄŒøœÅœé ŒΩŒ± œÉŒ±œÇ Œ≤ŒøŒ∑Œ∏ŒÆœÉœâ:',
              'whatWork': 'Œ£Œµ œÑŒπ Œ∏Œ± Œ∏Œ≠ŒªŒ±œÑŒµ ŒΩŒ± ŒµœÅŒ≥Œ±œÉœÑŒµŒØœÑŒµ œÉŒÆŒºŒµœÅŒ±;',
              'learnWords': 'ŒúŒ¨Œ∏ŒµœÑŒµ ŒΩŒ≠ŒµœÇ ŒªŒ≠ŒæŒµŒπœÇ Œ∫Œ±Œπ œÜœÅŒ¨œÉŒµŒπœÇ',
              'masterGrammar': 'ŒöŒ±œÑŒ±Œ∫œÑŒÆœÉœÑŒµ Œ∫Œ±ŒΩœåŒΩŒµœÇ Œ∫Œ±Œπ Œ¥ŒøŒºŒ≠œÇ Œ≥œÅŒ±ŒºŒºŒ±œÑŒπŒ∫ŒÆœÇ',
              'practiceSpeak': 'ŒïŒæŒ±œÉŒ∫Œ∑Œ∏ŒµŒØœÑŒµ œÉœÑŒ∑ŒΩ ŒøŒºŒπŒªŒØŒ± Œ∫Œ±Œπ œÑŒøŒΩ Œ¥ŒπŒ¨ŒªŒøŒ≥Œø',
              'understandTexts': 'ŒöŒ±œÑŒ±ŒΩŒøŒÆœÉœÑŒµ Œ∫ŒµŒØŒºŒµŒΩŒ± Œ∫Œ±Œπ ŒªŒøŒ≥ŒøœÑŒµœáŒΩŒØŒ±',
              'improveWriting': 'ŒíŒµŒªœÑŒπœéœÉœÑŒµ œÑŒπœÇ ŒπŒ∫Œ±ŒΩœåœÑŒ∑œÑŒµœÇ Œ≥œÅŒ±œÜŒÆœÇ œÉŒ±œÇ',
              'learnCulture': 'ŒúŒ¨Œ∏ŒµœÑŒµ Œ≥ŒπŒ± œÑŒøŒΩ œÄŒøŒªŒπœÑŒπœÉŒºœå Œ∫Œ±Œπ œÑŒ± Œ≠Œ∏ŒπŒºŒ±'
            },
            'Turkish': {
              'Vocabulary Practice': 'Kelime Pratiƒüi',
              'Grammar Help': 'Dilbilgisi Yardƒ±mƒ±',
              'Conversation Practice': 'Konu≈üma Pratiƒüi',
              'Reading Comprehension': 'Okuma Anlayƒ±≈üƒ±',
              'Writing Skills': 'Yazma Becerileri',
              'Cultural Insights': 'K√ºlt√ºrel ƒ∞√ßg√∂r√ºler',
              'startLearning': '≈ûimdi √∂ƒürenmeye ba≈ülayalƒ±m! Size yardƒ±mcƒ± olabileceƒüim bazƒ± yollar:',
              'whatWork': 'Bug√ºn ne √ºzerinde √ßalƒ±≈ümak istersiniz?',
              'learnWords': 'Yeni kelimeler ve ifadeler √∂ƒürenin',
              'masterGrammar': 'Dilbilgisi kurallarƒ± ve yapƒ±larƒ±nda ustala≈üƒ±n',
              'practiceSpeak': 'Konu≈üma ve diyalog pratiƒüi yapƒ±n',
              'understandTexts': 'Metinleri ve edebiyatƒ± anlayƒ±n',
              'improveWriting': 'Yazma yeteneklerinizi geli≈ütirin',
              'learnCulture': 'K√ºlt√ºr ve gelenekler hakkƒ±nda bilgi edinin'
            },
            'Ukrainian': {
              'Vocabulary Practice': '–ü—Ä–∞–∫—Ç–∏–∫–∞ –õ–µ–∫—Å–∏–∫–∏',
              'Grammar Help': '–î–æ–ø–æ–º–æ–≥–∞ –∑ –ì—Ä–∞–º–∞—Ç–∏–∫–∏',
              'Conversation Practice': '–ü—Ä–∞–∫—Ç–∏–∫–∞ –†–æ–∑–º–æ–≤–∏',
              'Reading Comprehension': '–†–æ–∑—É–º—ñ–Ω–Ω—è –ß–∏—Ç–∞–Ω–Ω—è',
              'Writing Skills': '–ù–∞–≤–∏—á–∫–∏ –ü–∏—Å—å–º–∞',
              'Cultural Insights': '–ö—É–ª—å—Ç—É—Ä–Ω—ñ –ü—Ä–æ–∑—Ä—ñ–Ω–Ω—è',
              'startLearning': '–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –ø–æ—á–Ω–µ–º–æ –≤—á–∏—Ç–∏—Å—è! –û—Å—å –∫—ñ–ª—å–∫–∞ —Å–ø–æ—Å–æ–±—ñ–≤, —è–∫–∏–º–∏ —è –º–æ–∂—É –≤–∞–º –¥–æ–ø–æ–º–æ–≥—Ç–∏:',
              'whatWork': '–ù–∞–¥ —á–∏–º –≤–∏ —Ö–æ—Ç—ñ–ª–∏ –± –ø–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ?',
              'learnWords': '–í–∏–≤—á–∞–π—Ç–µ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞ —Ç–∞ —Ñ—Ä–∞–∑–∏',
              'masterGrammar': '–û–ø–∞–Ω–æ–≤—É–π—Ç–µ –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏',
              'practiceSpeak': '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –¥—ñ–∞–ª–æ–≥',
              'understandTexts': '–†–æ–∑—É–º—ñ–π—Ç–µ —Ç–µ–∫—Å—Ç–∏ —Ç–∞ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä—É',
              'improveWriting': '–ü–æ–∫—Ä–∞—â—É–π—Ç–µ —Å–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏ –ø–∏—Å—å–º–∞',
              'learnCulture': '–í–∏–≤—á–∞–π—Ç–µ –∫—É–ª—å—Ç—É—Ä—É —Ç–∞ –∑–≤–∏—á–∞—ó'
            },
            'Mandarin Chinese': {
              'Vocabulary Practice': 'ËØçÊ±áÁªÉ‰π†',
              'Grammar Help': 'ËØ≠Ê≥ïÂ∏ÆÂä©',
              'Conversation Practice': 'ÂØπËØùÁªÉ‰π†',
              'Reading Comprehension': 'ÈòÖËØªÁêÜËß£',
              'Writing Skills': 'ÂÜô‰ΩúÊäÄËÉΩ',
              'Cultural Insights': 'ÊñáÂåñËßÅËß£',
              'startLearning': 'Áé∞Âú®ËÆ©Êàë‰ª¨ÂºÄÂßãÂ≠¶‰π†ÔºÅ‰ª•‰∏ãÊòØÊàëÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÁöÑÂá†ÁßçÊñπÂºèÔºö',
              'whatWork': 'ÊÇ®‰ªäÂ§©ÊÉ≥Â≠¶‰π†‰ªÄ‰πàÂÜÖÂÆπÔºü',
              'learnWords': 'Â≠¶‰π†Êñ∞ÂçïËØçÂíåÁü≠ËØ≠',
              'masterGrammar': 'ÊéåÊè°ËØ≠Ê≥ïËßÑÂàôÂíåÁªìÊûÑ',
              'practiceSpeak': 'ÁªÉ‰π†Âè£ËØ≠ÂíåÂØπËØù',
              'understandTexts': 'ÁêÜËß£ÊñáÊú¨ÂíåÊñáÂ≠¶',
              'improveWriting': 'ÊèêÈ´òÂÜô‰ΩúËÉΩÂäõ',
              'learnCulture': '‰∫ÜËß£ÊñáÂåñÂíå‰π†‰øó'
            },
            'Arabic': {
              'Vocabulary Practice': 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖŸÅÿ±ÿØÿßÿ™',
              'Grammar Help': 'ŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑŸÜÿ≠Ÿà',
              'Conversation Practice': 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©',
              'Reading Comprehension': 'ŸÅŸáŸÖ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©',
              'Writing Skills': 'ŸÖŸáÿßÿ±ÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©',
              'Cultural Insights': 'ŸÜÿ∏ÿ±ÿßÿ™ ÿ´ŸÇÿßŸÅŸäÿ©',
              'startLearning': 'ÿßŸÑÿ¢ŸÜ ÿØÿπŸàŸÜÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ™ÿπŸÑŸÖ! ÿ•ŸÑŸäŸÉ ÿ®ÿπÿ∂ ÿßŸÑÿ∑ÿ±ŸÇ ÿßŸÑÿ™Ÿä ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿ®Ÿáÿß:',
              'whatWork': 'ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ™ŸàÿØ ÿßŸÑÿπŸÖŸÑ ÿπŸÑŸäŸá ÿßŸÑŸäŸàŸÖÿü',
              'learnWords': 'ÿ™ÿπŸÑŸÖ ŸÉŸÑŸÖÿßÿ™ Ÿàÿπÿ®ÿßÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©',
              'masterGrammar': 'ÿ•ÿ™ŸÇÿßŸÜ ŸÇŸàÿßÿπÿØ ÿßŸÑŸÜÿ≠Ÿà ŸàÿßŸÑŸáŸäÿßŸÉŸÑ',
              'practiceSpeak': 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑÿ™ÿ≠ÿØÿ´ ŸàÿßŸÑÿ≠Ÿàÿßÿ±',
              'understandTexts': 'ŸÅŸáŸÖ ÿßŸÑŸÜÿµŸàÿµ ŸàÿßŸÑÿ£ÿØÿ®',
              'improveWriting': 'ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÇÿØÿ±ÿßÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©',
              'learnCulture': 'ÿ™ÿπŸÑŸÖ ÿßŸÑÿ´ŸÇÿßŸÅÿ© ŸàÿßŸÑÿπÿßÿØÿßÿ™'
            }
          };
          
          const options = languageOptions[targetLanguage] || languageOptions['Italian'];
          
          // Provide direct table response - exactly like AthroCymraeg
          const responseContent = `| **English** | **${targetLanguage}** |
|-------------|------------|
| Now let's start learning! Here are some ways I can help: | ${options['startLearning']} |
| What would you like to work on today? | ${options['whatWork']} |
|  |  |
| **[Vocabulary Practice]** | **[${options['Vocabulary Practice']}]** |
| Learn new words and phrases | ${options['learnWords']} |
| **[Grammar Help]** | **[${options['Grammar Help']}]** |
| Master grammar rules and structures | ${options['masterGrammar']} |
| **[Conversation Practice]** | **[${options['Conversation Practice']}]** |
| Practice speaking and dialogue | ${options['practiceSpeak']} |
| **[Reading Comprehension]** | **[${options['Reading Comprehension']}]** |
| Understand texts and literature | ${options['understandTexts']} |
| **[Writing Skills]** | **[${options['Writing Skills']}]** |
| Improve your writing abilities | ${options['improveWriting']} |
| **[Cultural Insights]** | **[${options['Cultural Insights']}]** |
| Learn about culture and customs | ${options['learnCulture']} |`;
          
          // Add both messages directly and return early
          const userMsg: ChatMessage = { role: 'user', content: userMessage };
          const assistantMsg: ChatMessage = { role: 'assistant', content: responseContent };
          setMessages(prev => [...prev, userMsg, assistantMsg]);
          return;
        default:
          // Handle any option that wasn't explicitly defined above
          // Create a contextual prompt based on the option name
          userMessage = `Please help me with "${option}". Focus specifically on this aspect and provide detailed insights.`;
          break;
        }
      }
      
      // üß∞ TOOL DETECTION: Check if this option should open a UI tool instead of sending a message
      const toolMappings: Record<string, string> = {
        'Use Notes Tool': 'Notes',
        'Notes Tool': 'Notes',
        'Open Notes': 'Notes',
        'Start a New Note': 'Notes',
        'Title Your Note': 'Notes',
        'Input Information': 'Notes',
        'Organize with Headers': 'Notes',
        'List Important Points': 'Notes',
        'Save Regularly': 'Notes',
        'Retrieve Your Notes': 'Notes',
        'Search Functionality': 'Notes',
        'Linking Between Notes': 'Notes',
        'Regular Review': 'Notes',
        'Update Notes': 'Notes',
        'Use Flashcards Tool': 'Flashcards',
        'Flashcards Tool': 'Flashcards',
        'Open Flashcards': 'Flashcards',
        'Create Flashcard': 'Flashcards',
        'Use Mind Map Tool': 'Mind Map',
        'Mind Map Tool': 'Mind Map',
        'Open Mind Map': 'Mind Map',
        'Create Mind Map': 'Mind Map'
      };
      
      // Check if this option maps to a tool
      const toolToOpen = toolMappings[option.trim()];
      if (toolToOpen) {
        console.log(`[ChatInterface] Tool detected: ${option} -> ${toolToOpen}`);
        openTool(toolToOpen);
        return; // Don't process as a normal message
      }
      
      if (!userMessage) return;
      
      // Create user message
      const userMsg: ChatMessage = { role: 'user', content: userMessage };
      
      // Get AI response with streaming
      if (chatService.current) {
        try {
          // Create abort controller for this request
          const abortController = new AbortController();
          setCurrentAbortController(abortController);

          setIsTyping(prev => ({
            ...prev,
            [athro.id]: true
          }));
          
          // Add user message and placeholder for assistant response in one atomic update
          setMessages(prev => [
            ...prev,
            userMsg,
            { role: 'assistant' as const, content: '' } // Placeholder for streaming
          ]);
          
          setIsStreaming(prev => ({
            ...prev,
            [athro.id]: true
          }));
          setStreamingContent(prev => ({
            ...prev,
            [athro.id]: ''
          }));
          
          // Prepare messages for API call (without the placeholder)
          const messagesForAPI = await new Promise<ChatMessage[]>((resolve) => {
            setMessages(prev => {
              const apiMessages = [...prev.slice(0, -1)]; // Remove placeholder
              resolve(apiMessages);
              return prev; // Keep current state
            });
          });
          
          const context = `athroId: ${athro.id}`;
          
          // Use streaming API with abort controller
          const streamingResponse = await chatService.current.sendMessageStream(
            messagesForAPI, 
            context,
            (chunk: string) => {
              setStreamingContent(prev => ({
                ...prev,
                [athro.id]: chunk
              }));
              // Update the placeholder message with streaming content
              setMessages(prev => {
                const newMessages = [...prev];
                if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                  newMessages[newMessages.length - 1] = { 
                    role: 'assistant' as const, 
                    content: chunk 
                  };
                }
                return newMessages;
              });
              
              // Auto-scroll to follow the streaming text
              setTimeout(() => {
                if (messagesContainerRef.current) {
                  messagesContainerRef.current.scrollTo({
                    top: messagesContainerRef.current.scrollHeight,
                    behavior: 'smooth'
                  });
                }
              }, 10); // Small delay to ensure DOM update
            },
            abortController
          );
          
          if (streamingResponse.error && streamingResponse.error !== 'Request was aborted') {
            throw new Error(streamingResponse.error);
          }
          
          // Finalize the message only if not aborted
          if (streamingResponse.content && streamingResponse.isComplete) {
            const assistantMsg: ChatMessage = { role: 'assistant', content: streamingResponse.content };
            setMessages(prev => {
              const newMessages = [...prev];
              if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                newMessages[newMessages.length - 1] = assistantMsg;
              }
              return newMessages;
            });
            
            // Check if the response contains flashcard content and offer to save
            offerFlashcardSave(streamingResponse.content);
          }
        } catch (error: any) {
          console.error('Error getting response:', error);
          
          // Don't show error if it was intentionally aborted
          if (error.name !== 'AbortError') {
            const errorMsg: ChatMessage = {
              role: 'assistant',
              content: '‚ö†Ô∏è I apologize, but I encountered an error. Please try again or type your question directly.'
            };
            setMessages(prev => {
              const newMessages = [...prev];
              if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant' && newMessages[newMessages.length - 1].content === '') {
                // Replace placeholder with error message
                newMessages[newMessages.length - 1] = errorMsg;
              } else {
                // Add error message
                newMessages.push(errorMsg);
              }
              return newMessages;
            });
          }
        } finally {
          setIsTyping(prev => ({
            ...prev,
            [athro.id]: false
          }));
          setIsStreaming(prev => ({
            ...prev,
            [athro.id]: false
          }));
          setStreamingContent(prev => ({
            ...prev,
            [athro.id]: ''
          }));
          setCurrentAbortController(null);
          isProcessingClickRef.current = false;
        }
      }
    } finally {
      isProcessingClickRef.current = false;
    }
  };

  // Extract clickable options from response messages - INCLUDING numbered options
  const extractClickableOptions = (content: string): Array<{option: string, description: string}> => {
    const options: Array<{option: string, description: string}> = [];
    
    // üéØ EXTRACT OPTIONS: Look for specific actionable patterns only
    // Use priority system to avoid duplicates
    
    let match;
    let foundPattern = false;
    
    // PRIORITY 1: Bracketed numbered options [1], [2], [3], [4] - highest priority
    const numberedBracketRegex = /\[(\d+)\]\s*([^\[\n\r]+)/g;
    const bracketMatches = [...content.matchAll(numberedBracketRegex)];
    
    if (bracketMatches.length >= 2) {
      foundPattern = true;
      bracketMatches.slice(0, 4).forEach(([, number, description]) => {
        let cleanDesc = description.trim()
          .replace(/\*\*/g, '') // Remove ** formatting
          .replace(/\s*\|\s*\*\*.*$/g, '') // Remove trailing |** stuff
          .replace(/^-\s*/, '') // Remove leading dash
          .replace(/\[[\d]+\]/g, '') // Remove any remaining [1], [2] etc.
          .split(/\s*\|\s*/)[0]; // Take only first part before |
        
        // Additional cleanup for any remaining artifacts
        cleanDesc = cleanDesc
          .replace(/^\s*[-\s]*/, '') // Remove leading dashes/spaces
          .replace(/\s*$/, '') // Remove trailing spaces
          .trim();
        
        if (cleanDesc && cleanDesc.length > 3) {
          options.push({
            option: cleanDesc,
            description: 'Click to continue'
          });
        }
      });
    }
    
    // PRIORITY 2: Clean ** Text ** - Description format (only if no bracketed options found)
    if (!foundPattern) {
      const studyOptionRegex = /\*\*\s*([^*\n\r]+?)\s*\*\*\s*-\s*([^\n\r]+)/g;
      const studyMatches = [...content.matchAll(studyOptionRegex)];
      
      if (studyMatches.length >= 2) {
        foundPattern = true;
        studyMatches.slice(0, 4).forEach(([, optionText, description]) => {
          const cleanOption = optionText.trim();
          const cleanDesc = description.trim()
            .replace(/\*\*/g, '')
            .split(/\s*\|\s*/)[0]; // Take only first part before |
            
          if (!cleanOption.includes('Upload') && 
              !cleanOption.includes('Resources') && 
              !cleanOption.includes('Look to') &&
              !cleanOption.includes('sidebar') &&
              cleanOption.length > 3 && 
              cleanOption.length < 50) {
            options.push({
              option: cleanOption,
              description: cleanDesc
            });
          }
        });
      }
    }
    
    // PRIORITY 2B: Plain Text - Description format (common pattern)
    if (!foundPattern) {
      const plainOptionRegex = /^([A-Z][^-\n\r]{2,40})\s*-\s*([^\n\r]+)/gm;
      const plainMatches = [...content.matchAll(plainOptionRegex)];
      
      // Filter to only include lines that look like options (not random text)
      const validMatches = plainMatches.filter(([, optionText]) => {
        const text = optionText.trim();
        
        // Allow common testing options even if they contain "I'll"
        const isTestingOption = [
          'Create Quiz', 'Practice Problems', 'Concept Check', 'Flashcard Review',
          'Mock Exam', 'Random Questions', 'Study Plan', 'Note-taking Tips',
          'Exam Prep', 'Learning Strategies', 'Motivation', 'Career Guidance',
          'Time Management', 'Vocabulary Practice', 'Grammar Help', 'Conversation Practice',
          'Reading Comprehension', 'Writing Skills', 'Cultural Insights'
        ].some(option => text.startsWith(option));
        
        if (isTestingOption) return true;
        
        // For non-testing options, apply stricter filters
        return !text.includes('Upload') && 
               !text.includes('Resources') && 
               !text.includes('Look to') &&
               !text.includes('sidebar') &&
               !text.includes('I\'ll') &&
               !text.includes('We can') &&
               text.length > 3 && 
               text.length < 50 &&
               /^[A-Z]/.test(text); // Must start with capital letter
      });
      
      if (validMatches.length >= 2) {
        foundPattern = true;
        validMatches.slice(0, 4).forEach(([, optionText, description]) => {
          const cleanOption = optionText.trim();
          const cleanDesc = description.trim();
          
          options.push({
            option: cleanOption,
            description: cleanDesc
          });
        });
      }
    }
    
    // PRIORITY 3: Language selection options (only if no other patterns found)
    if (!foundPattern) {
      const languageOptionRegex = /\[(English Only|Arabic Only|Side by Side|English only|Arabic only|Welsh only|Cymraeg yn unig|Saesneg yn unig|Ochor yn ochor)\]/g;
      while ((match = languageOptionRegex.exec(content)) !== null) {
        const optionText = match[1];
        options.push({
          option: optionText, // NO BRACKETS in the final option
          description: 'Select this communication style'
        });
        foundPattern = true;
      }
    }
    
    // PRIORITY 4: Specific language names for selection
    if (!foundPattern && (content.includes('First, let\'s choose your target language:') || content.includes('Choose your preferred conversation style!'))) {
      const specificLanguageRegex = /\[(French|German|Spanish|Italian|Irish|Polish|Welsh|Greek|Turkish|Ukrainian|Mandarin Chinese|Arabic)\]/g;
      while ((match = specificLanguageRegex.exec(content)) !== null) {
        const languageName = match[1];
        options.push({
          option: languageName, // NO BRACKETS
          description: `Study in ${languageName}`
        });
        foundPattern = true;
      }
    }
    
    // PRIORITY 5: Welcome action buttons (only for initial session setup)
    if (!foundPattern && content.includes('I\'m your') && content.includes('tutor')) {
      const actionButtonRegex = /\*\*\[(Upload|Create|Test|Discuss|Other)\s*([^\]]*)\]\*\*/g;
      while ((match = actionButtonRegex.exec(content)) !== null) {
        const [, action, detail] = match;
        const fullAction = detail ? `${action} ${detail}` : action;
        options.push({
          option: fullAction,
          description: `Get help with ${action.toLowerCase()}`
        });
        foundPattern = true;
      }
    }
    
    // Limit to 4 options maximum and filter out any remaining malformed options
    return options
      .filter(opt => opt.option.length > 1 && opt.option.length < 100 && !opt.option.includes('|'))
      .slice(0, 4);
  };

  // Function to generate structured flashcard content
  const generateStructuredFlashcardContent = (flashcards: Array<{title: string, front: string, back: string}>) => {
    let content = `üíæ **Flashcard Content Ready to Copy!**\n\nHere are your flashcards in a structured format. You can copy and paste these details into the Flashcards section in your study tools sidebar:\n\n`;
    
    flashcards.forEach((card, index) => {
      // Limit front and back to 200 characters each
      const truncatedFront = card.front.length > 200 ? card.front.substring(0, 200) + '...' : card.front;
      const truncatedBack = card.back.length > 200 ? card.back.substring(0, 200) + '...' : card.back;
      
      content += `üìù **Flashcard ${index + 1}: ${card.title}**\n**Front:** ${truncatedFront}\n**Back:** ${truncatedBack}\n\n`;
    });
    
    content += `üí° **Instructions:**\n\n1. **Copy the content above** - Select all the flashcard content from "üìù Flashcard 1" onwards\n2. **Open your Flashcards section** - Click on the Flashcards tab in your study tools sidebar\n3. **Paste and create** - Paste the content and use the "Create Flashcard" feature to add them to your study collection\n4. **Review regularly** - Set reminders and review these flashcards to reinforce your learning\n\nüéØ **Tip:** You can review these anytime and set reminders for when you should review them!`;
    
    return content;
  };

  // Function to detect flashcard content in messages
  const detectFlashcardContent = (content: string): {
    front: string;
    back: string;
    topic: string;
  } | null => {
    // Simple and robust pattern that catches the interactive quiz format
    // This pattern looks for: Flashcard #X: followed by question, then any content, then "Correct Answer:"
    const interactivePattern = /Flashcard\s*#\d+:\s*\n\n(.*?)\n\n.*?\n\n.*?\n\n.*?\n\n(.*?)\n\nCorrect Answer:\.?\s*(.*?)(?=\n\n|Would you like|Next question|$)/s;
    
    const match = content.match(interactivePattern);
    if (match) {
      const [, question, feedback, correctAnswer] = match;
      
      // Extract a meaningful title from the question (first 6 words)
      const questionWords = question.trim().split(' ');
      let title = questionWords.length > 0 ? questionWords.slice(0, 6).join(' ') : 'Flashcard Question';
      if (questionWords.length > 6) title += '...';
      
      return {
        front: question.trim(),
        back: `${feedback.trim()}\n\nCorrect Answer: ${correctAnswer.trim()}`,
        topic: title
      };
    }

    // Alternative pattern that's even more flexible
    const flexiblePattern = /Flashcard\s*#\d+:\s*\n\n(.*?)\n\n.*?\n\n.*?\n\n.*?\n\n(.*?)\n\nCorrect Answer[:\s]*(.*?)(?=\n\n|Would you like|Next question|$)/s;
    
    const flexibleMatch = content.match(flexiblePattern);
    if (flexibleMatch) {
      const [, question, feedback, correctAnswer] = flexibleMatch;
      
      // Extract a meaningful title from the question (first 6 words)
      const questionWords = question.trim().split(' ');
      let title = questionWords.length > 0 ? questionWords.slice(0, 6).join(' ') : 'Flashcard Question';
      if (questionWords.length > 6) title += '...';
      
      return {
        front: question.trim(),
        back: `${feedback.trim()}\n\nCorrect Answer: ${correctAnswer.trim()}`,
        topic: title
      };
    }

    // Pattern for direct flashcard format: "Flashcard X: Front: ... Back: ..."
    const directFlashcardPattern = /Flashcard\s*\d+:\s*\n\nFront:\s*(.*?)\n\nBack:\s*(.*?)(?=\n\n|What's your answer|Would you like|Next question|$)/s;
    
    const directMatch = content.match(directFlashcardPattern);
    if (directMatch) {
      const [, front, back] = directMatch;
      
      // Extract a meaningful title from the front content
      const frontWords = front.trim().split(' ');
      let title = frontWords.length > 0 ? frontWords.slice(0, 6).join(' ') : 'Flashcard Question';
      if (frontWords.length > 6) title += '...';
      
      return {
        front: front.trim(),
        back: back.trim(),
        topic: title
      };
    }

    // Fallback patterns for other formats
    const patterns = [
      // Pattern 1: "Flashcard X:" followed by Term/Description and Your Task with feedback
      /Flashcard\s*\d+:\s*\n(?:Term|Description):\s*"([^"]+)"\s*\n\s*Your Task:\s*(.*?)\n.*?‚úÖ\s*Feedback:\s*(.*?)(?=\n\n|Flashcard|\\nGreat work!|\\nAbsolutely,|$)/s,
      // Pattern 2: "üìñ Flashcard X" followed by question and answer with "Your turn:" and "‚úÖ Correct!"
      /üìñ\s*Flashcard\s*\d+\s*\n(.*?)\n.*?Your turn:\s*(.*?)\n.*?‚úÖ\s*Correct!.*?\n(.*?)(?=\n\n|Flashcard|\\nGreat work!|\\nAbsolutely,|$)/s,
      // Pattern 3: "Flashcard X Front: ... Back: ..." format
      /Flashcard\s*\d+\s*\nFront:\s*(.*?)\nBack:\s*(.*?)(?=\n\n|Flashcard|\\nThese flashcards cover|\\nWould you like to explore|$)/s
    ];

    for (const pattern of patterns) {
      const match = content.match(pattern);
      if (match) {
        if (pattern.source.includes('Front:') && pattern.source.includes('Back:')) {
          // Completed flashcard format
          const [, front, back] = match;
          const frontWords = front.trim().split(' ');
          let title = frontWords.length > 0 ? frontWords.slice(0, 6).join(' ') : 'Flashcard';
          if (frontWords.length > 6) title += '...';
          
          return {
            front: front.trim(),
            back: back.trim(),
            topic: title
          };
        } else {
          // Other patterns
          const [, question, feedback, correctAnswer] = match;
          const questionWords = question.trim().split(' ');
          let title = questionWords.length > 0 ? questionWords.slice(0, 6).join(' ') : 'Flashcard Question';
          if (questionWords.length > 6) title += '...';
          
          return {
            front: question.trim(),
            back: `${feedback.trim()}\n\nCorrect Answer: ${correctAnswer.trim()}`,
            topic: title
          };
        }
      }
    }

    // Special pattern for the feedback-based flashcards with multiple cards
    const multiCardPattern = /Flashcard\s*\d+:\s*\n(?:Term|Description):\s*"([^"]+)"\s*\n\s*Your Task:\s*(.*?)\n.*?‚úÖ\s*Feedback:\s*(.*?)(?=\n\n|Flashcard|\\nGreat work!|\\nAbsolutely,|$)/gs;
    const multiCardMatches = [...content.matchAll(multiCardPattern)];
    
    if (multiCardMatches.length > 0) {
      // Use the first match for now (we could extend this to handle multiple cards)
      const [, term, task, feedback] = multiCardMatches[0];
      return {
        front: `Term: "${term}"\nYour Task: ${task.trim()}`,
        back: feedback.trim(),
        topic: athro.subject
      };
    }

    return null;
  };

  // Function to handle flashcard save
  const handleFlashcardSave = async () => {
    if (!flashcardToSave) return;

    try {
      const sessionId = currentSessionId || 'temp-session';
      await SupabaseStudyService.createFlashcard({
        athroId: athro.id,
        subject: athro.subject,
        topic: flashcardSaveTitle || flashcardToSave.topic,
        front: flashcardSaveFront || flashcardToSave.front,
        back: flashcardSaveBack || flashcardToSave.back
      }, sessionId);

      // Add success message
      const successMsg: ChatMessage = {
        role: 'assistant',
        content: `‚úÖ **Flashcard saved successfully!**\n\nYour flashcard has been added to your study tools. You can find it in the Flashcards section of the sidebar.\n\nüí° **Tip:** You can review your flashcards anytime by opening the Flashcards tab in the study tools panel.`
      };

      setMessages(prev => [...prev, successMsg]);
      setShowFlashcardSave(false);
      setFlashcardToSave(null);
      setFlashcardSaveTitle('');
      setFlashcardSaveFront('');
      setFlashcardSaveBack('');
    } catch (error) {
      console.error('Error saving flashcard:', error);
      const errorMsg: ChatMessage = {
        role: 'assistant',
        content: `‚ö†Ô∏è **Error saving flashcard**\n\nThere was an error saving your flashcard. Please try again or manually create it in the Flashcards section.`
      };
      setMessages(prev => [...prev, errorMsg]);
    }
  };

  // Function to detect multiple flashcards in a session
  const detectMultipleFlashcards = (content: string): Array<{title: string, front: string, back: string}> => {
    const flashcards: Array<{title: string, front: string, back: string}> = [];
    
    // Pattern for multiple flashcards with feedback
    const multiCardPattern = /Flashcard\s*\d+:\s*\n(?:Term|Description):\s*"([^"]+)"\s*\n\s*Your Task:\s*(.*?)\n.*?‚úÖ\s*Feedback:\s*(.*?)(?=\n\n|Flashcard|\\nGreat work!|\\nAbsolutely,|$)/gs;
    const multiCardMatches = [...content.matchAll(multiCardPattern)];
    
    if (multiCardMatches.length > 1) {
      multiCardMatches.forEach((match, index) => {
        const [, term, task, feedback] = match;
        // Use the term as the title if available, otherwise fallback to first 8 words of the task
        let title = term && term.trim() ? term.trim() : (task.trim().split(' ').slice(0, 8).join(' ') + (task.trim().split(' ').length > 8 ? '...' : ''));
        flashcards.push({
          title,
          front: `Term: "${term}"
Your Task: ${task.trim()}`,
          back: feedback.trim()
        });
      });
    }
    
    // Pattern for completed flashcard sets (like the example you showed)
    const completedSetPattern = /Flashcard\s*(\d+)\s*\nFront:\s*(.*?)\nBack:\s*(.*?)(?=\n\n|Flashcard|\\nThese flashcards cover|\\nWould you like to explore|$)/gs;
    const completedSetMatches = [...content.matchAll(completedSetPattern)];
    
    if (completedSetMatches.length > 0) {
      completedSetMatches.forEach((match, index) => {
        const [, cardNumber, front, back] = match;
        // Extract a meaningful title from the front content
        const frontWords = front.trim().split(' ');
        let title = frontWords.length > 0 ? frontWords.slice(0, 6).join(' ') : `Flashcard ${cardNumber}`;
        if (frontWords.length > 6) title += '...';
        
        flashcards.push({
          title,
          front: front.trim(),
          back: back.trim()
        });
      });
    }
    
    // Pattern for interactive quiz format - each question-answer-feedback cycle
    const interactivePattern = /(?:Flashcard\s*\d+:\s*)?(.*?)\n.*?(?:Your turn:|What is your answer?|Please answer:)\s*(.*?)\n.*?(?:‚úÖ\s*Correct!|‚úÖ\s*Feedback:|Great answer!|Good job!)\s*(.*?)(?=\n\n|Flashcard|\nLet's move on|\nNext question|\n$)/gs;
    const interactiveMatches = [...content.matchAll(interactivePattern)];
    
    if (interactiveMatches.length > 0) {
      interactiveMatches.forEach((match, index) => {
        const [, question, studentAnswer, feedback] = match;
        // Extract a meaningful title from the question
        const questionWords = question.trim().split(' ');
        let title = questionWords.length > 0 ? questionWords.slice(0, 6).join(' ') : `Question ${index + 1}`;
        if (questionWords.length > 6) title += '...';
        
        flashcards.push({
          title,
          front: question.trim(),
          back: feedback.trim()
        });
      });
    }
    
    // Pattern for interactive quiz format with "Flashcard #X:" structure
    const interactiveQuizPattern = /Flashcard\s*#?\d+:\s*\n\n(.*?)\n\n(?:Take a moment|Think about|Type your answer).*?\n\n.*?\n\n(?:Feedback:|You're on the right track|Great answer!|Good job!)\s*(.*?)\n\n(?:Correct Answer:|The correct answer is:)\s*(.*?)(?=\n\n|Would you like to try|Let's move on|Next question|$)/gs;
    const interactiveQuizMatches = [...content.matchAll(interactiveQuizPattern)];
    
    if (interactiveQuizMatches.length > 0) {
      interactiveQuizMatches.forEach((match, index) => {
        const [, question, feedback, correctAnswer] = match;
        // Extract a meaningful title from the question
        const questionWords = question.trim().split(' ');
        let title = questionWords.length > 0 ? questionWords.slice(0, 6).join(' ') : `Question ${index + 1}`;
        if (questionWords.length > 6) title += '...';
        
        flashcards.push({
          title,
          front: question.trim(),
          back: `${feedback.trim()}\n\nCorrect Answer: ${correctAnswer.trim()}`
        });
      });
    }
    
    // Pattern for the actual interactive format being used with 4 capture groups
    const actualInteractivePattern = /Flashcard\s*#\d+:\s*\n\n(.*?)\n\n(?:Think about|Take a moment).*?\n\n.*?\n\n(?:You're absolutely right|Great job!|Good answer!|Excellent!)\s*(.*?)\n\n(?:Feedback:|Your answer)\s*(.*?)\n\n(?:Correct Answer:|The correct answer is:)\s*(.*?)(?=\n\n|Would you like to go on|Next question|$)/gs;
    const actualInteractiveMatches = [...content.matchAll(actualInteractivePattern)];
    
    if (actualInteractiveMatches.length > 0) {
      actualInteractiveMatches.forEach((match, index) => {
        const [, question, positiveFeedback, detailedFeedback, correctAnswer] = match;
        // Extract a meaningful title from the question
        const questionWords = question.trim().split(' ');
        let title = questionWords.length > 0 ? questionWords.slice(0, 6).join(' ') : `Question ${index + 1}`;
        if (questionWords.length > 6) title += '...';
        
        flashcards.push({
          title,
          front: question.trim(),
          back: `${positiveFeedback.trim()}\n\n${detailedFeedback.trim()}\n\nCorrect Answer: ${correctAnswer.trim()}`
        });
      });
    }
    
    return flashcards;
  };

  // Function to offer flashcard save - ONLY for actual flashcard content
  const offerFlashcardSave = (content: string) => {
    // ONLY offer flashcard save if we explicitly detect actual flashcard content
    // Do NOT auto-trigger for general educational content
    const flashcardData = detectFlashcardContent(content);
    const multipleFlashcards = detectMultipleFlashcards(content);
    
    // Only proceed if we have ACTUAL flashcard content
    if (multipleFlashcards.length > 1) {
      // Handle multiple flashcards
      const structuredContent = generateStructuredFlashcardContent(multipleFlashcards);
      const multiCardMsg: ChatMessage = {
        role: 'assistant',
        content: structuredContent
      };
      
      setMessages(prev => [...prev, multiCardMsg]);
    } else if (flashcardData) {
      setFlashcardToSave(flashcardData);
      setFlashcardSaveTitle(flashcardData.topic);
      setFlashcardSaveFront(flashcardData.front);
      setFlashcardSaveBack(flashcardData.back);
      setShowFlashcardSave(true);
      
      // Add informational message about the save feature with structured format
      const infoMsg: ChatMessage = {
        role: 'assistant',
        content: `üíæ **Flashcard Detected!**\n\nI noticed you just reviewed a flashcard. Here's the content in a structured format that you can copy and paste into your study tools:\n\n**Title:** ${flashcardData.topic}\n**Front:** ${flashcardData.front.length > 200 ? flashcardData.front.substring(0, 200) + '...' : flashcardData.front}\n**Back:** ${flashcardData.back.length > 200 ? flashcardData.back.substring(0, 200) + '...' : flashcardData.back}\n\nüí° **Tip:** You can copy these details and paste them into the Flashcards section in your study tools sidebar. You can review them anytime and set reminders for when you should review them!`
      };
      
      setMessages(prev => [...prev, infoMsg]);
    }
    
    // Check for flashcard review session explanations - ONLY when explicitly about flashcards
    const flashcardSessionPatterns = [
      /Flashcard Review Session Explained/i,
      /Flashcard Review Explained/i,
      /how do flashcard sessions work/i,
      /flashcard sessions are a fantastic way/i,
      /üåü Flashcard Review Explained/i,
      /üí° Flashcard Review Explained/i
    ];
    
    const isFlashcardSessionExplanation = flashcardSessionPatterns.some(pattern => pattern.test(content));
    
    // Only add the session format message if the original content doesn't already include format information
    const alreadyHasFormatInfo = content.includes('Flashcard Session Format') || 
                                content.includes('üíæ Flashcard Session Format') ||
                                content.includes('structured format') ||
                                content.includes('Title: [Topic Name]') ||
                                content.includes('Front: [Question/Term]') ||
                                content.includes('Back: [Answer/Definition]') ||
                                content.includes('üíæ Ready to start?') ||
                                content.includes('Ready to start? Just let me know what topic you\'d like to focus on!') ||
                                content.includes('_____') ||
                                content.includes('üíæ **Flashcard Session Format**') ||
                                content.includes('When we do flashcard sessions, I\'ll provide the content in this structured format:') ||
                                content.includes('You can then copy and paste these details into the Flashcards section');
    
    if (isFlashcardSessionExplanation && !alreadyHasFormatInfo) {
      const sessionInfoMsg: ChatMessage = {
        role: 'assistant',
        content: `üíæ **Flashcard Session Format**\n\nWhen we do flashcard sessions, I'll provide the content in this structured format:\n\n**Title:** [Topic Name]\n**Front:** [Question/Term]\n**Back:** [Answer/Definition]\n\nYou can then copy and paste these details into the Flashcards section in your study tools sidebar. You can review them anytime and set reminders for when you should review them!\n\nüí° **Ready to start?** Just let me know what topic you'd like to focus on!`
      };
      
      setMessages(prev => [...prev, sessionInfoMsg]);
    }
    
    // ONLY check for explicit user requests to save flashcards - be much more restrictive
    const explicitSaveRequestPatterns = [
      /\bsave (?:this|these) (?:flashcard|flashcards)\b/i,
      /\bsave (?:the|my) flashcard/i,
      /\bcan i save (?:this|these) flashcard/i
    ];
    
    const isExplicitSaveRequest = explicitSaveRequestPatterns.some(pattern => pattern.test(content));
    
    // ONLY respond to explicit save requests when there's no flashcard data and no session explanation
    if (isExplicitSaveRequest && !flashcardData && !isFlashcardSessionExplanation && multipleFlashcards.length === 0) {
      // If user is explicitly asking to save but we didn't detect flashcard content, offer help
      const helpMsg: ChatMessage = {
        role: 'assistant',
        content: `üíæ **Save Flashcards**\n\nI can help you save flashcards to your study tools! When I present flashcards in our chat, I'll automatically provide them in a structured format:\n\n**Title:** [Topic Name]\n**Front:** [Question/Term]\n**Back:** [Answer/Definition]\n\nYou can then copy and paste these details into the Flashcards section in your study tools sidebar. You can review them anytime and set reminders for when you should review them!\n\nüí° **Tip:** You can also manually create flashcards in the Flashcards section of the sidebar anytime.`
      };
      
      setMessages(prev => [...prev, helpMsg]);
    }
  };

  const handleSaveSession = () => {
    if (onSaveSession) {
      onSaveSession();
    } else {
      // Fallback to internal handler if no prop provided
      // Check if there's an actual conversation (more than just welcome message)
      const userMessages = messages.filter(m => m.role === 'user');
      
      if (userMessages.length === 0) {
        showError('Nothing to Save', 'Start a conversation first before saving!', 4000);
        return;
      }
      
      // Save current session and create new one
      const saveSession = async () => {
        try {
          const newSession = await ChatSessionService.archiveAndCreateNewSession(athro.id, messages);
          setCurrentSession(newSession);
          
          // Clear messages and add full welcome message with options
          const athroPersonality = ATHRO_PERSONALITIES[athro.id];
          const subject = athroPersonality?.subject || athro.subject || 'General';
          
          let welcomeContent = '';
          
          // Special welcome message for AthroLanguages
          if (athro.id === 'athro-languages') {
            welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${athro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you!\n\nüåç **First, let's choose your target language:**\n\n**[French]** Fran√ßais\n**[German]** Deutsch\n**[Spanish]** Espa√±ol\n**[Italian]** Italiano\n**[Irish]** Gaeilge\n**[Polish]** Polski\n**[Welsh]** Cymraeg\n**[Greek]** ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨\n**[Turkish]** T√ºrk√ße\n**[Ukrainian]** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n**[Mandarin Chinese]** ‰∏≠Êñá\n**[Arabic]** ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\n\nClick on the language you're studying, and I'll customize everything for you!`;
          } else {
            // Standard welcome message for other athros
            welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${athro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you. Here are some options to get started:\n\n**[1] üìÅ Upload Resources** - Share homework, questions, or study materials\n**[2] üí¨ Discuss Something** - Ask about topics, concepts, or problems\n**[3] üß† Test Your Knowledge** - Practice with quizzes and exercises\n**[4] üåü Something Else** - Study planning, tips, or other help\n\nClick any option above to get started, or just type your question below!`;
          }
          
          const welcomeMessage: ChatMessage = {
            role: 'assistant',
            content: welcomeContent
          };
          setMessages([welcomeMessage]);
          
          // Show success notification instead of alert
          showSuccess('Session Saved', 'Starting fresh with a new conversation', 3000);
        } catch (error) {
          console.error('Error saving session:', error);
          showError('Save Failed', 'Could not save session. Please try again.', 5000);
        }
      };
      saveSession();
    }
  };

  const handleDeleteSession = () => {
    if (onDeleteSession) {
      onDeleteSession();
    } else {
      // Enhanced delete functionality that works for any session state
      // No confirmation needed - delete should be immediate and reversible via backup
      const deleteSession = async () => {
        try {
          const newSession = await ChatSessionService.deleteAndCreateNewSession(athro.id);
          setCurrentSession(newSession);
          
          // Clear all messages and state
          setMessages([]);
          setUsedResources([]);
          setInputValue('');
          
          // Clear any streaming states
          setIsTyping({});
          setIsStreaming({});
          setStreamingContent({});
          
          // Create fresh welcome message
          const athroPersonality = ATHRO_PERSONALITIES[athro.id];
          const subject = athroPersonality?.subject || athro.subject || 'General';
          
          let welcomeContent = '';
          
          // Special welcome message for AthroLanguages
          if (athro.id === 'athro-languages') {
            welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${athro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you!\n\nüåç **First, let's choose your target language:**\n\n**[French]** Fran√ßais\n**[German]** Deutsch\n**[Spanish]** Espa√±ol\n**[Italian]** Italiano\n**[Irish]** Gaeilge\n**[Polish]** Polski\n**[Welsh]** Cymraeg\n**[Greek]** ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨\n**[Turkish]** T√ºrk√ße\n**[Ukrainian]** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n**[Mandarin Chinese]** ‰∏≠Êñá\n**[Arabic]** ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\n\nClick on the language you're studying, and I'll customize everything for you!`;
          } else if (athro.id === 'athro-welsh') {
            // Special welcome message for AthroCymraeg with Welsh greeting and language options
            welcomeContent = `Shwmae! Sut hoffech chi gyfathrebu?\n\nHow would you like to communicate?\n\n**[Saesneg yn unig - English only]** - All responses in English\n**[Cymraeg yn unig - Welsh only]** - All responses in Welsh\n**[Ochor yn ochor - Side by Side]** - Dual columns with English and Welsh together\n\nChoose your preferred conversation style!`;
          } else {
            // Standard welcome message for other athros
            welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${athro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you. Here are some options to get started:\n\n**[1] üìÅ Upload Resources** - Share homework, questions, or study materials\n**[2] üí¨ Discuss Something** - Ask about topics, concepts, or problems\n**[3] üß† Test Your Knowledge** - Practice with quizzes and exercises\n**[4] üåü Something Else** - Study planning, tips, or other help\n\nClick any option above to get started, or just type your question below!`;
          }
          
          const welcomeMessage: ChatMessage = {
            role: 'assistant',
            content: welcomeContent
          };
          
          setMessages([welcomeMessage]);
          
          // Clear study tools in the sidebar
          window.dispatchEvent(new CustomEvent('clearStudyTools'));
          
          // Scroll to top of messages
          setTimeout(() => {
            if (messagesEndRef.current) {
              messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }
          }, 100);
          
          // Show success notification instead of alert
          showSuccess('Chat Deleted', 'Session cleared and restarted fresh', 3000);
        } catch (error) {
          console.error('Error deleting session:', error);
          // Show error notification instead of alert
          showError('Delete Failed', 'Could not delete session. Please try again.', 5000);
        }
      };
      deleteSession();
    }
  };

  const handleViewHistory = () => {
    console.log('[ChatInterface] handleViewHistory called, onViewHistory prop:', !!onViewHistory);
    if (onViewHistory) {
      console.log('[ChatInterface] Calling prop onViewHistory');
      onViewHistory();
    } else {
      // Fallback to internal handler if no prop provided
      console.log('[ChatInterface] No prop onViewHistory, using internal setIsHistoryOpen');
      setIsHistoryOpen(true);
    }
  };

  // üß∞ TOOL OPENER: Function to open specific sidebar tools from chat cards
  const openTool = (toolName: string) => {
    console.log(`[ChatInterface] Opening tool: ${toolName}`);
    
    // Set the trigger state to communicate with SidePanel
    setTriggerToolOpen({
      tool: toolName,
      timestamp: Date.now()
    });
    
    // Show success notification
    showSuccess(`Opening ${toolName}`, `${toolName} section is now active in the sidebar`, 2000);
    
    // Close mobile sidebar if open (for mobile users)
    if (showMobileSidebar) {
      setShowMobileSidebar(false);
    }
  };



  // Memoize the session action handlers to prevent infinite loops
  const handleSaveSessionCallback = useCallback(() => {
    handleSaveSession();
  }, []);

  const handleDeleteSessionCallback = useCallback(() => {
    handleDeleteSession();
  }, []);

  const handleViewHistoryCallback = useCallback(() => {
    handleViewHistory();
  }, []);

  // Handle session actions from WorkPage
  useEffect(() => {
    if (sessionAction && onSessionActionComplete) {
      switch (sessionAction) {
        case 'save':
          handleSaveSessionCallback();
          break;
        case 'delete':
          handleDeleteSessionCallback();
          break;
        case 'history':
          handleViewHistoryCallback();
          break;
      }
      onSessionActionComplete();
    }
  }, [sessionAction, onSessionActionComplete]); // Removed callback functions since they have empty dependencies

  // Event handlers
  const handleSessionCreated = useCallback((e: CustomEvent) => {
    console.log('[ChatInterface] Session created event received:', e.detail);
    if (e.detail?.athroId === athroRef.current.id) {
      console.log('[ChatInterface] Session created for this athro, clearing current session');
      setCurrentSession(null);
      setMessages([]);
      
      // Re-initialize session
      sessionInitialized.current.delete(athroRef.current.id);
    }
  }, []); // Stable with ref usage
  
  const handleSessionDeleted = useCallback(() => {
    console.log('[ChatInterface] Session deleted event received');
    // Clear current session if it's deleted
    setCurrentSession(null);
    setMessages([]);
    
    // Re-initialize session
    sessionInitialized.current.delete(athroRef.current.id);
  }, []); // Stable
  
  const handleLoadSessionTools = useCallback((e: CustomEvent) => {
    console.log('[ChatInterface] Load session tools event received:', e.detail);
    if (e.detail?.athroId === athroRef.current.id) {
      console.log('[ChatInterface] Loading session tools for this athro');
      // Handle loading session tools
    }
  }, []); // Stable with ref usage
  
  const handleLoadSessionContent = useCallback(async (e: any) => {
    console.log('[ChatInterface] Load session content event received:', e.detail);
    if (e.detail?.sessionId && e.detail?.sessionData && e.detail?.athroId === athroRef.current.id) {
      console.log('[ChatInterface] Loading session content with full restore');
      
      const { sessionData, sessionId } = e.detail;
      
      try {
        // 1. Restore ALL original messages exactly as they were
        console.log(`[ChatInterface] Restoring ${sessionData.messages?.length || 0} messages`);
        if (sessionData.messages && Array.isArray(sessionData.messages)) {
          setMessages(sessionData.messages);
          messagesRef.current = sessionData.messages;
        }
        
        // 2. Set the current session to the loaded session
        const restoredSession = {
          id: sessionId,
          athroId: athroRef.current.id,
          messages: sessionData.messages || [],
          createdAt: sessionData.createdAt || Date.now(),
          updatedAt: Date.now(),
          isActive: true
        };
        setCurrentSession(restoredSession);
        currentSessionRef.current = restoredSession;
        
        // 3. Notify sidebar to load ALL associated study tools and resources
        console.log('[ChatInterface] Notifying sidebar to load session tools and resources');
        
        // Clear existing tools first
        window.dispatchEvent(new CustomEvent('clearStudyTools'));
        
        // Load session-specific tools and resources
        window.dispatchEvent(new CustomEvent('loadSessionTools', {
          detail: {
            sessionId,
            athroId: athroRef.current.id,
            resources: sessionData.resources || [],
            mindMaps: sessionData.mindMaps || [],
            notes: sessionData.notes || [],
            flashcards: sessionData.flashcards || []
          }
        }));
        
        // 4. Update the ChatSessionService to reflect the loaded session
        await ChatSessionService.saveActiveSession(athroRef.current.id, sessionData.messages || []);
        
        console.log('[ChatInterface] Session content fully restored:', {
          sessionId,
          messageCount: sessionData.messages?.length || 0,
          resourceCount: sessionData.resources?.length || 0,
          mindMapCount: sessionData.mindMaps?.length || 0,
          noteCount: sessionData.notes?.length || 0,
          flashcardCount: sessionData.flashcards?.length || 0
        });
        
        // 5. Scroll to bottom to show the conversation
        setTimeout(() => {
          scrollToLastAIResponse();
        }, 100);
        
      } catch (error) {
        console.error('[ChatInterface] Error loading session content:', error);
      }
    }
  }, []); // Stable with ref usage
  
  const handleRequestChatMessages = useCallback(() => {
    console.log('[ChatInterface] Chat messages requested, sending current messages');
    window.dispatchEvent(new CustomEvent('returnChatMessages', {
      detail: {
        athroId: athroRef.current.id,
        messages: messagesRef.current,
        sessionId: currentSessionRef.current?.id
      }
    }));
  }, []); // Stable with ref usage
  
  const handleSessionSaved = useCallback(() => {
    console.log('[ChatInterface] Session saved event received');
    // Session was saved, might want to refresh UI
  }, []);
  
  const handleClearSpecificAthroSession = useCallback((e: any) => {
    console.log('[ChatInterface] Clear specific athro session:', e.detail);
    if (e.detail?.athroId === athroRef.current.id) {
      console.log('[ChatInterface] Clearing session for this athro');
      setCurrentSession(null);
      sessionInitialized.current.delete(athroRef.current.id);
      
      // CRITICAL FIX: Immediately create new welcome message after clearing
      const currentAthro = athroRef.current;
      const athroPersonality = ATHRO_PERSONALITIES[currentAthro.id];
      const subject = athroPersonality?.subject || currentAthro.subject || 'General';
      
      let welcomeContent = '';
      
      // Special welcome message for AthroLanguages
      if (currentAthro.id === 'athro-languages') {
        welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${currentAthro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you!\n\nüåç **First, let's choose your target language:**\n\n**[French]** Fran√ßais\n**[German]** Deutsch\n**[Spanish]** Espa√±ol\n**[Italian]** Italiano\n**[Irish]** Gaeilge\n**[Polish]** Polski\n**[Welsh]** Cymraeg\n**[Greek]** ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨\n**[Turkish]** T√ºrk√ße\n**[Ukrainian]** –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞\n**[Mandarin Chinese]** ‰∏≠Êñá\n**[Arabic]** ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\n\nClick on the language you're studying, and I'll customize everything for you!`;
      } else if (currentAthro.id === 'athro-welsh') {
        // Special welcome message for AthroCymraeg with Welsh greeting and language options
        welcomeContent = `Shwmae! Sut hoffech chi gyfathrebu?\n\nHow would you like to communicate?\n\n**[Saesneg yn unig - English only]** - All responses in English\n**[Cymraeg yn unig - Welsh only]** - All responses in Welsh\n**[Ochor yn ochor - Side by Side]** - Dual columns with English and Welsh together\n\nChoose your preferred conversation style!`;
      } else {
        // Standard welcome message for other athros
        welcomeContent = `Hi${userPreferredName ? ` ${userPreferredName}` : ''}! **${currentAthro.name}** here to help! üéì\n\nI'm your ${subject} tutor and I'm excited to work with you. Here are some options to get started:\n\n**[1] üìÅ Upload Resources** - Share homework, questions, or study materials\n**[2] üí¨ Discuss Something** - Ask about topics, concepts, or problems\n**[3] üß† Test Your Knowledge** - Practice with quizzes and exercises\n**[4] üåü Something Else** - Study planning, tips, or other help\n\nClick any option above to get started, or just type your question below!`;
      }
      
      const welcomeMessage: ChatMessage = {
        role: 'assistant',
        content: welcomeContent
      };
      
      const newMessages = [welcomeMessage];
      setMessages(newMessages);
      
      // Create and save new session
      ChatSessionService.saveActiveSession(currentAthro.id, newMessages).then(newSession => {
        setCurrentSession(newSession);
        console.log('[ChatInterface] Created new session after clear:', newSession.id);
      }).catch(error => {
        console.error('[ChatInterface] Error creating session after clear:', error);
      });
    }
  }, [userPreferredName]); // Stable with ref usage

  useEffect(() => {
    window.addEventListener('sessionCreated', handleSessionCreated as EventListener);
    window.addEventListener('sessionDeleted', handleSessionDeleted);
    window.addEventListener('loadSessionTools', handleLoadSessionTools as EventListener);
    window.addEventListener('loadSessionContent', handleLoadSessionContent as unknown as EventListener);
    window.addEventListener('requestChatMessages', handleRequestChatMessages);
    window.addEventListener('sessionSaved', handleSessionSaved);
    window.addEventListener('clearSpecificAthroSession', handleClearSpecificAthroSession);

    return () => {
      window.removeEventListener('sessionCreated', handleSessionCreated as EventListener);
      window.removeEventListener('sessionDeleted', handleSessionDeleted);
      window.removeEventListener('loadSessionTools', handleLoadSessionTools as EventListener);
      window.removeEventListener('loadSessionContent', handleLoadSessionContent as unknown as EventListener);
      window.removeEventListener('requestChatMessages', handleRequestChatMessages);
      window.removeEventListener('sessionSaved', handleSessionSaved);
      window.removeEventListener('clearSpecificAthroSession', handleClearSpecificAthroSession);
    };
  }, []); // CRITICAL FIX: Empty dependency array to prevent infinite loops

  // Update refs whenever state changes
  useEffect(() => {
    messagesRef.current = messages;
  }, [messages]);

  useEffect(() => {
    currentSessionRef.current = currentSession;
  }, [currentSession]);

  // Update athro ref when athro changes to prevent infinite loops
  useEffect(() => {
    athroRef.current = athro;
  }, [athro]);

  return (
    <div style={{ 
      height: '100%', 
      display: 'flex', 
      flexDirection: 'column',
      position: 'relative',
      overflow: 'hidden'
    }}>
      {/* ‚ö° PERFORMANCE: Loading overlay for perfect UX */}
      {renderLoadingOverlay()}
      
      <style>
        {`
          @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
          }
          
          @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
          }
          
          .chat-ul, .chat-ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
          }
          
          .chat-li {
            margin: 0.25rem 0;
            line-height: 1.5;
          }
          
          .chat-strong {
            font-weight: 600;
            color: #4fc38a;
          }
          
          .chat-em {
            font-style: italic;
            color: #e4c97e;
          }
          
          .chat-h1, .chat-h2, .chat-h3 {
            margin: 1rem 0 0.5rem 0;
            color: #4fc38a;
            font-weight: 600;
          }
          
          .chat-h1 {
            font-size: 1.4rem;
            border-bottom: 2px solid #4fc38a;
            padding-bottom: 0.25rem;
          }
          
          .chat-h2 {
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(79, 195, 138, 0.3);
            padding-bottom: 0.2rem;
          }
          
          .chat-h3 {
            font-size: 1.1rem;
          }
          
          .chat-blockquote {
            border-left: 3px solid #4fc38a;
            margin: 0.5rem 0;
            padding: 0.5rem 1rem;
            background: rgba(79, 195, 138, 0.1);
            border-radius: 0.25rem;
          }
          
          .chat-code-block {
            background: rgba(22, 34, 28, 0.8);
            border: 1px solid #4fc38a;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            overflow: hidden;
          }
          
          .chat-code-header {
            background: #4fc38a;
            color: #17221c;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
          }
          
          .chat-code-block pre {
            margin: 0;
            padding: 0.5rem;
            overflow-x: auto;
          }
          
          .chat-code-block code {
            color: #e4c97e;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
          }
          
          .chat-inline-code {
            background: rgba(79, 195, 138, 0.2);
            border: 1px solid rgba(79, 195, 138, 0.3);
            border-radius: 0.25rem;
            padding: 0.1rem 0.3rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            color: #4fc38a;
          }
          
          .bilingual-option:hover {
            background: rgba(79, 195, 138, 0.3) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(79, 195, 138, 0.3);
          }
          
          .bilingual-option:active {
            transform: translateY(0);
            background: rgba(79, 195, 138, 0.4) !important;
          }
          
          /* Mobile-specific styles */
          @media (max-width: 768px) {
            .welcome-option-button {
              padding: 0.6rem !important;
              font-size: 0.85rem !important;
            }
            
            .welcome-option-title {
              font-size: 0.9rem !important;
            }
            
            .welcome-option-desc {
              font-size: 0.8rem !important;
            }
            
            .welcome-options-grid {
              gap: 0.5rem !important;
            }
            
            .bilingual-option {
              padding: 0.5rem !important;
              font-size: 0.85rem !important;
            }
          }
        `}
      </style>
      
      {/* Chat Area - Fixed height, scrollable content */}
      <div style={{
        flex: 1,
        display: 'flex',
        position: 'relative',
        overflow: 'hidden',
        minHeight: 0 /* Important: allows flex item to shrink */
      }}>
        {/* Main Chat Area */}
        <div style={{
          flex: 1,
          display: 'flex',
          flexDirection: 'column',
          position: 'relative',
          height: '100%',
          marginRight: needsSidebarButton ? '-300px' : '10px' /* Responsive margin */
        }}>


          {/* Messages container - Scrollable */}
          <div
            ref={messagesContainerRef}
            className="messages-container"
            style={{
              flex: 1,
              overflowY: 'auto',
              padding: needsSidebarButton ? '0.5rem' : '1rem', /* Mobile/Tablet: minimal padding for maximum message width */
              display: 'flex',
              flexDirection: 'column',
              gap: needsSidebarButton ? '0.5rem' : '1rem', /* Mobile/Tablet: smaller gap */
              boxSizing: 'border-box',
              minHeight: 0 /* Important: allows flex item to shrink */
            }}
          >
            {messages.map((message, index) => {
              const messageKey = `${index}-${message.role}`;
              // REMOVED: Translation-related variables that were causing infinite loops
              
              // Check if this is the last assistant message being streamed
              const isLastAssistantMessage = message.role === 'assistant' && index === messages.length - 1;
              const hasStreamingContent = isLastAssistantMessage && streamingContent[athro.id];
              
              // Use streaming content if available, otherwise use message content
              const displayContent = hasStreamingContent ? streamingContent[athro.id] : message.content;
              
              // Check if this is a welcome message with options
              const isWelcomeMessage = index === 0 && message.role === 'assistant' && 
                ((displayContent.includes('[1]') && displayContent.includes('[2]') && 
                  displayContent.includes('[3]') && displayContent.includes('[4]')) ||
                 (displayContent.includes('[French]') && displayContent.includes('[German]') && 
                  displayContent.includes('[Spanish]')) ||
                 (displayContent.includes('**[Saesneg yn unig') && displayContent.includes('**[Cymraeg yn unig')));
              
              // Check if this is a bilingual dual-column message (should NOT extract cards)
              const isBilingualMessage = message.role === 'assistant' && 
                ((displayContent.includes('| **English** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Welsh** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **French** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **German** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Spanish** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Italian** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Polish** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Greek** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Turkish** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Ukrainian** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Mandarin Chinese** |') && displayContent.includes('|---|---|')) ||
                 (displayContent.includes('| **Arabic** |') && displayContent.includes('|---|---|')) ||
                 // Also detect by the presence of dual column table structure with multiple rows
                 (displayContent.includes('|') && displayContent.includes('|---|---|') && displayContent.split('|').length > 10) ||
                 // Additional checks for bilingual content patterns - Welsh
                 (displayContent.includes('Dysgu geiriau a ymadroddion newydd') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Nawr gadewch i ni ddechrau dysgu') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - French
                 (displayContent.includes('Apprendre de nouveaux mots et phrases') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Maintenant, commen√ßons √† apprendre !') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - German
                 (displayContent.includes('Neue W√∂rter und Phrasen lernen') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Lassen Sie uns jetzt mit dem Lernen beginnen!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Spanish
                 (displayContent.includes('Aprender nuevas palabras y frases') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('¬°Ahora empezamos a aprender!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Italian
                 (displayContent.includes('Imparare nuove parole e frasi') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Ora iniziamo ad imparare!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Polish
                 (displayContent.includes('Uczyƒá siƒô nowych s≈Ç√≥w i fraz') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Teraz zaczynamy siƒô uczyƒá!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Greek
                 (displayContent.includes('ŒúŒ¨Œ∏ŒµœÑŒµ ŒΩŒ≠ŒµœÇ ŒªŒ≠ŒæŒµŒπœÇ Œ∫Œ±Œπ œÜœÅŒ¨œÉŒµŒπœÇ') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Œ§œéœÅŒ± Œ±œÇ Œ±œÅœáŒØœÉŒøœÖŒºŒµ ŒΩŒ± ŒºŒ±Œ∏Œ±ŒØŒΩŒøœÖŒºŒµ!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Turkish
                 (displayContent.includes('Yeni kelimeler ve ifadeler √∂ƒürenin') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('≈ûimdi √∂ƒürenmeye ba≈ülayalƒ±m!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Ukrainian
                 (displayContent.includes('–í–∏–≤—á–∞–π—Ç–µ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞ —Ç–∞ —Ñ—Ä–∞–∑–∏') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –ø–æ—á–Ω–µ–º–æ –≤—á–∏—Ç–∏—Å—è!') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Mandarin Chinese
                 (displayContent.includes('Â≠¶‰π†Êñ∞ÂçïËØçÂíåÁü≠ËØ≠') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('Áé∞Âú®ËÆ©Êàë‰ª¨ÂºÄÂßãÂ≠¶‰π†ÔºÅ') && displayContent.includes('Now let\'s start learning')) ||
                 // Additional checks for bilingual content patterns - Arabic
                 (displayContent.includes('ÿ™ÿπŸÑŸÖ ŸÉŸÑŸÖÿßÿ™ Ÿàÿπÿ®ÿßÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©') && displayContent.includes('Learn new words and phrases')) ||
                 (displayContent.includes('ÿßŸÑÿ¢ŸÜ ÿØÿπŸàŸÜÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ™ÿπŸÑŸÖ!') && displayContent.includes('Now let\'s start learning')));
              
              // Debug bilingual detection
              if (message.role === 'assistant' && displayContent.includes('Vocabulary Practice')) {
                console.log('üîç BILINGUAL DEBUG - Card content detected:', {
                  isBilingualMessage,
                  hasEnglishHeader: displayContent.includes('| **English** |'),
                  hasTableSeparator: displayContent.includes('|---|---|'),
                  hasWelshContent: displayContent.includes('Dysgu geiriau a ymadroddion newydd'),
                  hasFrenchContent: displayContent.includes('Apprendre de nouveaux mots et phrases'),
                  hasGermanContent: displayContent.includes('Neue W√∂rter und Phrasen lernen'),
                  hasSpanishContent: displayContent.includes('Aprender nuevas palabras y frases'),
                  contentStart: displayContent.substring(0, 200) + '...'
                });
              }
              
              // Check if this is a response message with clickable options (but NOT bilingual)
              // Use the same flexible approach as extractClickableOptions
              const hasClickableOptions = message.role === 'assistant' && !isBilingualMessage &&
                extractClickableOptions(displayContent).length > 0;
              
              return (
                <div
                  key={index}
                  style={{
                    alignSelf: message.role === 'user' ? 'flex-end' : 'flex-start',
                    width: needsSidebarButton 
                      ? '100%' /* Mobile/Tablet: force full width for maximum readability */
                      : (message.role === 'user' ? '70%' : '90%'), /* Desktop: controlled width */
                    maxWidth: needsSidebarButton 
                      ? '100%' /* Mobile/Tablet: completely fill available space */
                      : (message.role === 'user' ? '70%' : '90%'), /* Desktop: controlled max width */
                    padding: needsSidebarButton ? '1rem' : '1rem', /* Mobile/Tablet: generous padding for readability */
                    background: message.role === 'user' ? '#e4c97e' : 'rgba(79, 195, 138, 0.15)',
                    color: message.role === 'user' ? '#17221c' : '#e4c97e',
                    borderRadius: '1rem',
                    margin: '0.5rem 0',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                    border: message.role === 'assistant' ? '2px solid rgba(79, 195, 138, 0.3)' : 'none',
                    fontSize: needsSidebarButton ? '1rem' : '1rem', /* Mobile/Tablet: normal font size for readability */
                    lineHeight: '1.6', /* Better line spacing for mobile readability */
                    wordBreak: 'break-word', /* Ensure long words break properly on mobile */
                    boxSizing: 'border-box' /* Include padding in width calculation */
                  }}
                >
                  {/* Add streaming indicator for actively streaming messages */}
                  {hasStreamingContent && (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      marginBottom: '0.5rem',
                      fontSize: '0.8rem',
                      color: '#4fc38a',
                      opacity: 0.8
                    }}>
                      <div style={{
                        width: '6px',
                        height: '6px',
                        borderRadius: '50%',
                        background: '#4fc38a',
                        animation: 'pulse 1s ease-in-out infinite'
                      }} />
                      Streaming response...
                    </div>
                  )}
                  
                  {isWelcomeMessage ? (
                    <div style={{ lineHeight: '1.6' }}>
                      {/* Check if this is language selection for athro-languages */}
                      {(() => {
                        console.log('üöÄ RENDER DEBUG ALL CONTENT:', displayContent.substring(0, 100) + '...');
                        console.log('üöÄ Contains Shwmae?', displayContent.includes('Shwmae'));
                        console.log('üöÄ Contains French?', displayContent.includes('[French]'));
                        console.log('üöÄ Contains German?', displayContent.includes('[German]'));
                        console.log('üöÄ Contains **[Saesneg?', displayContent.includes('**[Saesneg yn unig'));
                        
                        if (displayContent.includes('Shwmae') || displayContent.includes('AthroCymraeg')) {
                          console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WELSH DEBUG:', displayContent);
                          console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Contains **[Saesneg:', displayContent.includes('**[Saesneg yn unig'));
                          console.log('üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Contains **[Cymraeg:', displayContent.includes('**[Cymraeg yn unig'));
                        }
                        return displayContent.includes('[French]') && displayContent.includes('[German]');
                      })() ? (
                        <div>
                          {/* Render welcome message text without language options */}
                          <div
                            dangerouslySetInnerHTML={{ 
                              __html: renderMessage(displayContent.replace(/\*\*\[French\].*?\*\*.*?\n\*\*\[German\].*?\*\*.*?\n\*\*\[Spanish\].*?\*\*.*?\n\*\*\[Italian\].*?\*\*.*?\n\*\*\[Polish\].*?\*\*.*?\n\*\*\[Greek\].*?\*\*.*?\n\*\*\[Turkish\].*?\*\*.*?\n\*\*\[Ukrainian\].*?\*\*.*?\n\*\*\[Mandarin Chinese\].*?\*\*.*?\n\*\*\[Arabic\].*?\*\*.*?\n\nClick on the language you're studying, and I'll customize everything for you!/s, ''))
                            }}
                          />
                          
                          {/* Render language selection cards */}
                          <div style={{ marginTop: '1rem' }}>
                            <div className="welcome-options-grid">
                              {[
                                { key: 'French', text: 'French', native: 'Fran√ßais' },
                                { key: 'German', text: 'German', native: 'Deutsch' },
                                { key: 'Spanish', text: 'Spanish', native: 'Espa√±ol' },
                                { key: 'Italian', text: 'Italian', native: 'Italiano' },
                                { key: 'Irish', text: 'Irish', native: 'Gaeilge' },
                                { key: 'Polish', text: 'Polish', native: 'Polski' },
                                { key: 'Welsh', text: 'Welsh', native: 'Cymraeg' },
                                { key: 'Greek', text: 'Greek', native: 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨' },
                                { key: 'Turkish', text: 'Turkish', native: 'T√ºrk√ße' },
                                { key: 'Ukrainian', text: 'Ukrainian', native: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' },
                                { key: 'Mandarin Chinese', text: 'Mandarin Chinese', native: '‰∏≠Êñá' },
                                { key: 'Arabic', text: 'Arabic', native: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' }
                              ].map((language) => (
                                <button
                                  key={language.key}
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    handleWelcomeOptionClick(language.key, index);
                                  }}
                                  className="welcome-option-button"
                                  disabled={isTyping[athro.id] || false}
                                >
                                  <div className="welcome-option-title">
                                    {language.text}
                                  </div>
                                  <div className="welcome-option-desc">
                                    {language.native}
                                  </div>
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      ) : displayContent.includes('**[Saesneg yn unig') && displayContent.includes('**[Cymraeg yn unig') ? (
                        <div>
                          {/* Render Welsh welcome message text without language options */}
                          <div
                            dangerouslySetInnerHTML={{ 
                              __html: renderMessage(displayContent.replace(/\*\*\[Saesneg yn unig.*?\].*?\n\*\*\[Cymraeg yn unig.*?\].*?\n\*\*\[Ochor yn ochor.*?\].*?\n\nChoose your preferred conversation style!/s, ''))
                            }}
                          />
                          
                          {/* Render Welsh language communication options cards */}
                          <div style={{ marginTop: '1rem' }}>
                            <div className="welcome-options-grid">
                              {[
                                { key: 'Saesneg yn unig - English only', text: 'Saesneg yn unig', desc: 'English only - All responses in English' },
                                { key: 'Cymraeg yn unig - Welsh only', text: 'Cymraeg yn unig', desc: 'Welsh only - All responses in Welsh' },
                                { key: 'Ochor yn ochor - Side by Side', text: 'Ochor yn ochor', desc: 'Side by Side - Dual columns with English and Welsh together' }
                              ].map((option) => (
                                <button
                                  key={option.key}
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    handleWelcomeOptionClick(option.key, index);
                                  }}
                                  className="welcome-option-button"
                                  disabled={isTyping[athro.id] || false}
                                >
                                  <div className="welcome-option-title">
                                    {option.text}
                                  </div>
                                  <div className="welcome-option-desc">
                                    {option.desc}
                                  </div>
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div>
                          {/* Render standard welcome message text without options */}
                          <div
                            dangerouslySetInnerHTML={{ 
                              __html: renderMessage(displayContent.replace(/\*\*\[1\].*?\*\*.*?\n\*\*\[2\].*?\*\*.*?\n\*\*\[3\].*?\*\*.*?\n\*\*\[4\].*?\*\*.*?\n\nClick any option above to get started, or just type your question below!/s, ''))
                            }}
                          />
                          
                          {/* Render standard interactive options */}
                          <div style={{ marginTop: '1rem' }}>
                            <div className="welcome-options-grid">
                              {[
                                { key: 'upload', text: 'üìÅ Upload Resources', desc: 'Share homework, questions, or study materials' },
                                { key: 'discuss', text: 'üí¨ Discuss Something', desc: 'Ask about topics, concepts, or problems' },
                                { key: 'test', text: 'üß† Test Your Knowledge', desc: 'Practice with quizzes and exercises' },
                                { key: 'other', text: 'üåü Something Else', desc: 'Study planning, tips, or other help' }
                              ].map((option) => (
                                <button
                                  key={option.key}
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    handleWelcomeOptionClick(option.key, index);
                                  }}
                                  className="welcome-option-button"
                                  disabled={isTyping[athro.id] || false}
                                >
                                  <div className="welcome-option-title">
                                    {option.text}
                                  </div>
                                  <div className="welcome-option-desc">
                                    {option.desc}
                                  </div>
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ) : hasClickableOptions ? (
                    <div style={{ lineHeight: '1.6' }}>
                      {/* Render response message text without options */}
                      <div
                        dangerouslySetInnerHTML={{ 
                          __html: renderMessage(
                            displayContent
                              // Remove Quick Actions sections
                              .replace(/\*\*Quick Actions:\*\*[\s\S]*?‚Ä¢ \[.*?\][\s\S]*?‚Ä¢ \[.*?\][\s\S]*?‚Ä¢ \[.*?\][\s\S]*?‚Ä¢ \[.*?\][\s\S]*?/g, '')
                              // Remove individual bracketed options that are rendered as buttons
                              .replace(/\*\*\[([^\]]+)\]\*\*[^\n]*/g, '')  // Remove **[Option]** - description
                              .replace(/\[([^\]]+)\]/g, '')  // Remove remaining [Option] text
                              // Clean up any extra line breaks or spacing
                              .replace(/\n{3,}/g, '\n\n')
                              .trim()
                          )
                        }}
                      />
                      
                      {/* Render clickable options from response */}
                      <div style={{ marginTop: '1rem' }}>
                        <div className="welcome-options-grid">
                          {extractClickableOptions(displayContent).map((optionData, optionIndex) => (
                            <button
                              key={optionIndex}
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                handleResponseOptionClick(optionData.option, index);
                              }}
                              className="welcome-option-button"
                              disabled={isTyping[athro.id] || false}
                            >
                              <div className="welcome-option-title">
                                {optionData.option}
                              </div>
                              <div className="welcome-option-desc">
                                {optionData.description}
                              </div>
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  ) : isBilingualMessage ? (
                    // Special handling for bilingual messages with clickable options in tables
                    <div
                      dangerouslySetInnerHTML={{ 
                        __html: renderMessage(displayContent).replace(
                          /\[([^\]]+)\]/g, 
                          '<span class="bilingual-option" data-option="$1" data-index="' + index + '" style="background: rgba(79, 195, 138, 0.2); color: #4fc38a; padding: 4px 8px; border-radius: 6px; cursor: pointer; border: 1px solid #4fc38a; display: inline-block; margin: 2px; transition: all 0.2s ease; font-weight: 500;">$1</span>'
                        )
                      }}
                      style={{ 
                        lineHeight: '1.6',
                        // Add cursor for streaming effect
                        ...(hasStreamingContent && {
                          position: 'relative'
                        })
                      }}
                      onClick={(e) => {
                        const target = e.target as HTMLElement;
                        if (target.classList.contains('bilingual-option')) {
                          const option = target.getAttribute('data-option');
                          const msgIndex = target.getAttribute('data-index');
                          if (option && msgIndex) {
                            handleResponseOptionClick(option, parseInt(msgIndex));
                          }
                        }
                      }}
                    />
                  ) : (
                  <div
                    dangerouslySetInnerHTML={{ __html: renderMessage(displayContent) }}
                    style={{ 
                      lineHeight: '1.6',
                      // Add cursor for streaming effect
                      ...(hasStreamingContent && {
                        position: 'relative'
                      })
                    }}
                  />
                  )}
                  
                  {/* Add "Copy" button for assistant messages */}
                  {message.role === 'assistant' && displayContent.trim() && !hasStreamingContent && (
                    <div style={{
                      marginTop: '0.75rem',
                      paddingTop: '0.75rem',
                      borderTop: '1px solid rgba(79, 195, 138, 0.2)',
                      display: 'flex',
                      gap: '0.5rem',
                      justifyContent: 'flex-end'
                    }}>
                      <button
                        onClick={(e) => {
                          // Copy to clipboard
                          navigator.clipboard.writeText(displayContent).then(() => {
                            // Show success feedback
                            const button = e.target as HTMLButtonElement;
                            const originalHTML = button.innerHTML;
                            button.innerHTML = '‚úÖ';
                            button.style.background = '#4fc38a';
                            button.style.color = 'white';
                            
                            setTimeout(() => {
                              button.innerHTML = originalHTML;
                              button.style.background = 'transparent';
                              button.style.color = '#4fc38a';
                            }, 2000);
                          }).catch(() => {
                            alert('Failed to copy to clipboard');
                          });
                        }}
                        style={{
                          padding: '0.4rem',
                          background: 'transparent',
                          border: '1px solid rgba(79, 195, 138, 0.5)',
                          borderRadius: '0.375rem',
                          color: '#4fc38a',
                          cursor: 'pointer',
                          fontSize: '0.9rem',
                          fontWeight: '500',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          transition: 'all 0.2s ease',
                          width: '32px',
                          height: '32px'
                        }}
                        onMouseEnter={(e) => {
                          const btn = e.target as HTMLButtonElement;
                          btn.style.background = 'rgba(79, 195, 138, 0.1)';
                          btn.style.borderColor = '#4fc38a';
                        }}
                        onMouseLeave={(e) => {
                          const btn = e.target as HTMLButtonElement;
                          if (!btn.innerHTML?.includes('‚úÖ')) {
                            btn.style.background = 'transparent';
                            btn.style.borderColor = 'rgba(79, 195, 138, 0.5)';
                          }
                        }}
                        title="Copy message"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                        </svg>
                      </button>
                    </div>
                  )}
                  
                  {/* Add typing cursor for streaming messages */}
                  {hasStreamingContent && (
                    <span style={{
                      display: 'inline-block',
                      width: '2px',
                      height: '1.2em',
                      background: '#4fc38a',
                      marginLeft: '2px',
                      animation: 'blink 1s step-end infinite'
                    }} />
                  )}
                  
                  {/* REMOVED: Translation toggle button that was causing infinite loops */}
                </div>
              );
            })}
            {isTyping[athro.id] && !isStreaming[athro.id] && (
              <div style={{
                alignSelf: 'flex-start',
                color: '#e4c97e',
                fontSize: '0.9rem',
                padding: '0.5rem 1rem',
                background: 'rgba(22, 34, 28, 0.8)',
                borderRadius: '0.5rem'
              }}>
                {athro.name} is typing...
              </div>
            )}
            {isStreaming[athro.id] && !streamingContent[athro.id] && (
              <div style={{
                alignSelf: 'flex-start',
                color: '#4fc38a',
                fontSize: '0.9rem',
                padding: '0.5rem 1rem',
                background: 'rgba(79, 195, 138, 0.1)',
                borderRadius: '0.5rem',
                border: '1px solid #4fc38a',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
              }}>
                <div style={{
                  width: '8px',
                  height: '8px',
                  borderRadius: '50%',
                  background: '#4fc38a',
                  animation: 'pulse 1.5s ease-in-out infinite'
                }} />
                {athro.name} is thinking...
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>
        </div>

        {/* üñ•Ô∏è DESKTOP: Side panel with study tools - only show on desktop */}
        {!needsSidebarButton && !isMobile && (
          <div style={{
          position: 'absolute',
          top: 0,
          right: 0,
          width: '320px',
          height: '100%',
          background: 'rgba(22, 34, 28, 0.9)',
          borderLeft: '2px solid #4fc38a',
          zIndex: 10,
          overflowY: 'auto',
          display: 'flex',
          flexDirection: 'column',
          boxSizing: 'border-box'
        }}>
          <SidePanel
            athroId={athro.id}
            subject={athro.subject}
            sessionId={currentSessionId}
            onSelectResource={handleSelectResource}
            onInjectText={(text) => setInputValue(text)}
            onSendMessage={(message) => {
              // Add the language request directly to the chat as a user message
              const userMessage: ChatMessage = { role: 'user', content: message };
              const updatedMessages = [...messages, userMessage];
              setMessages(updatedMessages);

              // Start typing indicator
              setIsTyping(prev => ({
                ...prev,
                [athro.id]: true
              }));

              // Process the message directly without going through input
              const processLanguageRequest = async () => {
                try {
                  if (!chatService.current) return;

                  // Create abort controller for this request
                  const abortController = new AbortController();
                  setCurrentAbortController(abortController);

                  // Send to OpenAI API with streaming
                  console.log('Processing language request via ChatService with streaming');
                  const context = `athroId: ${athro.id}`;
                  
                  // Add placeholder assistant message for streaming
                  const placeholderMessage: ChatMessage = { role: 'assistant' as const, content: '' };
                  const messagesWithPlaceholder = [...updatedMessages, placeholderMessage];
                  setMessages(messagesWithPlaceholder);
                  setIsStreaming(prev => ({
                    ...prev,
                    [athro.id]: true
                  }));
                  setStreamingContent(prev => ({
                    ...prev,
                    [athro.id]: ''
                  }));
                  
                  // Use streaming API with abort controller
                  const streamingResponse = await chatService.current.sendMessageStream(
                    updatedMessages, 
                    context,
                    (chunk: string) => {
                      setStreamingContent(prev => ({
                        ...prev,
                        [athro.id]: chunk
                      }));
                      // Update the placeholder message with streaming content
                      setMessages(prev => {
                        const newMessages = [...prev];
                        if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                          newMessages[newMessages.length - 1] = { 
                            role: 'assistant' as const, 
                            content: chunk 
                          };
                        }
                        return newMessages;
                      });
                      
                      // Auto-scroll to follow the streaming text
                      setTimeout(() => {
                        if (messagesContainerRef.current) {
                          messagesContainerRef.current.scrollTo({
                            top: messagesContainerRef.current.scrollHeight,
                            behavior: 'smooth'
                          });
                        }
                      }, 10); // Small delay to ensure DOM update
                    },
                    abortController
                  );
                  
                  console.log('Language request streaming completed');
                  
                  if (streamingResponse.error && streamingResponse.error !== 'Request was aborted') {
                    throw new Error(streamingResponse.error);
                  }
                  
                  // Finalize the message only if not aborted
                  if (streamingResponse.content && streamingResponse.isComplete) {
                    const response: ChatMessage = {
                      role: 'assistant' as const,
                      content: streamingResponse.content
                    };
                    
                    const finalMessages = [...updatedMessages, response];
                    setMessages(finalMessages);
                    
                    // Check if the response contains flashcard content and offer to save
                    offerFlashcardSave(streamingResponse.content);
                    
                    // Broadcast this message to other services
                    n8nEventService.publishEvent(EventNames.CHAT_MESSAGE_RECEIVED, {
                      athroId: athro.id,
                      message: response,
                      timestamp: new Date().toISOString()
                    });
                  }
                  
                } catch (error: any) {
                  console.error('Error processing language request:', error);
                  
                  // Don't show error if it was intentionally aborted
                  if (error.name !== 'AbortError') {
                    const errorMessage: ChatMessage = { 
                      role: 'assistant', 
                      content: `I'm sorry, I encountered an error processing your language request. Please try again.` 
                    };
                    setMessages([...updatedMessages, errorMessage]);
                  }
                } finally {
                  setIsTyping(prev => ({
                    ...prev,
                    [athro.id]: false
                  }));
                  setIsStreaming(prev => ({
                    ...prev,
                    [athro.id]: false
                  }));
                  setStreamingContent(prev => ({
                    ...prev,
                    [athro.id]: ''
                  }));
                  setCurrentAbortController(null);
                }
              };

              // Process the language request
              processLanguageRequest();
            }}
            onSaveSession={handleSaveSession}
            onDeleteSession={handleDeleteSession}
            onViewHistory={handleViewHistory}
            isCreatingSession={isCreatingSession}
            triggerToolOpen={triggerToolOpen}
          />
        </div>
        )}
      </div>

      {/* üì± MOBILE: Floating action button for tools access */}
      {isMobile && (
        <button
          onClick={() => setShowMobileSidebar(true)}
          style={{
            position: 'fixed',
            bottom: '100px',
            right: '20px',
            width: '56px',
            height: '56px',
            borderRadius: '50%',
            background: '#4fc38a',
            border: 'none',
            color: '#17221c',
            fontSize: '1.5rem',
            cursor: 'pointer',
            boxShadow: '0 4px 12px rgba(79, 195, 138, 0.4)',
            zIndex: 100,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            transition: 'all 0.3s ease'
          }}
          onMouseDown={(e) => e.currentTarget.style.transform = 'scale(0.95)'}
          onMouseUp={(e) => e.currentTarget.style.transform = 'scale(1)'}
          onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
        >
          üß∞
        </button>
      )}

      {/* üì± MOBILE: Full-screen sidebar modal */}
      {isMobile && showMobileSidebar && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          zIndex: 1000,
          display: 'flex',
          flexDirection: 'column'
        }}>
          {/* Header with close button */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            padding: '1rem',
            background: 'rgba(22, 34, 28, 0.95)',
            borderBottom: '2px solid #4fc38a'
          }}>
            <h3 style={{ color: '#4fc38a', margin: 0, fontSize: '1.2rem' }}>
              üìö Study Tools
            </h3>
            <button
              onClick={() => setShowMobileSidebar(false)}
              style={{
                background: 'transparent',
                border: '2px solid #4fc38a',
                borderRadius: '50%',
                width: '40px',
                height: '40px',
                color: '#4fc38a',
                fontSize: '1.2rem',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}
            >
              ‚úï
            </button>
          </div>
          
          {/* Sidebar content */}
          <div style={{
            flex: 1,
            background: 'rgba(22, 34, 28, 0.95)',
            overflowY: 'auto',
            padding: '0.5rem'
          }}>
            <SidePanel
              athroId={athro.id}
              subject={athro.subject}
              sessionId={currentSessionId}
              onSelectResource={(resourceId) => {
                handleSelectResource(resourceId);
                setShowMobileSidebar(false); // Close sidebar after selecting resource
              }}
              onInjectText={(text) => {
                setInputValue(text);
                setShowMobileSidebar(false); // Close sidebar after injecting text
              }}
              onSendMessage={(message) => {
                // Add the language request directly to the chat as a user message
                const userMessage: ChatMessage = { role: 'user', content: message };
                const updatedMessages = [...messages, userMessage];
                setMessages(updatedMessages);
                setShowMobileSidebar(false); // Close sidebar after sending message

                // Start typing indicator
                setIsTyping(prev => ({
                  ...prev,
                  [athro.id]: true
                }));

                // Process the message directly without going through input
                const processLanguageRequest = async () => {
                  try {
                    if (!chatService.current) return;

                    // Create abort controller for this request
                    const abortController = new AbortController();
                    setCurrentAbortController(abortController);

                    // Send to OpenAI API with streaming
                    console.log('Processing language request via ChatService with streaming');
                    const context = `athroId: ${athro.id}`;
                    
                    // Add placeholder assistant message for streaming
                    const placeholderMessage: ChatMessage = { role: 'assistant' as const, content: '' };
                    const messagesWithPlaceholder = [...updatedMessages, placeholderMessage];
                    setMessages(messagesWithPlaceholder);
                    setIsStreaming(prev => ({
                      ...prev,
                      [athro.id]: true
                    }));
                    setStreamingContent(prev => ({
                      ...prev,
                      [athro.id]: ''
                    }));
                    
                    // Use streaming API with abort controller
                    const streamingResponse = await chatService.current.sendMessageStream(
                      updatedMessages, 
                      context,
                      (chunk: string) => {
                        setStreamingContent(prev => ({
                          ...prev,
                          [athro.id]: chunk
                        }));
                        // Update the placeholder message with streaming content
                        setMessages(prev => {
                          const newMessages = [...prev];
                          if (newMessages.length > 0 && newMessages[newMessages.length - 1].role === 'assistant') {
                            newMessages[newMessages.length - 1] = { 
                              role: 'assistant' as const, 
                              content: chunk 
                            };
                          }
                          return newMessages;
                        });
                        
                        // Auto-scroll to follow the streaming text
                        setTimeout(() => {
                          if (messagesContainerRef.current) {
                            messagesContainerRef.current.scrollTo({
                              top: messagesContainerRef.current.scrollHeight,
                              behavior: 'smooth'
                            });
                          }
                        }, 10); // Small delay to ensure DOM update
                      },
                      abortController
                    );
                    
                    console.log('Language request streaming completed');
                    
                    if (streamingResponse.error && streamingResponse.error !== 'Request was aborted') {
                      throw new Error(streamingResponse.error);
                    }
                    
                    // Finalize the message only if not aborted
                    if (streamingResponse.content && streamingResponse.isComplete) {
                      const response: ChatMessage = {
                        role: 'assistant' as const,
                        content: streamingResponse.content
                      };
                      
                      const finalMessages = [...updatedMessages, response];
                      setMessages(finalMessages);
                      
                      // Check if the response contains flashcard content and offer to save
                      offerFlashcardSave(streamingResponse.content);
                      
                      // Broadcast this message to other services
                      n8nEventService.publishEvent(EventNames.CHAT_MESSAGE_RECEIVED, {
                        athroId: athro.id,
                        message: response,
                        timestamp: new Date().toISOString()
                      });
                    }
                    
                  } catch (error: any) {
                    console.error('Error processing language request:', error);
                    
                    // Don't show error if it was intentionally aborted
                    if (error.name !== 'AbortError') {
                      const errorMessage: ChatMessage = { 
                        role: 'assistant', 
                        content: `I'm sorry, I encountered an error processing your language request. Please try again.` 
                      };
                      setMessages([...updatedMessages, errorMessage]);
                    }
                  } finally {
                    setIsTyping(prev => ({
                      ...prev,
                      [athro.id]: false
                    }));
                    setIsStreaming(prev => ({
                      ...prev,
                      [athro.id]: false
                    }));
                    setStreamingContent(prev => ({
                      ...prev,
                      [athro.id]: ''
                    }));
                    setCurrentAbortController(null);
                  }
                };

                // Process the language request
                processLanguageRequest();
              }}
              onSaveSession={handleSaveSession}
              onDeleteSession={handleDeleteSession}
              onViewHistory={handleViewHistory}
              isCreatingSession={isCreatingSession}
              triggerToolOpen={triggerToolOpen}
            />
          </div>
        </div>
      )}



      {/* üì± MOBILE: Floating action button for study tools */}
      {needsSidebarButton && (
        <button
          onClick={() => setShowMobileSidebar(true)}
          style={{
            position: 'fixed',
            bottom: '100px',
            right: '15px',
            width: '56px',
            height: '56px',
            borderRadius: '50%',
            background: '#4fc38a',
            border: 'none',
            color: '#17221c',
            fontSize: '1.5rem',
            cursor: 'pointer',
            boxShadow: '0 4px 12px rgba(79, 195, 138, 0.4)',
            zIndex: 100,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            transition: 'all 0.3s ease'
          }}
          onMouseDown={(e) => {
            e.currentTarget.style.transform = 'scale(0.95)';
          }}
          onMouseUp={(e) => {
            e.currentTarget.style.transform = 'scale(1)';
          }}
          onMouseLeave={(e) => {
            e.currentTarget.style.transform = 'scale(1)';
          }}
        >
          üß∞
        </button>
      )}

      {/* üì± MOBILE: Full-screen modal for study tools */}
      {showMobileSidebar && (
        <div
          style={{
            position: 'fixed',
            top: '0',
            left: '0',
            width: '100%',
            height: '100%',
            background: 'rgba(0, 0, 0, 0.8)',
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            backdropFilter: 'blur(4px)'
          }}
          onClick={() => setShowMobileSidebar(false)}
        >
          <div
            style={{
              width: '95%',
              maxWidth: '400px',
              height: '80%',
              background: 'rgba(22, 34, 28, 0.95)',
              border: '2px solid #4fc38a',
              borderRadius: '1rem',
              position: 'relative',
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '1rem',
              borderBottom: '1px solid #4fc38a',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <h3 style={{
                margin: '0',
                color: '#4fc38a',
                fontSize: '1.1rem'
              }}>
                Study Tools
              </h3>
              <button
                onClick={() => setShowMobileSidebar(false)}
                style={{
                  background: 'none',
                  border: 'none',
                  color: '#e4c97e',
                  fontSize: '1.5rem',
                  cursor: 'pointer',
                  padding: '0.25rem',
                  borderRadius: '0.25rem',
                  width: '2rem',
                  height: '2rem',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                √ó
              </button>
            </div>
            
            {/* Modal Content */}
            <div style={{
              flex: 1,
              overflow: 'auto',
              padding: '0.5rem'
            }}>
              <SidePanel
                athroId={athro.id}
                subject={athro.subject}
                sessionId={currentSessionId}
                onSelectResource={handleSelectResource}
                onInjectText={(text) => {
                  setInputValue(text);
                  setShowMobileSidebar(false);
                }}
                onSendMessage={(message) => {
                  const userMessage: ChatMessage = { role: 'user', content: message };
                  setMessages(prev => [...prev, userMessage]);
                  setInputValue('');
                  setShowMobileSidebar(false);
                  handleSubmit(new Event('submit') as any);
                }}
                onUploadResource={handleUploadResource}
                onSaveSession={handleSaveSession}
                onDeleteSession={handleDeleteSession}
                onViewHistory={handleViewHistory}
                triggerToolOpen={triggerToolOpen}
              />
            </div>
          </div>
        </div>
      )}

      {/* Input area at the bottom - Fixed height */}
      <form
        onSubmit={handleSubmit}
        style={{
          display: 'flex',
          gap: needsSidebarButton ? '0.5rem' : '0.5rem',
          padding: needsSidebarButton ? '0.75rem' : '1rem', /* Mobile/Tablet: less padding */
          borderTop: '1px solid #4fc38a',
          background: 'rgba(22, 34, 28, 0.8)',
          boxSizing: 'border-box',
          minHeight: needsSidebarButton ? '70px' : '80px', /* Mobile/Tablet: smaller minimum height */
          marginRight: needsSidebarButton ? '0' : '320px', /* Responsive margin */
          flexShrink: 0, /* Prevent shrinking */
          alignItems: 'flex-end' /* Align button to bottom when textarea expands */
        }}
      >
        <textarea
          value={inputValue}
          onChange={(e) => {
            setInputValue(e.target.value);
            // Auto-resize up to 4 lines
            const textarea = e.target;
            textarea.style.height = 'auto';
            const maxHeight = 4 * 1.4 * 16 + 24; // 4 lines * lineHeight * fontSize + padding
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = newHeight + 'px';
          }}
          placeholder={`Ask ${athro.name} anything...`}
          onKeyDown={(e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              handleSubmit(e);
            }
          }}
          style={{
            flex: 1,
            padding: needsSidebarButton ? '0.6rem' : '0.75rem', /* Mobile/Tablet: smaller padding */
            background: 'rgba(22, 34, 28, 0.7)',
            border: '1px solid #4fc38a',
            borderRadius: '0.5rem',
            color: '#e4c97e',
            fontSize: needsSidebarButton ? '0.9rem' : '1rem', /* Mobile/Tablet: smaller font */
            resize: 'none',
            minHeight: needsSidebarButton ? '42px' : '48px', /* Mobile/Tablet: smaller minimum height */
            maxHeight: needsSidebarButton ? '100px' : '113.6px', /* Mobile/Tablet: smaller maximum height */
            overflowY: 'auto',
            lineHeight: '1.4'
          }}
        />
        
        <button
          type={isStreaming[athro.id] || isTyping[athro.id] ? "button" : "submit"}
          onClick={isStreaming[athro.id] || isTyping[athro.id] ? handleStop : undefined}
          style={{
            padding: needsSidebarButton ? '0.6rem 1rem' : '0.75rem 1.5rem', /* Mobile/Tablet: smaller padding */
            background: isStreaming[athro.id] || isTyping[athro.id] ? '#e74c3c' : '#4fc38a',
            border: 'none',
            borderRadius: '0.5rem',
            color: '#17221c',
            fontWeight: 'bold',
            cursor: 'pointer',
            minHeight: needsSidebarButton ? '42px' : '48px', /* Mobile/Tablet: smaller minimum height */
            alignSelf: 'flex-end', /* Stay at bottom when textarea expands */
            transition: 'background-color 0.2s ease',
            fontSize: needsSidebarButton ? '0.9rem' : '1rem' /* Mobile/Tablet: smaller text */
          }}
        >
          {isStreaming[athro.id] || isTyping[athro.id] ? (
            <>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style={{ marginRight: '0.5rem', display: 'inline-block' }}>
                <rect x="6" y="4" width="4" height="16" fill="currentColor" />
                <rect x="14" y="4" width="4" height="16" fill="currentColor" />
              </svg>
              Stop
            </>
          ) : (
            'Send'
          )}
        </button>
      </form>



      {/* Study History Modal */}
      <StudyHistoryModal 
        isOpen={isHistoryOpen}
        onClose={() => setIsHistoryOpen(false)}
        athroId={athro.id}
        onLoadStudy={handleLoadStudy}
      />

      {/* Flashcard Save Modal */}
      {showFlashcardSave && flashcardToSave && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.8)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            background: '#1a1a1a',
            border: '2px solid #e4c97e',
            borderRadius: '1rem',
            padding: '2rem',
            maxWidth: '500px',
            width: '90%',
            maxHeight: '80vh',
            overflowY: 'auto'
          }}>
            <h2 style={{ color: '#e4c97e', margin: '0 0 1.5rem 0', textAlign: 'center' }}>
              üíæ Save Flashcard
            </h2>
            
            <p style={{ color: '#ccc', marginBottom: '1.5rem', textAlign: 'center' }}>
              Would you like to save this flashcard to your study tools? You can edit the content below:
            </p>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
              <div>
                <label style={{ display: 'block', color: '#e4c97e', marginBottom: '0.5rem' }}>
                  Topic:
                </label>
                <input
                  type="text"
                  value={flashcardSaveTitle}
                  onChange={(e) => setFlashcardSaveTitle(e.target.value)}
                  placeholder="Enter topic (e.g., Drama Terminology)"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    background: 'rgba(0, 0, 0, 0.3)',
                    border: '1px solid rgba(228, 201, 126, 0.5)',
                    borderRadius: '0.5rem',
                    color: 'white'
                  }}
                />
              </div>

              <div>
                <label style={{ display: 'block', color: '#e4c97e', marginBottom: '0.5rem' }}>
                  Front (Question):
                </label>
                <textarea
                  value={flashcardSaveFront}
                  onChange={(e) => setFlashcardSaveFront(e.target.value)}
                  placeholder="Enter the question or term"
                  rows={3}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    background: 'rgba(0, 0, 0, 0.3)',
                    border: '1px solid rgba(228, 201, 126, 0.5)',
                    borderRadius: '0.5rem',
                    color: 'white',
                    resize: 'vertical'
                  }}
                />
              </div>

              <div>
                <label style={{ display: 'block', color: '#e4c97e', marginBottom: '0.5rem' }}>
                  Back (Answer):
                </label>
                <textarea
                  value={flashcardSaveBack}
                  onChange={(e) => setFlashcardSaveBack(e.target.value)}
                  placeholder="Enter the answer or explanation"
                  rows={4}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    background: 'rgba(0, 0, 0, 0.3)',
                    border: '1px solid rgba(228, 201, 126, 0.5)',
                    borderRadius: '0.5rem',
                    color: 'white',
                    resize: 'vertical'
                  }}
                />
              </div>

              <div style={{ 
                display: 'flex', 
                gap: '1rem', 
                marginTop: '1.5rem',
                justifyContent: 'flex-end'
              }}>
                <button
                  onClick={() => {
                    setShowFlashcardSave(false);
                    setFlashcardToSave(null);
                    setFlashcardSaveTitle('');
                    setFlashcardSaveFront('');
                    setFlashcardSaveBack('');
                  }}
                  style={{
                    padding: '0.75rem 1.5rem',
                    background: 'transparent',
                    border: '1px solid #4fc38a',
                    borderRadius: '0.5rem',
                    color: '#4fc38a',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  Cancel
                </button>
                
                <button
                  onClick={handleFlashcardSave}
                  disabled={!flashcardSaveFront.trim() || !flashcardSaveBack.trim()}
                  style={{
                    padding: '0.75rem 1.5rem',
                    background: flashcardSaveFront.trim() && flashcardSaveBack.trim() ? '#4fc38a' : '#666',
                    border: 'none',
                    borderRadius: '0.5rem',
                    color: '#17221c',
                    fontWeight: 'bold',
                    cursor: flashcardSaveFront.trim() && flashcardSaveBack.trim() ? 'pointer' : 'not-allowed',
                    transition: 'all 0.2s ease'
                  }}
                >
                  Save Flashcard
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Notification System */}
      <NotificationSystem 
        notifications={notifications}
        onRemove={removeNotification}
      />
    </div>
  );
};

export default ChatInterface;